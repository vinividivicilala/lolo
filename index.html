<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>üìù Noted</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: 'Inter', sans-serif;
      background: #f9fafb;
      padding: 50px 20px;
      color: #111827;
	  background-image: 
    linear-gradient(to right, #eee 1px, transparent 1px),
    linear-gradient(to bottom, #eee 1px, transparent 1px);
  background-size: 30px 30px;
  background-color: #fafafa;

    }
    h1 {
      text-align: center;
      margin-bottom: 30px;
      font-size: 28px;
      font-weight: 600;
      color: #111827;
	  margin-top: 30px;
	  
    }
	
        input[type="text"] {
            flex: 1;
            padding: 14px 18px;
            border: 1px solid #d1d5db;
            border-radius: 12px;
            font-size: 16px;
            background: #fff;
            transition: border 0.3s ease;
        }
        input[type="text"]:focus {
            border-color: #3b82f6;
            outline: none;
        }
        button {
            background-color: #3b82f6;
            padding: 14px 20px;
            border-radius: 12px;
            color: white;
            font-weight: 600;
            font-size: 15px;
            border: none;
            cursor: pointer;
            transition: background 0.3s ease, transform 0.2s;
        }
        button:hover {
            background-color: #2563eb;
            transform: scale(1.03);
        }
        .note-card {
            background: white;
            max-width: 640px;
            margin: 0 auto 20px;
            border-radius: 14px;
            padding: 20px 24px 20px 60px;
            display: flex;
            align-items: center;
            position: relative;
            box-shadow: 0 6px 16px rgba(0,0,0,0.04);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .note-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 24px rgba(0,0,0,0.06);
        }
        .note-card::before {
            content: '';
            position: absolute;
            left: 30px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #e5e7eb;
        }
        .timeline-dot {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            border: 3px solid #9ca3af;
            background: #f3f4f6;
            position: absolute;
            left: 23px;
            top: 22px;
            z-index: 1;
            transition: all 0.3s ease;
        }
        .timeline-dot.active {
            background: #3b82f6;
            border-color: #3b82f6;
            animation: blink 1.2s infinite;
        }
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .note-text {
            flex: 1;
            font-size: 16px;
            line-height: 1.6;
            color: #1f2937;
            word-break: break-word;
            white-space: pre-wrap;
        }
        .arrow {
            margin-left: 12px;
            opacity: 0.5;
        }
        .arrow svg {
            width: 20px;
            height: 20px;
        }
        .popup {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #10b981;
            color: white;
            padding: 14px 20px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            font-weight: 500;
            opacity: 0;
            pointer-events: none;
            transition: all 0.4s ease;
            z-index: 1000;
        }
        .popup.show {
            opacity: 1;
            pointer-events: auto;
        }
        .topic-filter {
            display: flex;
            max-width: 640px;
            margin: 0 auto 20px;
            gap: 10px;
            overflow-x: auto; /* Jika topik terlalu banyak */
        }
        .topic-button {
            background-color: #e5e7eb;
            color: #374151;
            padding: 8px 16px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .topic-button.active {
            background-color: #3b82f6;
            color: white;
        }
        .topic-button:hover {
            background-color: #d1d5db;
        }
        .note-group {
            margin-bottom: 30px;
        }
        .note-group h2 {
            font-size: 20px;
            font-weight: 600;
            color: #111827;
            margin-bottom: 10px;
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 5px;
        }
        .empty-topic {
            text-align: center;
            color: #6b7280;
            font-style: italic;
            margin-top: 20px;
        }
        .guide-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
            z-index: 1001;
            max-width: 500px;
            text-align: center;
        }
        .guide-popup h3 {
            margin-top: 0;
            color: #3b82f6;
            margin-bottom: 10px;
        }
        .guide-popup p {
            line-height: 1.6;
            color: #4b5563;
            margin-bottom: 15px;
        }
        .guide-popup a {
            color: #2563eb;
            text-decoration: none;
            font-weight: 500;
        }
        .guide-popup button {
            background-color: #6b7280;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s ease;
        }
        .guide-popup button:hover {
            background-color: #4b5563;
        }
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: none;
        }
        .guide-popup, .overlay {
            display: none; /* Initially hidden */
        }
        .guide-popup.show, .overlay.show {
            display: block;
        }
		
		
	.modal-content {
    background: white;
    padding: 30px; /* Tambah atau sesuaikan padding */
    border-radius: 16px; /* Sesuaikan radius sudut */
    max-width: 700px; /* Perbesar lebar maksimum */
    width: 90%; /* Atau gunakan persentase untuk responsif */
    text-align: left;
    position: relative;
    box-shadow: 0 15px 40px rgba(0,0,0,0.3); /* Efek bayangan lebih kuat untuk menonjol */
    transform: scale(1.05); /* Sedikit diperbesar saat muncul */
    transition: transform 0.3s ease-in-out; /* Animasi halus saat muncul */
}

/* Tambahkan style untuk overlay jika belum ada */
.modal-overlay {
    display: flex; /* Menggunakan flex agar konten di tengah */
    justify-content: center; /* Tengah horizontal */
    align-items: center; /* Tengah vertikal */
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(0, 0, 0, 0.6); /* Latar belakang lebih gelap jika diinginkan */
    z-index: 1002;
}	
		
		
.close-btn {
  position: absolute;
  top: 10px; right: 15px;
  background: none;
  border: none;
  font-size: 20px;
  cursor: pointer;
}

    .info-card-container {
      display: flex;
      gap: 1.5rem;
      flex-wrap: wrap;
      justify-content: center;
    }

    .info-card {
      width: 400px;
      height: 100px;
      padding: 1rem;
      border-radius: 28px;
      color: white;
      position: relative;
      cursor: pointer;
      box-shadow: 0 4px 14px rgba(0,0,0,0.1);
      transition: transform 0.2s;
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .info-card:hover {
      transform: translateY(-6px);
    }

    .info-arrow-icon {
      position: absolute;
      top: 12px;
      right: 12px;
      width: 80px;
      height: 80px;
      fill: black;
    }

    .info-icon {
	   font-size: 39px;
    }

    .info-ketentuan { background-color: #007BFF; }
    .info-tentang { background-color: #28a745; }
    .info-privasi { background-color: #dc3545; }

    .info-popup {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.65);
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .info-popup-content {
      background: #fff;
      border-radius: 12px;
      max-width: 650px;
      width: 90%;
      padding: 2rem;
      position: relative;
      max-height: 85vh;
      overflow-y: auto;
      animation: fadeIn 0.3s ease;
      scroll-behavior: smooth;
      font-size: 29px;
    }

    .info-popup-content h2 {
      margin-top: 0;
      display: flex;
      align-items: center;
      gap: 0.5rem;
	      color: black;
	     text-align: left;
    }

    .info-content-block {
      padding: 1rem;
      border-radius: 10px;
      margin-bottom: 1rem;
    }

    .info-blue-block { background: #e3f2fd; }
    .info-yellow-block { background: #fff3cd; }
    .info-red-block { background: #f8d7da; }
    .info-green-block { background: #e6f4ea; }
    .info-pink-block { background: #fdecef; }

    .info-content-block p {
      margin: 0.5rem 0;
	      color: black;
	     text-align: left;
    }

    .info-content-block img {
      max-width: 100%;
      border-radius: 8px;
      margin: 1rem 0;
    }
	  .info-close-btn {
      position: absolute;
      top: 12px;
      right: 16px;
      font-size: 22px;
      cursor: pointer;
      color: #999;
    }

    .info-close-btn:hover {
      color: #000;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    a {
      color: #007bff;
      text-decoration: none;
    }

    a:hover {
      text-decoration: underline;
    }

    ::-webkit-scrollbar {
      width: 8px;
    }
	  ::-webkit-scrollbar-thumb {
      background: #bbb;
      border-radius: 4px;
    }

.user-card {
  padding: 15px;
  margin-bottom: 15px;
  border-radius: 10px;
  box-shadow: 0 0 4px rgba(0,0,0,0.1);
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-family: sans-serif;
  font-size: 16px;
  font-weight: bold;
}

.admin-border {
  border-left: 6px solid #e74c3c;
}

.kontributor-border {
  border-left: 6px solid #f39c12;
}

.member-border {
  border-left: 6px solid #3498db;
}

/* Badge */
.badge {
  padding: 5px 12px;
  border-radius: 999px;
  font-size: 12px;
  font-weight: bold;
  color: #fff;
  cursor: pointer;
}

.admin { background-color: #e74c3c; }
.kontributor { background-color: #f39c12; }
.member { background-color: #3498db; }

/* Role Popup */
.role-popup-overlay {
  display: none;
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.5);
  justify-content: center;
  align-items: center;
  z-index: 1000;
}

.role-popup-overlay.show {
  display: flex;
}

.role-popup-box {
  background: #fff;
  padding: 20px 30px;
  border-radius: 12px;
  max-width: 400px;
  text-align: center;
  box-shadow: 0 0 25px rgba(0,0,0,0.2);
}

.role-popup-box .close-btn {
  margin-top: 15px;
  padding: 6px 14px;
  border: none;
  background-color: #eee;
  cursor: pointer;
  border-radius: 6px;
  font-weight: bold;
}


    .activity-table {
        border-collapse: collapse;
        font-family: sans-serif;
        font-size: 11px;
    }

    .activity-table th, .activity-table td {
        border: 1px solid #eee;
        padding: 2px;
        text-align: center;
    }

    .activity-legend {
        margin-top: 5px;
        font-size: 10px;
        color: #586069;
    }

    .activity-legend span {
        display: inline-block;
        width: 10px;
        height: 10px;
        border: 1px solid #eee;
        margin: 0 5px;
    }
	
	.activity-new {
    background-color: #ccf2ff; /* Biru muda */
}

.activity-completed {
    background-color: #aaff80; /* Hijau muda */
}

.activity-revision {
    background-color: #ffdd99; /* Kuning muda */
}

.note-actions {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-top: 5px;
}

.save-individual-note {
    padding: 5px 10px;
    border: 1px solid #ccc;
    border-radius: 5px;
    background-color: red;
    cursor: pointer;
    font-size: 0.8em;
}

.save-individual-note:hover {
    background-color: green;
}



#saveBtn {
    padding: 10px 15px;
    border: none;
    background-color: #007bff;
    color: white;
    border-radius: 5px;
    cursor: pointer;
    font-size: 1em;
}

#saveBtn:hover {
    background-color: #0056b3;
}


.voice-icon-btn {
    /* Gaya dasar tombol */
    padding: 8px;
    border: none;
    background-color: transparent;
    cursor: pointer;
}

.voice-icon-btn svg {
    display: block; /* Membuat SVG berperilaku seperti blok */
    width: 24px;
    height: 24px;
    fill: currentColor; /* Menggunakan warna teks tombol */
}

/* Anda bisa mengatur warna teks tombol jika perlu */
.voice-icon-btn {
    color: #333; /* Contoh warna teks */
}


.pin-button {
    background-color: transparent;
    border: 1px solid #ccc;
    border-radius: 5px;
    padding: 5px 10px;
    cursor: pointer;
    font-size: 0.8em;
}

.pin-button:hover {
    background-color: #eee;
}




  .cookie-notification {
    position: fixed;
    bottom: 20px; /* Ubah dari 'bottom: 0' menjadi 'bottom: 20px' (atau nilai lain sesuai keinginan) */
    left: 0;
    background-color: #222;
    color: #fff;
    padding: 10px;
    text-align: center;
    z-index: 1000;
    display: inline-block; /* Atau fit-content */
    border-radius: 5px; /* Opsional */
    line-height: 1.5; /* Opsional */
  }
  
  .cookie-list-number {
    color: #fff; /* Warna teks nomor menjadi putih agar kontras dengan latar belakang */
    padding: 2px 6px;
    border-radius: 4px; /* Membuat sudut sedikit melengkung */
    margin-right: 5px; /* Memberikan sedikit jarak antara nomor dan teks */
    font-weight: bold; /* Membuat nomor lebih tebal */
}

        .filter-container {
            margin-bottom: 20px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }

        label {
            margin-right: 10px;
        }

        select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 3px;
        }


#notificationPopup {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    display: none;
    z-index: 1000;
    overflow-y: auto;
}

#notificationPopup > div {
    background-color: white;
    width: 90%;
    max-width: 500px;
    border-radius: 8px;
    margin: 50px auto;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    position: relative;
    top: 50%;
    transform: translateY(-50%);
}

#notificationPopup .header {
    padding: 10px;
    border-bottom: 1px solid #eee;
    font-weight: bold;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

#notificationPopup .header span {
    font-size: 1.2em;
}

#notificationPopup #closeNotificationPopup {
    border: none;
    background: none;
    font-size: 1.5em;
    cursor: pointer;
    color: #888;
}

#notificationPopup #closeNotificationPopup:hover {
    color: #333;
}

#notificationListItems li {
    padding: 15px;
    border-bottom: 1px solid #eee;
    cursor: pointer;
    font-size: 0.9em;
}

#notificationListItems li:last-child {
    border-bottom: none;
}

#notificationListItems li:hover {
    background-color: #f9f9f9;
}

.notification-item {
    padding: 15px;
    border-bottom: 1px solid #eee;
    cursor: pointer;
    font-size: 0.9em;
    display: flex;
    align-items: center;
    flex-direction: column; /* Stack title and content vertically */
    align-items: flex-start; /* Align items to the start (left) */
}

.notification-item:last-child {
    border-bottom: none;
}

.notification-item:hover {
    background-color: #f9f9f9;
}

.notification-category {
    margin-right: 5px;
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 0.8em;
    font-weight: bold;
}

.notification-title {
    font-size: 1em;
    font-weight: bold;
    margin-bottom: 5px; /* Add some space between title and content */
    color: #333; /* Make title color darker */
    display: block; /* Ensure it takes full width */
    text-align: left; /* Align title to the left */
}

.notification-content {
    font-size: 0.9em;
    color: #555; /* Lighter color for content */
    display: block;
    text-align: left; /* Align content to the left */
}


#markAllRead {
    background-color: #f0f0f0;
    border: none;
    padding: 8px 15px;
    border-radius: 5px;
    cursor: pointer;
    font-size: 0.9em;
}

#markAllRead:hover {
    background-color: #e0e0e0;
}

#notificationFullContent {
    display: none;
    padding: 15px;
    border-top: 1px solid #eee;
}
      .blog-title {
        font-size: 35px;
        font-weight: bold;
        color: #1f2937;
        margin-bottom: 6px;
        margin-top: 0;
        line-height: 1.4;
        cursor: pointer;
        font-family: 'Poppins', sans-serif;
      }

      .blog-category-title {
        font-size: 24px;
        font-weight: bold;
        color: #111827;
        margin-bottom: 10px;
        text-align: left;
        margin-top: 40px;
      }

      .blog-category {
        font-size: 12px;
        color: #6b7280;
        margin-bottom: 0;
        text-transform: uppercase;
        font-weight: 700;
        margin-left: 0;
      }

      .blog-arrow {
        opacity: 0.7;
      }

      .blog-arrow svg {
        width: 20px;
        height: 20px;
      }

	  .blog-content-main-title {
  font-size: 39px; /* Ukuran font lebih besar */
  font-weight: bold; /* Teks tebal (hitam) */
  color: black; /* Warna teks hitam atau abu-abu gelap */
  margin-bottom: 0.5em; /* Jarak bawah dari judul */
}

.blog-content-meta {
  font-size: 15px; /* Ukuran font untuk meta informasi */
  color: black; /* Warna teks abu-abu */
  margin-bottom: 1em; /* Jarak bawah dari meta informasi */
}

.blog-content-meta span {
  margin-right: 1em; /* Jarak antar tanggal dan sumber */
}

.blog-content-text {
  color: black; /* Warna teks isi konten */
  line-height: 1.6; /* Jarak antar baris untuk keterbacaan */
}

      #closeBlogContent {
        background-color: transparent;
        color: black;
        padding: 10px 15px;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        font-size: 29px;
        margin-top: 15px;
      }

      #closeBlogContent:hover {
        background-color: transparent;
      }

      .category-container {
        display: flex;
        flex-direction: row;
        align-items: baseline;
        width: 100%;
        justify-content: space-between;
        margin-bottom: 0;
      }

      .category-divider {
        border-top: 1px solid #e5e7eb;
        margin-top: 20px;
        padding-top: 20px;
      }

      .article-list {
        margin-bottom: 20px;
      }

      .article-item {
        margin-bottom: 20px;
        padding-bottom: 0;
        border-bottom: none;
      }

      .article-item:last-child {
        border-bottom: none;
        margin-bottom: 0;
        padding-bottom: 0;
      }
      .blog-date{
        color: #6b7280;
        font-size: 14px;
      }
      .blog-source{
        color: #6b7280;
        font-size: 12px;
      }

      /* Pagination Styles */
      .pagination {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 20px;
        padding: 0 10px;
      }

      .pagination-list {
        display: flex;
        list-style: none;
        padding: 0;
        margin: 0;
      }

      .pagination-item {
        margin: 0 5px;
      }

      .pagination-link {
        display: block;
        padding: 8px 12px;
        text-decoration: none;
        color: #1f2937;
        border-radius: 4px;
        transition:  0.3s ease;
      }

      .pagination-link:hover {
        background-color: #f3f4f6;
      }

      .pagination-item.active .pagination-link {
        color: #6b7280;
        font-weight: bold;
        text-decoration: underline;
      }

      .pagination-next {
        margin-left: auto;
      }

      .pagination-next-link {
        display: block;
        padding: 8px 12px;
        text-decoration: none;
        color: #1f2937;
        border-radius: 4px;
        transition:  0.3s ease;
        font-weight: bold;
        text-decoration: underline;
      }

      .pagination-next-link:hover {
        background-color: #transparent;
      }





#quoraPopup {
    /* Style dasar popup sudah ada di HTML */
    width: 80%; /* Lebar popup */
    max-width: 500px;
    border-radius: 8px;
}

#quoraPopup h2 {
    color: #333;
    margin-top: 0;
    margin-bottom: 15px;
    border-bottom: 2px solid #eee;
    padding-bottom: 8px;
}

#quoraPopup ul {
    list-style-type: none; /* Hilangkan bullet points */
    padding: 0;
    margin-bottom: 15px;
}

#quoraPopup ul li {
    padding: 8px 0;
    border-bottom: 1px dashed #ddd;
}

#quoraPopup ul li:last-child {
    border-bottom: none;
}

#quoraPopup button#closeQuoraPopup {
    background-color: #f44336; /* Warna merah untuk tombol tutup */
    color: white;
    padding: 10px 15px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 1em;
    transition: background-color 0.3s ease;
}

#quoraPopup button#closeQuoraPopup:hover {
    background-color: #d32f2f; /* Warna merah lebih gelap saat hover */
}

#quoraPopup ul li h3 a:hover {
    text-decoration: underline; /* Tambahkan garis bawah saat hover pada judul tautan */
}

/* Gaya untuk Placeholder Video */
#youtube-placeholder {
    display: flex;
    justify-content: center;
    align-items: center;
    background-color: #333;
    color: #fff;
    cursor: pointer;
    border-radius: 5px;
    margin-top: 10px;
}

#youtube-placeholder svg {
    width: 60px;
    height: 40px;
    fill: white;
    filter: drop-shadow(0 0 6px rgba(0,0,0,0.6));
}

#youtube-placeholder:hover {
    opacity: 0.9;
}

   
            #app {
            display: flex;
            flex-direction: column;
            width: 100%;
            max-width: 800px;
            background: #7FFF00;
            border-radius: 10px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: max-width 0.5s ease;
        }

        #loginForm {
            padding: 2rem;
            background-color: rgba(255, 255, 255, 0.8);
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: opacity 0.5s ease, transform 0.5s ease;
            opacity: 1;
            transform: translateX(0);
            width: 100%;
            box-sizing: border-box;
        }

        #loginForm h2 {
            margin-bottom: 1.5rem;
            color: #1a202c;
            font-weight: 600;
            font-size: 1.875rem;
        }

        .input-group {
            margin-bottom: 1rem;
            width: 100%;
        }

        .input-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #4a5568;
            font-size: 0.875rem;
            font-weight: 600;
        }

        .input-group input {
            width: calc(100% - 2rem);
            padding: 0.75rem 1rem;
            border: 1px solid #e2e8f0;
            border-radius: 0.375rem;
            font-size: 1rem;
            transition: border-color 0.2s ease;
            box-sizing: border-box;
        }

        .input-group input:focus {
            outline: none;
            border-color: #4299e1;
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.15);
        }

        #errorMessage {
            margin-top: 1rem;
            color: #e53e3e;
            font-size: 0.875rem;
            padding: 0.5rem;
            background-color: #fed7d7;
            border-radius: 0.375rem;
            border: 1px solid #fecaca;
            display: none;
        }

        #loginForm button {
            padding: 0.75rem 1.5rem;
            background-color: #4299e1;
            color: white;
            border: none;
            border-radius: 0.375rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.2s ease;
            width: 100%;
            margin-top: 0.5rem;
        }

        #loginForm button:hover {
            background-color: #3182ce;
            transform: translateY(-2px);
        }

#greetingDiv {
    padding: 2rem;
    background-color: rgba(255, 255, 255, 0.8);
    border-radius: 10px;
    text-align: center;
    transition: all 0.5s ease;
    width: 100%;
    box-sizing: border-box;
    opacity: 0; /* Tetap 0 secara default */
    transform: translateX(100%); /* Tetap di luar layar default */
}


        #greetingDiv h2 {
            margin-bottom: 1rem;
            color: #1a202c;
            font-size: 1.875rem;
            font-weight: 600;
        }

        #greetingDiv p {
            color: #4a5568;
            font-size: 1rem;
            margin-bottom: 1.5rem;
        }

        #greetingDiv button {
            padding: 0.75rem 1.5rem;
            background-color: #e53e3e;
            color: white;
            border: none;
            border-radius: 0.375rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.2s ease;
            margin-top: 0.5rem;
        }

        #greetingDiv button:hover {
            background-color: #c53030;
            transform: translateY(-2px);
        }

        .dashboard-container {
    padding: 2rem;
    background-color: rgba(255, 255, 255, 0.8);
    border-radius: 10px;
    text-align: left;
    transition: all 0.5s ease;
    width: 100%;
    box-sizing: border-box;
    opacity: 0; /* Tetap 0 secara default */
    transform: translateY(20px); /* Tetap di bawah default */
}
        .dashboard-container h2 {
            margin-bottom: 1.5rem;
            color: black;
            font-size: 1.875rem;
            font-weight: 600;
        }

        .dashboard-greeting {
            font-size: 1.25rem;
            color: black;
            margin-bottom: 1rem;
            font-weight: 500;
        }

        .help-section {
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 1px solid #e2e8f0;
        }

        .help-section h3 {
            font-size: 1.125rem;
            color: black;
            margin-bottom: 1rem;
            font-weight: 600;
        }

        .help-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .help-list li {
            display: flex;
            align-items: center;
            margin-bottom: 0.75rem;
            color: black;
        }

        .help-list li svg {
            margin-right: 0.75rem;
            width: 1.25rem;
            height: 1.25rem;
            color: #4299e1;
        }
		
		@media (min-width: 768px) {
    #app {
        max-width: 800px;
        flex-direction: row;
    }

    #loginForm,
    #greetingDiv,
    .dashboard-container {
        width: 50%;
        margin: 0;
    }

    #loginForm {
        border-radius: 10px 0 0 10px;
    }

    #greetingDiv,
    .dashboard-container {
        border-radius: 0 10px 10px 0;
    }
}

      

.slide-in {
    animation: slideIn 0.5s ease forwards;
}



.slide-out {
    animation: slideOut 0.5s ease forwards;
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateX(100%); /* Untuk greetingDiv */
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

/* Tambahkan keyframes khusus untuk slide-in dashboard dari bawah */
@keyframes slideInDashboard {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.dashboard-container.slide-in { /* Terapkan animasi slideInDashboard ke dashboard */
    animation: slideInDashboard 0.5s ease forwards;
}

.slide-out {
    animation: slideOut 0.5s ease forwards;
}

@keyframes slideOut {
    from {
        opacity: 1;
        transform: translateX(0); /* Untuk greetingDiv */
    }
    to {
        opacity: 0;
        transform: translateX(-100%);
    }
}

.dashboard-container.slide-out { /* Atur animasi slideOut untuk dashboard */
    from {
        opacity: 1;
        transform: translateY(0);
    }
    to {
        opacity: 0;
        transform: translateY(20px);
    }
}

.hidden {
    visibility: hidden;
    opacity: 0;
    position: absolute;
    left: -9999px;
}


    /* Note Favorit */
    #notesArea input[type="text"] {
      width: calc(100% - 90px);
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
      margin-right: 10px;
    }
    #notesArea button {
      padding: 10px 15px;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    .note-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      border-bottom: 1px solid #eee;
    }
    .favorite-icon {
      cursor: pointer;
      font-size: 20px;
    }

    /* Kotak Pesan */
    #messageBox {
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid #ccc;
      padding: 10px;
      border-radius: 6px;
      margin-top: 10px;
      background: #fafafa;
    }
    #messageInput {
      width: calc(100% - 70px);
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
      margin-right: 10px;
    }
    #sendMessageBtn {
      padding: 10px 15px;
      background: #2196F3;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }

    /* Pengaturan */
    .setting-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    /* Dark Mode */
    body.dark-mode {
      background: #1e1e1e;
      color: #f1f1f1;
    }
    body.dark-mode .section {
      background: #2d2d2d;
      color: #f1f1f1;
    }
    body.dark-mode .note-item,
    body.dark-mode #messageBox {
      background: #3a3a3a;
    }
	.section {
      background: white;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 0 8px rgba(0,0,0,0.1);
    }
	
	 ul {
      list-style-type: none;
      padding-left: 0;
    }

    li {
      padding: 10px 0;
      border-bottom: 1px solid #e2e8f0;
    }

    li:last-child {
      border-bottom: none;
    }

    .icon {
      margin-right: 10px;
      font-size: 18px;
      color: #6b7280;
    }
	
	#app {
    display: flex;
    flex-direction: column;
    width: 100%;
    max-width: 800px;
    background: #7FFF00;
    border-radius: 10px;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    transition: max-width 0.5s ease;
    margin: 20px auto; /* Agar app berada di tengah dan ada margin atas bawah */
}

#loginForm {
    padding: 2rem;
    background-color: rgba(255, 255, 255, 0.8);
    border-radius: 10px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    transition: opacity 0.5s ease, transform 0.5s ease;
    opacity: 1;
    transform: translateX(0);
    width: 100%;
    box-sizing: border-box;
}

#loginForm h2 {
    margin-bottom: 1.5rem;
    color: #1a202c;
    font-weight: 600;
    font-size: 1.875rem;
}

.input-group {
    margin-bottom: 1rem;
    width: 100%;
}

.input-group label {
    display: block;
    margin-bottom: 0.5rem;
    color: #4a5568;
    font-size: 0.875rem;
    font-weight: 600;
}

.input-group input {
    width: calc(100% - 2rem);
    padding: 0.75rem 1rem;
    border: 1px solid #e2e8f0;
    border-radius: 0.375rem;
    font-size: 1rem;
    transition: border-color 0.2s ease;
    box-sizing: border-box;
}

.input-group input:focus {
    outline: none;
    border-color: #4299e1;
    box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.15);
}

#errorMessage {
    margin-top: 1rem;
    color: #e53e3e;
    font-size: 0.875rem;
    padding: 0.5rem;
    background-color: #fed7d7;
    border-radius: 0.375rem;
    border: 1px solid #fecaca;
    display: none;
}

#loginForm button {
    padding: 0.75rem 1.5rem;
    background-color: #4299e1;
    color: white;
    border: none;
    border-radius: 0.375rem;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: background-color 0.2s ease, transform 0.2s ease;
    width: 100%;
    margin-top: 0.5rem;
}

#loginForm button:hover {
    background-color: #3182ce;
    transform: translateY(-2px);
}

#greetingDiv {
    padding: 2rem;
    background-color: rgba(255, 255, 255, 0.8);
    border-radius: 10px;
    text-align: center;
    transition: all 0.5s ease;
    width: 100%;
    box-sizing: border-box;
    opacity: 0; /* Tetap 0 secara default */
    transform: translateX(100%); /* Tetap di luar layar default */
}

#greetingDiv h2 {
    margin-bottom: 1rem;
    color: #1a202c;
    font-size: 1.875rem;
    font-weight: 600;
}

#greetingDiv p {
    color: #4a5568;
    font-size: 1rem;
    margin-bottom: 1.5rem;
}

#greetingDiv button {
    padding: 0.75rem 1.5rem;
    background-color: #e53e3e;
    color: white;
    border: none;
    border-radius: 0.375rem;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: background-color 0.2s ease, transform 0.2s ease;
    margin-top: 0.5rem;
}

#greetingDiv button:hover {
    background-color: #c53030;
    transform: translateY(-2px);
}

.dashboard-container {
    padding: 2rem;
    background-color: rgba(255, 255, 255, 0.8);
    border-radius: 10px;
    text-align: left;
    transition: all 0.5s ease;
    width: 100%;
    box-sizing: border-box;
    opacity: 0; /* Tetap 0 secara default */
    transform: translateY(20px); /* Tetap di bawah default */
}

.dashboard-container h2 {
    margin-bottom: 1.5rem;
    color: black;
    font-size: 1.875rem;
    font-weight: 600;
    cursor: pointer; /* Tambahkan cursor pointer agar terlihat bisa diklik */
}

.dashboard-greeting {
    font-size: 1.25rem;
    color: black;
    margin-bottom: 1rem;
    font-weight: 500;
}

.help-section {
    margin-top: 2rem;
    padding-top: 1.5rem;
    border-top: 1px solid #e2e8f0;
}

.help-section h3 {
    font-size: 1.125rem;
    color: black;
    margin-bottom: 1rem;
    font-weight: 600;
}

.help-list {
    list-style: none;
    padding: 0;
    margin: 0;
}

.help-list li {
    display: flex;
    align-items: center;
    margin-bottom: 0.75rem;
    color: black;
}

.help-list li svg {
    margin-right: 0.75rem;
    width: 1.25rem;
    height: 1.25rem;
    color: #4299e1;
}

@media (min-width: 768px) {
    #app {
        max-width: 800px;
        flex-direction: row;
    }

    #loginForm,
    #greetingDiv,
    .dashboard-container {
        width: 50%;
        margin: 0;
    }

    #loginForm {
        border-radius: 10px 0 0 10px;
    }

    #greetingDiv,
    .dashboard-container {
        border-radius: 0 10px 10px 0;
    }
}

.slide-in {
    animation: slideIn 0.5s ease forwards;
}

.slide-out {
    animation: slideOut 0.5s ease forwards;
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateX(100%); /* Untuk greetingDiv */
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

/* Tambahkan keyframes khusus untuk slide-in dashboard dari bawah */
@keyframes slideInDashboard {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.dashboard-container.slide-in { /* Terapkan animasi slideInDashboard ke dashboard */
    animation: slideInDashboard 0.5s ease forwards;
}

.slide-out {
    animation: slideOut 0.5s ease forwards;
}

@keyframes slideOut {
    from {
        opacity: 1;
        transform: translateX(0); /* Untuk greetingDiv */
    }
    to {
        opacity: 0;
        transform: translateX(-100%);
    }
}

.dashboard-container.slide-out { /* Atur animasi slideOut untuk dashboard */
    from {
        opacity: 1;
        transform: translateY(0);
    }
    to {
        opacity: 0;
        transform: translateY(20px);
    }
}

.hidden {
    visibility: hidden;
    opacity: 0;
    position: absolute;
    left: -9999px;
}

/* Note Favorit */
#noteText {
    width: calc(100% - 90px);
    padding: 10px;
    border: 1px solid #ccc;
    border-radius: 6px;
    margin-right: 10px;
    box-sizing: border-box; /* Pastikan padding dan border termasuk dalam lebar */
    margin-bottom: 10px; /* Tambahkan margin bawah */
}

#dashboardDiv .section > button { /* Gaya tombol Simpan di bagian Catatan Favorit */
    padding: 10px 15px;
    background: #4CAF50;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    margin-bottom: 15px; /* Tambahkan margin bawah */
}

.note-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px;
    border-bottom: 1px solid #eee;
}

.favorite-icon {
    cursor: pointer;
    font-size: 20px;
    color: #e53e3e; /* Warna ikon hapus */
}

.favorite-icon:hover {
    color: #c53030;
}

/* Kotak Pesan */
#messageBox {
    max-height: 200px;
    overflow-y: auto;
    border: 1px solid #ccc;
    padding: 10px;
    border-radius: 6px;
    margin-top: 10px;
    background: #fafafa;
}

#messageInput {
    width: calc(100% - 70px);
    padding: 10px;
    border: 1px solid #ccc;
    border-radius: 6px;
    margin-right: 10px;
    box-sizing: border-box;
    margin-bottom: 10px;
}

#sendMessageBtn {
    padding: 10px 15px;
    background: #2196F3;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
}

/* Pengaturan */
.setting-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
}

/* Dark Mode */
body.dark-mode {
    background: #1e1e1e;
    color: #f1f1f1;
}

body.dark-mode .section {
    background: #2d2d2d;
    color: #f1f1f1;
    box-shadow: 0 0 8px rgba(255,255,255,0.1);
}

body.dark-mode .note-item,
body.dark-mode #messageBox {
    background: #3a3a3a;
    border-color: #555;
}

body.dark-mode #noteText,
body.dark-mode #messageInput {
    background: #444;
    color: #f1f1f1;
    border-color: #555;
}

body.dark-mode #noteText::placeholder,
body.dark-mode #messageInput::placeholder {
    color: #ccc;
}

.section {
    background: white;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 0 8px rgba(0,0,0,0.1);
}

ul {
    list-style-type: none;
    padding-left: 0;
}

li {
    padding: 10px 0;
    border-bottom: 1px solid #e2e8f0;
}

li:last-child {
    border-bottom: none;
}

.icon {
    margin-right: 10px;
    font-size: 18px;
    color: #6b7280;
}

/* Gaya Pop-up Catatan Favorit */
#topicNotesContainer {
    margin-top: 15px;
    padding: 10px;
    border: 1px solid #ccc;
    border-radius: 6px;
    background-color: #f9f9f9;
}

#topicNotesContainer ul {
    padding-left: 20px;
}

#topicNotesContainer li {
    padding: 5px 0;
    border-bottom: 1px dotted #eee;
}

#topicNotesContainer li:last-child {
    border-bottom: none;
}

/* Gaya Tombol di Pop-up */
#app > div > div[style*="position: fixed"] button {
    padding: 8px 12px;
    background-color: #007bff;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    margin-right: 5px;
    transition: background-color 0.2s ease;
}

#app > div > div[style*="position: fixed"] button:hover {
    background-color: #0056b3;
}

#app > div > div[style*="position: fixed"] h3 {
    margin-bottom: 15px;
    color: #333;
}


.saved-notes-modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.5); /* Semi transparan background */
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 1000;
}

.saved-notes-modal-content {
  background-color: white;
  width: 90%;
  max-width: 600px;
  max-height: 90vh; /* Hindari overflow layar */
  overflow: hidden; /* Jangan biarkan seluruh modal scroll */
  border-radius: 8px;
  padding: 20px;
  position: relative;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
  display: flex;
  flex-direction: column;
}

#savedNotesContainer {
  flex: 1;
  overflow-y: auto;
  margin-top: 10px;
  max-height: 60vh; /* Bagian inilah yang scroll, bukan modalnya */
  padding-right: 8px;
}



.modal-close-button {
    color: #aaa;
    float: right;
    font-size: 28px;
    font-weight: bold;
}

.modal-close-button:hover,
.modal-close-button:focus {
    color: black;
    text-decoration: none;
    cursor: pointer;
}


.save-individual-note.saved {
¬† ¬† background-color: #3b82f6;
¬† ¬† color: white;
¬† ¬† font-weight: bold;
}

.saved-note-card {
  background: white;
  max-width: 640px;
  margin: 0 auto 20px;
  border-radius: 14px;
  padding: 20px 24px; /* Kurangi padding kiri karena ::before dihilangkan */
  display: flex;
  align-items: center;
  position: relative;
  box-shadow: 0 6px 16px rgba(0,0,0,0.04);
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.saved-note-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 12px 24px rgba(0,0,0,0.06);
}

.saved-note-card::before {
  content: none; /* Hilangkan garis vertikal */
}

.saved-note-card .note-body {
  display: flex;
  align-items: center; /* Pastikan elemen di dalamnya juga center */
  width: 100%; /* Ambil seluruh lebar yang tersedia */
}

.saved-note-card .note-text {
  flex-grow: 1; /* Biarkan teks mengambil ruang sebanyak mungkin */
  margin-right: 15px; /* Beri jarak dengan elemen aksi */
}

.saved-note-card .note-actions {
  /* Gaya untuk tombol dan ikon aksi */
}

.saved-note-card .badge {
  /* Gaya untuk badge */
  margin-left: 15px; /* Beri jarak dengan elemen aksi atau teks */
}

 
 .info-bar-container {
            background-color: transparent;
            color: black;
            padding: 20px;
            text-align: center;
            width: 100%;
            box-sizing: border-box;
            border-bottom: 1px solid #4a5d73;
            font-size: 1.1em;
            position: absolute;
            top: 0;
            left: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
            gap: 15px;
            overflow: hidden;
            cursor: pointer;
        }

        .info-bar-container:hover {
            background-color: transparent;
        }

        .icon-text-group {
            display: flex;
            align-items: center;
            white-space: nowrap;
			colour: black;
        }

        .info-icon {
            font-size: 1.5em;
            margin-right: 8px;
            display: inline-block;
        }

        .announcement-icon {
            color: #ffc107;
            animation: shake 0.82s cubic-bezier(.36,.07,.19,.97) both infinite;
            transform: translate3d(0, 0, 0);
            backface-visibility: hidden;
            perspective: 1000px;
        }

        .birthday-icon {
            color: #28a745;
            animation: bounce 2s infinite;
        }

        .countdown-icon {
            color: #dc3545;
        }

        .countdown-text {
            font-weight: bold;
            color: black;
        }

        @keyframes shake {
            10%, 90% {
                transform: translate3d(-1px, 0, 0);
            }
            20%, 80% {
                transform: translate3d(2px, 0, 0);
            }
            30%, 50%, 70% {
                transform: translate3d(-4px, 0, 0);
            }
            40%, 60% {
                transform: translate3d(4px, 0, 0);
            }
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {
                transform: translateY(0);
            }
            40% {
                transform: translateY(-10px);
            }
            60% {
                transform: translateY(-5px);
            }
        }

        @media (max-width: 768px) {
            .info-bar-container {
                flex-direction: column;
                gap: 10px;
            }
        }

        .perjalanan-hidup-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }

        .perjalanan-hidup-modal.perjalanan-hidup-modal-show {
            display: flex;
            opacity: 1;
        }

        .perjalanan-hidup-modal-content {
            background-color: #ffffff;
            color: #333;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.3);
            position: relative;
            width: 90%;
            max-width: 800px;
            transform: translateY(-50px);
            transition: transform 0.3s ease-in-out;
            overflow-y: auto; /* Tambahkan scrollbar jika konten melampaui tinggi maksimal */
            max-height: 90vh; /* Tinggi maksimal modal content */
        }

        .perjalanan-hidup-modal.perjalanan-hidup-modal-show .perjalanan-hidup-modal-content {
            transform: translateY(0);
        }

        .perjalanan-hidup-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #ddd;
        }

        .perjalanan-hidup-modal-header h2 {
            margin: 0;
            font-size: 1.5em;
            font-weight: bold;
        }

        .perjalanan-hidup-close-button {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 2em;
            color: #aaa;
            cursor: pointer;
            border: none;
            background: none;
            padding: 0;
            line-height: 1;
            opacity: 0.7;
            transition: opacity 0.2s ease;
        }

        .perjalanan-hidup-close-button:hover {
            color: #555;
            opacity: 1;
        }

        .perjalanan-hidup-timeline {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .perjalanan-hidup-timeline li {
            margin-bottom: 15px;
            position: relative;
            padding-left: 40px;
        }

        .timeline-icon {
            position: absolute;
            left: 0;
            top: 5px;
            font-size: 1.2em;
            color: #007bff;
        }

        .timeline-date {
            font-size: 0.9em;
            color: #888;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .timeline-title {
            font-size: 1.1em;
            font-weight: bold;
            margin-bottom: 5px;
            display: inline-block;
            padding: 5px 0;
        }

        .timeline-content {
            font-size: 1em;
            line-height: 1.5;
            color: #555;
        }

        .timeline-content img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin-top: 10px;
            display: block;
        }

        .timeline-link {
            display: inline-block;
            margin-top: 10px;
            color: #007bff;
            text-decoration: none;
            font-weight: bold;
        }

        .timeline-link:hover {
            text-decoration: underline;
        }

        .timeline li:before {
            content: '';
            position: absolute;
            left: 15px;
            top: 0;
            bottom: 0;
            border-left: 2px solid #007bff;
            margin-top: 10px;
        }

        .number-title {
            font-weight: bold;
            margin-right: 5px;
            color: #007bff;
        }

        .highlight-block {
            background-color: #7FFF00;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            border: 1px solid #b2ebf2;
        }

        @media (max-width: 768px) {
            .perjalanan-hidup-modal-content {
                width: 95%;
                max-width: 95%;
                margin: 20px auto;
            }
            .perjalanan-hidup-timeline li {
                padding-left: 30px;
            }
            .perjalanan-hidup-timeline li:before {
                left: 10px;
            }
             .info-bar-container {
                flex-direction: column;
                gap: 10px;
            }
        }

        .perjalanan-hidup-modal-content {
          animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
          from {
            opacity: 0;
          }
          to {
            opacity: 1;
          }
        }
 


/* Style untuk badge pesan belum dibaca */
.unread-badge {
    display: none;
    background-color: #ff3b30;
    color: white;
    border-radius: 10px;
    padding: 2px 6px;
    font-size: 12px;
    margin-left: 8px;
    vertical-align: middle;
}

.has-unread {
    background-color: #f0f8ff;
    font-weight: bold;
}

/* Style untuk notifikasi */
.message-notification {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    padding: 12px;
    display: flex;
    align-items: center;
    max-width: 300px;
    z-index: 1000;
    animation: slideIn 0.3s ease-out;
}

.notification-avatar {
    background: #007aff;
    color: white;
    width: 36px;
    height: 36px;
    border-radius: 18px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 12px;
    font-weight: bold;
}

.notification-content {
    flex: 1;
}

.notification-name {
    font-weight: bold;
    margin-bottom: 4px;
}

.notification-message {
    color: #666;
    font-size: 14px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.fade-out {
    animation: fadeOut 0.3s ease-out forwards;
}

@keyframes slideIn {
    from { transform: translateY(100px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}

@keyframes fadeOut {
    to { opacity: 0; transform: translateY(20px); }
}









/* Layout Utama */
#chatContainer {
    display: flex;
    gap: 20px;
    margin-top: 20px;
}

#contactsSidebar {
    width: 300px;
    border-right: 1px solid #eee;
    padding-right: 20px;
}

#chatArea {
    flex: 1;
}
/* Gaya untuk Daftar Kontak */
#contactsList {
    max-height: 500px;
    overflow-y: auto;
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 10px; /* Increased padding for better spacing */
}

.contact-item {
    display: flex;
    align-items: center;
    padding: 15px; /* Increased padding for larger appearance */
    border-radius: 8px; /* Slightly rounded corners */
    margin-bottom: 10px; /* Increased margin for spacing */
    cursor: pointer;
    transition: all 0.2s;
    position: relative;
}

.contact-item:hover {
    background-color: #f5f5f5;
}

.contact-item.active {
    background-color: #e0f7fa;
    border-left: 5px solid #4CAF50; /* Increased border width for emphasis */
}

.contact-item.has-unread {
    background-color: #f0f8ff;
}

.contact-avatar {
    width: 50px; /* Increased avatar size */
    height: 50px; /* Increased avatar size */
    border-radius: 50%;
    background-color: #4CAF50;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    margin-right: 15px; /* Increased margin for better spacing */
    flex-shrink: 0;
}

.contact-info {
    flex: 1;
    min-width: 0;
}

.contact-name {
    font-weight: bold;
    font-size: 15px; /* Increased font size for contact name */
    margin-bottom: 5px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.contact-last-message {
    font-size: 18px; /* Increased font size for last message */
    color: #666;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    display: flex;
    align-items: center;
}

/* Gaya untuk indikator status */
.contact-avatar-container {
    position: relative;
    margin-right: 15px;
}

.contact-status {
    position: absolute;
    bottom: 0;
    right: 0;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    border: 2px solid white;
}

.contact-status.online {
    background-color: #4CAF50;
}

.contact-status.offline {
    background-color: #cccccc;
}

.contact-status.busy {
    background-color: #f44336;
    animation: pulse 1.5s infinite;
}

/* Gaya untuk unread count */
.unread-count {
  background-color: #ff4d4f;
  color: white;
  font-size: 0.8em;
  font-weight: bold;
  border-radius: 50%;
  padding: 2px 6px;
  margin-left: 5px;
  display: inline-block;
  vertical-align: middle;
}

.contact-item.has-unread .contact-name {
  font-weight: bold;
}

/* Gaya untuk Area Chat */
#messageBox {
    height: 400px;
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 15px;
    overflow-y: auto;
    background-color: #f9f9f9;
    margin-bottom: 15px;
}

.no-chat-selected {
    text-align: center;
    padding: 50px;
    color: #666;
    font-style: italic;
}

.message-container {
    display: flex;
    margin-bottom: 12px;
}

.message-container.sent {
    justify-content: flex-end;
}

.message-container.received {
    justify-content: flex-start;
}

.message-bubble {
    max-width: 70%;
    padding: 10px 15px;
    border-radius: 18px;
    position: relative;
}

.sent .message-bubble {
    background-color: #dcf8c6;
    border-bottom-right-radius: 3px;
}

.received .message-bubble {
    background-color: #fff;
    border: 1px solid #e5e5ea;
    border-bottom-left-radius: 3px;
}

.message-sender {
    font-weight: bold;
    font-size: 0.85em;
    margin-bottom: 3px;
}

.message-text {
    word-wrap: break-word;
}

.message-time {
    font-size: 0.7em;
    color: #666;
    text-align: right;
    margin-top: 3px;
}

/* Input Area */
.message-input-container {
    display: flex;
    gap: 10px;
}

#messageInput {
    flex: 1;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 5px;
    font-size: 1em;
}

#sendMessageBtn {
    padding: 10px 20px;
    background-color: #4CAF50;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 1em;
}

#sendMessageBtn:disabled {
    background-color: #cccccc;
    cursor: not-allowed;
}

/* Status Loading */
.loading-contacts, .loading-messages {
    text-align: center;
    padding: 20px;
    color: #666;
    font-style: italic;
}

.error-loading {
    text-align: center;
    padding: 20px;
    color: #f44336;
}

/* Notification Badge */
#newMessageBadge {
    position: fixed;
    top: 10px;
    right: 10px;
    background-color: #f44336;
    color: white;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    font-weight: bold;
    z-index: 1000;
    animation: pulse 1.5s infinite;
}

@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.2); }
    100% { transform: scale(1); }
}

/* Sticker Picker */
.sticker-picker-button {
    background: none;
    border: none;
    font-size: 1.5em;
    cursor: pointer;
    padding: 5px;
    margin-right: 5px;
}

.sticker-picker {
    position: absolute;
    bottom: 60px;
    right: 10px;
    width: 300px;
    height: 300px;
    background: white;
    border: 1px solid #ddd;
    border-radius: 10px;
    padding: 10px;
    overflow-y: auto;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    z-index: 100;
}

.sticker-picker.hidden {
    display: none;
}

.sticker-category {
    margin-bottom: 15px;
}

.sticker-category h4 {
    margin: 0 0 5px 0;
    color: #555;
    font-size: 0.9em;
}

.sticker-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 5px;
}

.sticker {
    background-color: #f5f5f5;
    border-radius: 5px;
    padding: 10px;
    text-align: center;
    cursor: pointer;
    font-size: 0.8em;
}

.sticker:hover {
    background-color: #e0e0e0;
}

.sticker-message {
    max-width: 200px;
}

.sticker-preview {
    background-color: #f5f5f5;
    border-radius: 10px;
    padding: 10px;
    text-align: center;
}

/* Profile Section */
#profileSection {
    background-color: #f9f9f9;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 20px;
}

#profileName {
    font-size: 1.2em;
    font-weight: bold;
    margin-bottom: 5px;
}

#profileBio {
    color: #555;
    margin-bottom: 5px;
}

#profileLastUpdated {
    font-size: 0.8em;
    color: #888;
}

#editProfileBtn {
    background-color: #4CAF50;
    color: white;
    border: none;
    border-radius: 4px;
    padding: 5px 10px;
    cursor: pointer;
    margin-top: 10px;
}

/* Profile Modal */
#profileModal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
    z-index: 1000;
    justify-content: center;
    align-items: center;
}

.modal-content {
    background-color: white;
    padding: 20px;
    border-radius: 8px;
    width: 80%;
    max-width: 500px;
}

.modal-content h3 {
    margin-top: 0;
}

.form-group {
    margin-bottom: 15px;
}

.form-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: bold;
}

.form-group input,
.form-group textarea {
    width: 100%;
    padding: 8px;
    border: 1px solid #ddd;
    border-radius: 4px;
}

.form-group textarea {
    height: 100px;
    resize: vertical;
}

.modal-actions {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    margin-top: 15px;
}

.modal-actions button {
    padding: 8px 15px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
}

#saveProfileBtn {
    background-color: #4CAF50;
    color: white;
}

#closeProfileModal {
    background-color: #f44336;
    color: white;
}

/* Add these styles to your existing CSS */
#notificationBar {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  background-color: #f8f9fa;
  z-index: 1000;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  padding: 10px;
  transition: transform 0.3s ease;
  transform: translateY(-100%);
}

#notificationBar.show {
  transform: translateY(0);
}

.notification-card {
  background: white;
  border-radius: 10px;
  padding: 15px;
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  max-width: 500px;
  margin: 0 auto;
}

.notification-header {
  display: flex;
  align-items: center;
  margin-bottom: 10px;
}

.app-logo {
  font-size: 24px;
  margin-right: 10px;
}

.app-name {
  font-weight: bold;
  flex-grow: 1;
}

.notification-time {
  font-size: 12px;
  color: #666;
}

.notification-content {
  display: flex;
  align-items: center;
}

.user-avatar {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background-color: #4CAF50;
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-right: 10px;
  font-weight: bold;
}

.notification-details {
  flex-grow: 1;
}

.user-name {
  font-weight: bold;
  margin-bottom: 3px;
}

.notification-message {
  font-size: 14px;
  color: #666;
  margin-bottom: 5px;
}

.open-now-btn {
  background-color: #4CAF50;
  color: white;
  border: none;
  border-radius: 4px;
  padding: 5px 10px;
  font-size: 12px;
  cursor: pointer;
}



.message-container {
  position: relative;
}


/* Style untuk modal pesan tersimpan */
.saved-messages-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
}

.saved-messages-modal.show {
    opacity: 1;
    visibility: visible;
}

.saved-messages-content {
    background: white;
    width: 90%;
    max-width: 500px;
    max-height: 80vh;
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
}

.saved-messages-header {
    padding: 15px 20px;
    background-color: #4CAF50;
    color: white;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.saved-messages-header h3 {
    margin: 0;
    font-size: 1.2rem;
}

.close-saved-messages {
    background: none;
    border: none;
    color: white;
    font-size: 1.5rem;
    cursor: pointer;
}

.saved-messages-body {
    padding: 15px;
    overflow-y: auto;
    max-height: 60vh;
}

.saved-message-item {
    border-bottom: 1px solid #eee;
    padding: 15px 0;
    margin-bottom: 15px;
}

.saved-message-header {
    display: flex;
    align-items: center;
    margin-bottom: 10px;
}

.saved-message-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background-color: #4CAF50;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    margin-right: 10px;
    flex-shrink: 0;
}

.saved-message-info {
    flex-grow: 1;
}

.saved-message-sender {
    font-weight: bold;
    margin-bottom: 3px;
}

.saved-message-time {
    font-size: 0.8rem;
    color: #666;
}

.saved-message-content {
    margin-left: 50px;
    padding: 10px;
    background-color: #f5f5f5;
    border-radius: 5px;
    margin-top: 10px;
}

.saved-message-actions {
    margin-left: 50px;
    margin-top: 10px;
}

.delete-saved-message {
    background-color: #ff4d4f;
    color: white;
    border: none;
    padding: 5px 10px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.9rem;
}

.delete-saved-message:hover {
    background-color: #ff7875;
}

.empty-saved-messages {
    text-align: center;
    padding: 40px 20px;
    color: #666;
}

.save-message-btn {
  background: none;
  border: none;
  font-size: 18px;
  cursor: pointer;
  margin-left: 6px;
  color: #444;
  position: absolute;
  top: 5px;
  right: 5px;
  z-index: 10;
}

.save-message-btn:hover {
  color: #007bff;
}


/* Style untuk tombol save */
.save-message-btn {
    background: none;
    border: 1px solid #ddd;
    color: #666;
    cursor: pointer;
    font-size: 0.8rem;
    padding: 3px 8px;
    border-radius: 4px;
    margin-left: 5px;
    opacity: 0;
    transition: opacity 0.2s;
}

.message-container:hover .save-message-btn {
    opacity: 1;
}

.save-message-btn:hover {
    background-color: #f0f0f0;
}

.message-status {
    display: inline-block;
    font-size: 14px;
    margin-left: 8px;
    vertical-align: middle;
    cursor: help;
}


.group-item {
    display: flex;
    align-items: center;
    padding: 12px;
    margin-bottom: 8px;
    background-color: #f5f5f5;
    border-radius: 8px;
    cursor: pointer;
    transition: background-color 0.2s;
}

.group-item:hover {
    background-color: #e0e0e0;
}

.group-item.active {
    background-color: #e3f2fd;
    border-left: 3px solid #2196f3;
}

.group-item-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background-color: #2196f3;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 12px;
    flex-shrink: 0;
}

.group-item-avatar img {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    object-fit: cover;
}

.group-item-info {
    flex: 1;
    min-width: 0;
}

.group-item-name {
    font-weight: bold;
    margin-bottom: 4px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.group-item-last {
    font-size: 0.9em;
    color: #666;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.group-item-time {
    font-size: 0.8em;
    color: #888;
    margin-left: 8px;
}

.group-item-members {
    font-size: 0.8em;
    color: #666;
    margin-left: 8px;
}

/* Group Detail View */
.group-header {
    display: flex;
    align-items: center;
    margin-bottom: 20px;
}

.group-avatar {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background-color: #2196f3;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    margin-right: 15px;
}

.group-avatar img {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    object-fit: cover;
}

.search-result-item {
    padding: 10px;
    display: flex;
    align-items: center;
    cursor: pointer;
    border-bottom: 1px solid #eee;
}

.search-result-item:hover {
    background-color: #f5f5f5;
}

.search-result-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background-color: #2196f3;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 10px;
    overflow: hidden;
}

.search-result-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.search-result-avatar span {
    font-size: 18px;
}

.search-result-info {
    flex: 1;
    min-width: 0;
}

.search-result-name {
    font-weight: bold;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.search-result-email {
    font-size: 0.8em;
    color: #666;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.no-results {
    padding: 10px;
    color: #666;
    text-align: center;
}

.error-message {
    padding: 10px;
    color: #f44336;
    text-align: center;
}

.group-info h3 {
    margin: 0;
    font-size: 1.3em;
}

.group-info p {
    margin: 5px 0;
    color: #666;
    font-size: 0.9em;
}

.group-bio {
    padding: 15px;
    background-color: #f5f5f5;
    border-radius: 8px;
    margin-bottom: 15px;
}

.group-created {
    font-size: 0.8em;
    color: #888;
    margin-bottom: 20px;
}

.group-actions {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
}

.group-actions button {
    padding: 8px 15px;
    border: none;
    border-radius: 4px;
    background-color: #2196f3;
    color: white;
    cursor: pointer;
}

.group-actions button:hover {
    background-color: #1976d2;
}

.group-section {
    margin-bottom: 20px;
}

.group-section h4 {
    border-bottom: 1px solid #eee;
    padding-bottom: 5px;
    margin-bottom: 10px;
}

#memberList {
    list-style: none;
    padding: 0;
}

#memberList li {
    padding: 8px 0;
    border-bottom: 1px solid #eee;
    display: flex;
    align-items: center;
}

#memberList li:last-child {
    border-bottom: none;
}

.member-avatar {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    background-color: #2196f3;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 10px;
    font-size: 0.8em;
}

.member-name {
    flex-grow: 1;
}
.modal {
  display: none; /* ditampilkan dengan JavaScript */
  position: fixed;
  z-index: 1000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0,0,0,0.5);
  justify-content: center;
  align-items: center;
}

.modal-content {
  background-color: white;
  padding: 20px;
  border-radius: 10px;
  width: 90%;
  max-width: 450px;
  max-height: 80vh;
  overflow-y: auto;
  position: relative;
  animation: fadeInModal 0.3s ease-in-out;
}

@keyframes fadeInModal {
  from { opacity: 0; transform: scale(0.9); }
  to   { opacity: 1; transform: scale(1); }
}

.close-modal {
  position: absolute;
  top: 10px;
  right: 15px;
  font-size: 24px;
  font-weight: bold;
  cursor: pointer;
  border: none;
  background: none;
}


.form-group {
    margin-bottom: 15px;
}

.form-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: bold;
}

.form-group input,
.form-group textarea {
    width: 100%;
    padding: 8px;
    border: 1px solid #ddd;
    border-radius: 4px;
}

.form-group textarea {
    height: 100px;
    resize: vertical;
}

.member-selection {
    position: relative;
}

.search-results {
    position: absolute;
    width: 100%;
    max-height: 200px;
    overflow-y: auto;
    background-color: white;
    border: 1px solid #ddd;
    border-radius: 4px;
    z-index: 10;
    display: none;
}

.search-results div {
    padding: 8px 12px;
    cursor: pointer;
}

.search-results div:hover {
    background-color: #f5f5f5;
}

.selected-members {
    display: flex;
    flex-wrap: wrap;
    gap: 5px;
    margin-top: 10px;
}

.selected-member {
    background-color: #e3f2fd;
    padding: 5px 10px;
    border-radius: 15px;
    font-size: 0.8em;
    display: flex;
    align-items: center;
}

.selected-member button {
    margin-left: 5px;
    background: none;
    border: none;
    cursor: pointer;
    color: #666;
}

/* Responsive Styles */
@media (max-width: 768px) {
    #groupMainContainer {
        flex-direction: column;
    }
    
    #groupSidebar {
        width: 100%;
        border-right: none;
        padding-right: 0;
        border-bottom: 1px solid #eee;
        padding-bottom: 15px;
    }
}

 /* Basic styling for tab content (you might have this already) */
    .tab-content {
      display: none; /* Hide all tab content by default */
    }

    .tab-content.active {
      display: block; /* Show active tab content */
    }

    .tab-button.active {
      background-color: #e0e0e0; /* Example active tab button style */
    }

/* TAMPILAN UTAMA FOLLOWERS & FOLLOWING */
.user-follow-section {
    display: flex;
    align-items: center;
    gap: 15px;
    margin: 15px 0;
    padding: 10px;
    background-color: #f8f9fa;
    border-radius: 8px;
}

.follow-count {
    font-size: 0.95rem;
    color: #1a73e8;
    cursor: pointer;
    text-decoration: underline;
}

.follow-count:hover {
    color: #155ea0;
}

/* LIST PENGGUNA DI MODAL */
.user-list {
    list-style: none;
    padding: 0;
    margin-top: 10px;
}

.user-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 10px 0;
    border-bottom: 1px solid #eee;
}

.user-item:last-child {
    border-bottom: none;
}

.user-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background-color: #ddd;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    margin-right: 10px;
}

.user-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.user-info {
    flex: 1;
}

.user-name {
    font-weight: bold;
    font-size: 0.95rem;
}

.user-email {
    font-size: 0.8rem;
    color: #666;
}

/* Tombol Follow */
.follow-btn {
    background-color: #1a73e8;
    color: white;
    border: none;
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 0.85rem;
    cursor: pointer;
    transition: background-color 0.3s;
}

.follow-btn:hover {
    background-color: #155ea0;
}

.follow-btn.following {
    background-color: #f44336;
}

.follow-btn.following:hover {
    background-color: #d32f2f;
}







.member-item {
    display: flex;
    align-items: center;
    padding: 10px;
    border-bottom: 1px solid #eee;
}

.member-item .follow-member-btn {
    margin-left: auto;
    padding: 5px 10px;
    border: none;
    border-radius: 4px;
    background-color: #4CAF50;
    color: white;
    cursor: pointer;
    font-size: 0.8em;
}

.member-item .follow-member-btn.following {
    background-color: #f44336;
}

.member-item .follow-member-btn:hover {
    opacity: 0.9;
}


.member-item {
    display: flex;
    align-items: center;
    padding: 10px;
    border-bottom: 1px solid #eee;
}

.member-item .follow-member-btn {
    margin-left: auto;
    padding: 5px 10px;
    border: none;
    border-radius: 4px;
    background-color: #4CAF50;
    color: white;
    cursor: pointer;
    font-size: 0.8em;
}

.member-item .follow-member-btn.following {
    background-color: #f44336;
}

.member-item .follow-member-btn:hover {
    opacity: 0.9;
}

.member-info {
    flex-grow: 1;
    margin-left: 10px;
}

.member-name {
    font-weight: bold;
}

.member-email {
    font-size: 0.8em;
    color: #666;
}


.user-item {
  opacity: 0;
  transform: translateY(10px);
  animation: fadeInUp 0.3s ease forwards;
}

.user-item:nth-child(1) { animation-delay: 0.05s; }
.user-item:nth-child(2) { animation-delay: 0.1s; }
/* dst */

@keyframes fadeInUp {
  to {
    opacity: 1;
    transform: translateY(0);
  }
}


.user-list {
  margin-top: 15px;
  max-height: 400px;
  overflow-y: auto;
}

.user-item {
  display: flex;
  align-items: center;
  padding: 10px;
  border-bottom: 1px solid #eee;
  transition: background 0.2s ease;
}

.user-item:hover {
  background-color: #f9f9f9;
}

.user-avatar {
  width: 45px;
  height: 45px;
  border-radius: 50%;
  overflow: hidden;
  margin-right: 12px;
  background-color: #ddd;
  display: flex;
  align-items: center;
  justify-content: center;
}

.user-avatar img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.user-info {
  flex: 1;
}

.user-name {
  font-weight: bold;
}

.user-email {
  font-size: 0.8rem;
  color: #666;
}


/* Modal Styles */
.modal {
  display: none;
  position: fixed;
  z-index: 1000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0,0,0,0.5);
}

.modal-content {
  background-color: white;
  margin: 10% auto;
  padding: 20px;
  border-radius: 8px;
  width: 80%;
  max-width: 500px;
  max-height: 70vh;
  overflow-y: auto;
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.close-modal {
  float: right;
  font-size: 24px;
  font-weight: bold;
  cursor: pointer;
}

.user-list {
  margin-top: 15px;
}

.user-item {
  display: flex;
  align-items: center;
  padding: 10px;
  border-bottom: 1px solid #eee;
}

.user-item:last-child {
  border-bottom: none;
}

.user-avatar {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background-color: #e0e0e0;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-right: 10px;
  overflow: hidden;
}

.user-avatar img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

/* Style untuk bagian anggota grup */
.member-follow-section {
  display: flex;
  align-items: center;
  gap: 15px;
  padding: 10px;
  margin-top: 10px;
  border-top: 1px solid #eee;
}

.follow-stats {
  display: flex;
  gap: 15px;
}

.stat-btn {
  background: none;
  border: none;
  font-size: 14px;
  color: #333;
  cursor: pointer;
  padding: 5px;
}

.stat-btn:hover {
  text-decoration: underline;
}

.stat-btn .count {
  font-weight: bold;
  color: #1a73e8;
}

.follow-btn {
  background-color: #1a73e8;
  color: white;
  border: none;
  padding: 8px 16px;
  border-radius: 20px;
  font-size: 14px;
  cursor: pointer;
  transition: background-color 0.3s;
}

.follow-btn.following {
  background-color: #e0e0e0;
  color: #333;
}

.member-follow-btn {
    background-color: #4285f4;
    color: white;
    border: none;
    padding: 5px 10px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 12px;
}

.member-follow-btn.following {
    background-color: #34a853;
}

.member-follow-stats {
    margin-top: 5px;
    font-size: 12px;
    color: #666;
}

.member-follow-stats span {
    cursor: pointer;
    text-decoration: underline;
}

.follower-item {
    display: flex;
    align-items: center;
    padding: 10px;
    border-bottom: 1px solid #eee;
}

.follower-avatar {
    width: 40px;
    height: 40px;
    background-color: #4285f4;
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 10px;
    font-weight: bold;
}

.follower-info {
    flex: 1;
}

.follower-name {
    font-weight: bold;
}

.follower-email {
    font-size: 12px;
    color: #666;
}

/* Style for follow buttons */
.follow-btn {
    padding: 5px 15px;
    border: none;
    border-radius: 20px;
    background-color: #4CAF50;
    color: white;
    cursor: pointer;
    font-size: 14px;
    transition: background-color 0.3s;
}

.follow-btn.following {
    background-color: #f44336;
}

.follow-btn:disabled {
    background-color: #cccccc;
    cursor: not-allowed;
}

/* Style for user list in modals */
.user-list {
    max-height: 400px;
    overflow-y: auto;
}

.user-item {
    display: flex;
    align-items: center;
    padding: 10px;
    border-bottom: 1px solid #eee;
}

.user-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background-color: #ddd;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 15px;
    overflow: hidden;
}

.user-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.user-info {
    flex-grow: 1;
}

.user-name {
    font-weight: bold;
}

.user-email {
    font-size: 12px;
    color: #777;
}

.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
    justify-content: center;
    align-items: center;
}

.modal-content {
    background-color: white;
    padding: 20px;
    border-radius: 8px;
    width: 90%;
    max-width: 500px;
    max-height: 80vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
}

.modal-content h3 {
    margin-top: 0;
}

.close-modal {
    position: absolute;
    top: 10px;
    right: 10px;
    font-size: 24px;
    background: none;
    border: none;
    cursor: pointer;
}

.group-detail-header {
  display: flex;
  align-items: center;
  background: #fff;
  padding: 20px;
  border-radius: 12px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  margin-bottom: 20px;
}

.group-detail-info {
  flex: 1;
}

.group-detail-name {
  font-size: 1.2rem;
  font-weight: 600;
}

.group-detail-stats {
  font-size: 0.9rem;
  color: #666;
  margin-top: 8px;
}

.group-actions {
  display: flex;
  gap: 12px;
  margin-top: 12px;
}

.group-actions button {
  padding: 10px 18px;
  border-radius: 25px;
  font-weight: 500;
  transition: all 0.3s ease;
}

#followGroupBtn {
  background-color: #4caf50;
  color: #fff;
}

#followGroupBtn.unfollow {
  background-color: #f44336;
}

#followGroupBtn:hover {
  filter: brightness(1.1);
}

.member-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px;
  border-bottom: 1px solid #eee;
  transition: background-color 0.2s ease;
}

.member-item:hover {
  background-color: #fafafa;
  border-radius: 8px;
}

.member-avatar {
  width: 45px;
  height: 45px;
  border-radius: 50%;
  background: #1976d2;
  color: white;
  font-weight: bold;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
}

.member-name {
  font-size: 1rem;
  font-weight: 600;
}

.member-email {
  font-size: 0.85rem;
  color: #777;
}

button {
  transition: all 0.3s ease;
}

button:hover {
  transform: translateY(-1px);
  box-shadow: 0 3px 8px rgba(0,0,0,0.1);
}

.member-item {
  opacity: 0;
  transform: translateY(10px);
  animation: fadeInUp 0.4s ease forwards;
}

.member-item:nth-child(1) { animation-delay: 0.05s; }
.member-item:nth-child(2) { animation-delay: 0.1s; }
.member-item:nth-child(3) { animation-delay: 0.15s; }

@keyframes fadeInUp {
  to {
    opacity: 1;
    transform: translateY(0);
  }
}


.follow-notification {
  position: fixed;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  background-color: #4caf50;
  color: white;
  padding: 10px 20px;
  border-radius: 25px;
  opacity: 0;
  transition: opacity 0.3s ease, bottom 0.3s ease;
}

.follow-notification.show {
  opacity: 1;
  bottom: 40px;
}

#auth-container .button {
    background: white;
    color: red;
    border: none;
    padding: 12px 24px;
    font-size: 16px;
    border-radius: 4px;
    cursor: pointer;
    transition: background 0.3s;
}

#auth-container .button:hover {
    background: white;
}


.google-login-btn {
  padding: 10px 20px;
  font-size: 16px;
  border-radius: 8px;
  background: #fff;
  border: 1px solid #ccc;
  cursor: pointer;
  display: inline-flex;
  align-items: center;
  gap: 8px;
}

.google-login-button:hover {
  background: #f5f5f5;
}

.google-login-btn img {
  width: 16px;
  height: 16px;
}


 
    </style>
</head>
<body>

 <div class="info-bar-container" id="infoBar">
        <div class="icon-text-group">
            <span class="info-icon announcement-icon">üì¢</span>
            <span>Pengumuman:</span>
        </div>
        <div class="icon-text-group">
            <span class="info-icon birthday-icon">üéâ</span>
            <span>Selamat Ulang Tahun Farid Ardiansyah!</span>
        </div>
        <div class="icon-text-group">
            <span class="info-icon countdown-icon">‚è≥</span>
            <span class="countdown-text" id="countdown"></span>
        </div>
    </div>
	
	


    <div class="perjalanan-hidup-modal" id="myModal">
        <div class="perjalanan-hidup-modal-content">
            <div class="perjalanan-hidup-modal-header">
                <h2>Perjalanan Hidup</h2>
                <button class="perjalanan-hidup-close-button" id="closeModalBtn">&times;</button>
            </div>
            <ul class="perjalanan-hidup-timeline">
                <li>
                    <div class="timeline-icon">üë∂</div>
                    <div class="timeline-date"><span class="hari">Selasa </span>, 29 Mei 2001 <span class="pukul">xx:xx WIB</span></div>
                    <h3 class="timeline-title"><span class="number-title">1.</span> Kelahiran</h3>
                    <div class="timeline-content">
                        <p>Farid Ardiansyah lahir di Jakarta Utara, Jakarta.  Anak pertama dari pasangan [Nama Ayah] dan [Nama Ibu].</p>
                        <img src="images/.jpg" alt="Foto Kelahiran Farid" width="400" height="300">
                    </div>
                </li>
				
                <li>
                    <div class="timeline-date"><span class="hari">x</span>, xx x 2013 <span class="pukul">xx:xx WIB</span></div>
                    <h3 class="timeline-title"><span class="number-title">2.</span> Lulus MI</h3>
                    <div class="timeline-content">
                        <p>Meraih lulus dari sekolah MI, melanjutkan ke MTSN 2013.</p>
						 <img src="images/5.jpg" alt="" width="400" height="300">
                        <div class="highlight-block">
                            <p>"Menurut saya, lulus dari sekolah Mi dengan NEM baik, buat melanjutkan masuk sekolah MTSN."</p>
                        </div>
						</div>
                </li>
				<li>
                    <div class="timeline-date"><span class="hari">x</span>, xx x 2016 <span class="pukul">xx:xx WIB</span></div>
                    <h3 class="timeline-title"><span class="number-title">3.</span> Lulus MTSN</h3>
                    <div class="timeline-content">
                        <p>Meraih lulus dari sekolah MTSN, melanjutkan ke SMKN 2016.</p>
						                       <img src="images/5.jpg" alt="" width="400" height="300">
                        <div class="highlight-block">
                            <p>"Menurut saya, lulus dari sekolah MTSN dengan Test masuk baik, buat melanjutkan masuk sekolah SMKN."</p>
                        </div>
						 </div>
						 </li>
                 
				<li>
                      <div class="timeline-date"><span class="hari">x</span>, xx x 2019 <span class="pukul">xx:xx WIB</span></div>
                    <h3 class="timeline-title"><span class="number-title">4.</span> Lulus SMKN</h3>
                    <div class="timeline-content">
                        <p>Meraih lulus dari sekolah SMKN, melanjutkan ke Universitas Gunadarma 2019.</p>
						                       <img src="images/5.jpg" alt="" width="400" height="300">
                        <div class="highlight-block">
                            <p>"Menurut saya, lulus dari sekolah SMKN, lumayan sulit banyak kegiatan seperti PKL, USBN, UN, US, UPRAK, dst. dengan Test masuk baik sampai 1000 soal pg lebih, buat melanjutkan masuk kuliah Universitas Gunadarma 2019."</p>
                        </div>
						</div>
                </li>
				<li>
                    
					
					
					Coming Soon
					
					
					
					
					
                </li>
				
				
                <li>
                    <div class="timeline-icon">üíº</div>
                    <div class="timeline-date"><span class="hari">Coming Soon</span>, Coming Soon <span class="pukul">Coming Soon WIB</span></div>
                    <h3 class="timeline-title"><span class="number-title">5.</span> Karier Pertama Coming Soon</h3>
                    <div class="timeline-content">
                        <p>Coming Soon.</p>
						 <img src="images/5.jpg" alt="" width="400" height="300">
                        <p>Kunjungi <a href="https://www.example.com" target="_blank" rel="noopener noreferrer" class="timeline-link">website perusahaan</a> untuk informasi lebih lanjut.</p>
                    </div>
                </li>
				
				
                 <li>
                    <div class="timeline-icon">üöÄ</div>
                    <div class="timeline-date"><span class="hari">Coming Soon</span>, Coming Soon <span class="pukul">Coming Soon WIB</span></div>
                    <h3 class="timeline-title"><span class="number-title">6.</span> Pencapaian Coming Soon</h3>
                    <div class="timeline-content">
                        <p>Coming Soon.</p>
						 <img src="images/5.jpg" alt="" width="400" height="300">
                    </div>
                </li>
				
				 <li>
                    <div class="timeline-icon">üöÄ</div>
                    <div class="timeline-date"><span class="hari">Coming Soon</span>, Coming Soon Umur 30 an <span class="pukul">Coming Soon WIB</span></div>
                    <h3 class="timeline-title"><span class="number-title">7.</span> Istri Pertama Coming Soon</h3>
                    <div class="timeline-content">
                        <p>Coming Soon.</p>
						 <img src="images/5.jpg" alt="" width="400" height="300">
                    </div>
                </li>
				
				 <li>
                    <div class="timeline-icon">üöÄ</div>
                    <div class="timeline-date"><span class="hari">Coming Soon</span>, Coming Soon <span class="pukul">Coming Soon WIB</span></div>
                    <h3 class="timeline-title"><span class="number-title">8.</span> Anak Pertama Coming Soon</h3>
                    <div class="timeline-content">
                        <p>Coming Soon.</p>
						 <img src="images/5.jpg" alt="" width="400" height="300">
                    </div>
                </li>
				
                <li>
                    <div class="timeline-icon">üåç</div>
                    <div class="timeline-date"><span class="hari">Coming Soon</span>, Coming Soon<span class="pukul">Coming Soon WIB</span></div>
                    <h3 class="timeline-title"><span class="number-title">9.</span> Kontribusi volunteer Coming Soon</h3>
                    <div class="timeline-content">
                        <p>Menjadi kontributor aktif dalam proyek open source <a href="https://github.com/example/open-source-project" target="_blank" rel="noopener noreferrer" class="timeline-link">Coming Soon</a>. Coming Soon.</p>
						 <img src="images/5.jpg" alt="" width="400" height="300">
                    </div>
                </li>
            </ul>
        </div>
    </div>



    <h1>üìù Noted</h1>


    <div class="note-input-container">
    <input type="text" id="noteInput" placeholder="Tulis catatan di sini...">
    <button id="saveBtn">Simpan</button>
    <button id="voiceInputBtn" class="voice-icon-btn">
        <svg viewBox="0 0 24 24" fill="currentColor" style="width: 24px; height: 24px;">
            <path fill="none" d="M0 0h24v24H0z"/>
            <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.3-3c0 3-2.54 5.1-5.3 5.1S6.7 14 6.7 11H5c0 3.41 2.72 6.23 6 6.72V21h2v-3.28c3.28-.48 6-3.3 6-6.72h-1.7z"/>
        </svg>
    </button>
</div>

	<button id="googleLoginBtn" style="background-color:#4285F4; color:white; padding:12px 20px; border:none; border-radius:6px; display:flex; align-items:center; gap:10px; cursor:pointer;">
  <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="20" height="20" alt="G"> 
  Login with Google
</button>


 
   <div id="app">
    <div class="login-container slide-in" id="loginForm">
        <h2>Login</h2>
        <div class="input-group">
            <label for="email">Email:</label>
            <input type="email" id="email" name="email" required>
        </div>
        <div class="input-group">
            <label for="password">Password:</label>
            <input type="password" id="password" name="password" required>
        </div>

        <button id="emailLoginBtn" class="primary-button">Login</button>
        <p id="errorMessage" class="error-message hidden"></p>
    </div>

    <div class="greeting-container hidden" id="greetingDiv">
        <h2 id="userGreeting">Halo Pengguna üëã</h2>
        <button onclick="logout()">Keluar</button>
    </div>
</div>
        
    <div class="dashboard-container hidden" id="dashboardDiv">
        <h2>Dashboard Akun</h2>
        <p class="dashboard-greeting" id="dashboardGreetingName">Halo, Penggunaüëã</p>
        <div class="section">
            <h2>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="1em" height="1em" fill="currentColor">
                    <path d="M17 3H7c-1.1 0-1.99.9-1.99 2L5 21l7-3 7 3V5c0-1.1-.9-2-2-2z"/>
                </svg>
                Catatan Favorit
            </h2>
            <div style="margin-bottom: 10px;">
                <button id="showSavedNotesBtn" class="bulk-save-button">Lihat Catatan Tersimpan</button>
            </div>
            <div id="notesList"></div>
        </div>
    </div>

    <div id="savedNotesModal" class="saved-notes-modal-overlay" style="display: none;">
    <div class="saved-notes-modal-content">
        <button class="modal-close-button" id="closeSavedNotesModal">&times;</button>
        <h2>Catatan yang Anda Simpan</h2>
        <label for="topicFilter">Filter Berdasarkan Topik:</label>
        <select id="topicFilter">
            <option value="">Semua Topik</option>
            <option value="makanan">Makanan</option>
            <option value="belajar">Belajar</option>
            <option value="pekerjaan">Pekerjaan</option>
            <option value="hiburan">Hiburan</option>
            <option value="kesehatan">Kesehatan</option>
            <option value="cinta">Cinta</option>
            <option value="lain-lain">Lain-lain</option>
        </select>
        <div id="savedNotesContainer">
        </div>
</div>
</div>



    <!-- Main Chat Container -->
    <div class="section">
        <h2>Pesan Pribadi</h2>
        
        <div id="chatContainer">
            <div id="contactsSidebar">
                <h3>Pilih Kontak:</h3>
                <div id="contactsList">
                    <!-- Contacts will be loaded here -->
                    <div class="loading-contacts">Memuat daftar kontak...</div>
                </div>
            </div>
            
            <div id="chatArea">
                <div id="currentChatInfo" style="display: none;">
                    <strong>Sedang chat dengan:</strong> 
                    <span id="currentChatWith">-</span>
                </div>
                
                <div id="messageBox">
                    <div class="no-chat-selected">Pilih kontak untuk memulai percakapan</div>
                </div>
                
                <div class="message-input-container">
                    <input type="text" id="messageInput" placeholder="Ketik pesan..." disabled />
                    <button id="sendMessageBtn" disabled>Kirim</button>
                </div>
            </div>
        </div>
    </div>
	

    <!-- Profile Section -->
    <div id="profileSection">
        <h3>Profil Saya</h3>
        <div id="profileName">Memuat...</div>
        <div id="profileBio">Memuat bio...</div>
        <div id="profileLastUpdated">Memuat...</div>
        <button id="editProfileBtn">Edit Profil</button>
    </div>

    <!-- Profile Modal -->
    <div id="profileModal">
        <div class="modal-content">
            <h3>Edit Profil</h3>
            <div class="form-group">
                <label for="profileNameInput">Nama:</label>
                <input type="text" id="profileNameInput" placeholder="Nama Anda">
            </div>
            <div class="form-group">
                <label for="profileBioInput">Bio:</label>
                <textarea id="profileBioInput" placeholder="Tulis bio Anda"></textarea>
            </div>
            <div class="modal-actions">
                <button id="closeProfileModal">Batal</button>
                <button id="saveProfileBtn">Simpan</button>
            </div>
        </div>
    </div>
	
	
   <!-- Add this above the chat container -->
<div id="notificationBar" class="hidden">
  <div class="notification-card">
    <div class="notification-header">
      <div class="app-logo">üí¨</div>
      <div class="app-name">Chat App</div>
      <div class="notification-time" id="notificationTime">now</div>
    </div>
    <div class="notification-content">
      <div class="user-avatar" id="notificationAvatar">U</div>
      <div class="notification-details">
        <div class="user-name" id="notificationUserName">User</div>
        <div class="notification-message">You have a new message!</div>
        <button class="open-now-btn" id="openNotificationBtn">Open Now</button>
      </div>
    </div>
  </div>
</div>



<!-- Tombol Buka Pesan Tersimpan -->
<button id="openSavedMessagesBtn" class="action-button">Buka Pesan Tersimpan</button>

<!-- Modal untuk Menampilkan Pesan Tersimpan -->
<div id="savedMessagesModal" class="saved-messages-modal">
  <div class="saved-messages-content">
    <div class="saved-messages-header">
      <h3>Pesan Tersimpan</h3>
      <button class="close-saved-messages">&times;</button>
    </div>
    <div class="saved-messages-body" id="savedMessagesContainer">
      <!-- Pesan tersimpan akan ditampilkan di sini -->
    </div>
  </div>
</div>



<div id="groupChatContainer" class="section">
    <h2>Grup Chat</h2>

    <div class="chat-tabs">
        <button class="tab-button active" data-tab="personal">Pesan Pribadi</button>
        <button class="tab-button" data-tab="group">Grup</button>
    </div>

    <div id="groupMainContainer">
        <div id="groupSidebar">
            <div class="group-search-container">
                <input type="text" id="groupSearchInput" placeholder="Cari grup atau anggota...">
                <button id="createGroupBtn">+ Buat Grup Baru</button>
            </div>

            <div id="groupListContainer">
                <h3>Grup Anda</h3>
                <div id="groupList">
                    <div class="loading-groups">Memuat daftar grup...</div>
                </div>
            </div>
        </div>

        <div id="groupContentArea">
            <div id="noGroupSelected" class="no-chat-selected">
                <i class="fas fa-users"></i>
                <p>Pilih grup untuk melihat detail</p>
            </div>

            <div id="groupDetailView" style="display: none;">
                <div class="group-detail-header">
                    <div id="groupDisplayPhoto" class="group-avatar"></div>
                    <div class="group-detail-info">
                        <div id="groupDisplayName" class="group-detail-name"></div>
                        <div id="groupDisplayBio" class="group-detail-bio"></div>
                        <div class="group-detail-stats">
                            <span id="groupMemberCount"></span>
                            <span id="groupFollowersCount"></span>
                            <span id="groupCreatedAt"></span>
                        </div>
						<div id="groupFollowersModal" class="modal">
    <div class="modal-content">
        <h3>Group Followers</h3>
        <button class="close-modal">&times;</button>
        <div id="groupFollowersList" class="followers-list"></div>
    </div>
</div>


                <div class="group-actions">
                    <button id="followGroupBtn">Ikuti Grup</button>
                    <button id="addMemberBtn" style="display: none;">Tambah Anggota</button>
                </div>

                <div class="group-section">
                    <div class="member-list-header">
                        <h4>Anggota Grup</h4>
                        <span id="liveMemberCount" class="member-count"></span>
                    </div>
                    <ul id="memberList"></ul>
                </div>

                <div class="group-section">
                    <h4>Pesan Grup</h4>
                    <div id="groupMessageBox" class="message-box"></div>
                    <div class="message-input-container">
                        <input type="text" id="groupMessageInput" placeholder="Ketik pesan...">
                        <button id="sendGroupMessageBtn">Kirim</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="createGroupModal" class="modal">
    <div class="modal-content">
        <h3>Buat Grup Baru</h3>
        <button class="close-modal">&times;</button>

        <div class="form-group">
            <label for="newGroupName">Nama Grup</label>
            <input type="text" id="newGroupName" placeholder="Masukkan nama grup">
        </div>

        <div class="form-group">
            <label for="newGroupBio">Deskripsi Grup (Opsional)</label>
            <textarea id="newGroupBio" placeholder="Masukkan deskripsi grup"></textarea>
        </div>

        <div class="group-search-tabs">
            <div class="group-search-tab active" data-tab="contacts">Cari Kontak</div>
            <div class="group-search-tab" data-tab="users">Cari Pengguna</div>
        </div>

        <div id="contactsSearchSection">
            <input type="text" id="searchContactInput" placeholder="Cari kontak...">
            <div id="contactSearchResults" class="search-results"></div>
        </div>

        <div id="usersSearchSection" style="display: none;">
            <input type="text" id="searchUserInput" placeholder="Cari pengguna...">
            <div id="userSearchResults" class="search-results"></div>
        </div>

        <div class="selected-members-container">
            <h4>Anggota Terpilih</h4>
            <div id="selectedMembers" class="selected-members"></div>
        </div>

        <button id="confirmCreateGroupBtn">Buat Grup</button>
    </div>
</div>

<div id="addMemberModal" class="modal">
    <div class="modal-content">
        <h3>Tambah Anggota ke Grup</h3>
        <button class="close-modal">&times;</button>

        <input type="text" id="searchMemberInput" placeholder="Cari pengguna...">
        <div id="memberSearchResults" class="search-results"></div>

        <div class="selected-members-container">
            <h4>Anggota yang Akan Ditambahkan</h4>
            <div id="selectedMembersToAdd" class="selected-members"></div>
        </div>

        <button id="confirmAddMemberBtn">Tambahkan Anggota</button>
    </div>
</div>
<!-- Modal untuk Followers -->
<div id="userFollowersModal" class="modal">
    <div class="modal-content">
        <span class="close-modal">&times;</span>
        <h3>Daftar Pengikut</h3>
        <div id="userFollowersList" class="user-list"></div>
    </div>
</div>

<!-- Modal untuk Following -->
<div id="userFollowingModal" class="modal">
    <div class="modal-content">
        <span class="close-modal">&times;</span>
        <h3>Daftar Yang Diikuti</h3>
        <div id="userFollowingList" class="user-list"></div>
    </div>
</div>












        <div class="section">
            <h2>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="1em" height="1em" fill="currentColor">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17h-2v-2h2v2zm2.07-7.75l-1.41 1.41C12.99 13.46 12 14 12 16h-2v-.5c0-1.99 1.51-3.49 3.57-3.49 1.41 0 2.54.83 3.02 2.08l1.41-1.41C16.81 10.24 14.49 9 12 9c-1.86 0-3.47 1.27-3.9 3.01L6.23 13.16c.47 1.74 2.14 3.09 3.9 3.09 2.31 0 4.2-1.71 4.2-4.09 0-1.53-.88-2.89-2.13-3.59z"/>
                </svg>
                Bantuan
            </h2>
            <ul>
                <li>
                    <a href="#" onclick="showHelp('faq')">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="1em" height="1em" fill="currentColor">
                            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17h-2v-2h2v2zm2.07-7.75l-1.41 1.41C12.99 13.46 12 14 12 16h-2v-.5c0-1.99 1.51-3.49 3.57-3.49 1.41 0 2.54.83 3.02 2.08l1.41-1.41C16.81 10.24 14.49 9 12 9c-1.86 0-3.47 1.27-3.9 3.01L6.23 13.16c.47 1.74 2.14 3.09 3.9 3.09 2.31 0 4.2-1.71 4.2-4.09 0-1.53-.88-2.89-2.13-3.59z"/>
                        </svg>
                        FAQ
                    </a>
                </li>
                <li>
                    <a href="#" onclick="showHelp('guide')">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="1em" height="1em" fill="currentColor">
                            <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14h-2v-2h2v2zm2-4h-4V6h4v6z"/>
                        </svg>
                        Panduan
                    </a>
                </li>
                <li>
                    <a href="#" onclick="showHelp('contact')">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="1em" height="1em" fill="currentColor">
                            <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-7 9h-2V5h2v6zm0 4h-2v-2h2v2z"/>
                        </svg>
                        Kontak
                    </a>
                </li>
            </ul>
            <div id="helpContent"></div>
        </div>

        <div class="section">
            <h2>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="1em" height="1em" fill="currentColor">
                    <path d="M19.43 12.98c.04-.32.07-.64.07-.98s-.03-.66-.07-.98l2.11-1.81c.19-.17.2-.5.03-.69l-2.8-4.83c-.17-.3-.5-.32-.7-.15l-2.42 2.08c-.51-.26-1.03-.48-1.58-.65l-.31-2.59c-.03-.34-.32-.6-.67-.6h-3.3c-.35 0-.64.26-.67.6l-.31 2.59c-.55.17-1.07.39-1.58.65L6.46 4.66c-.2-.17-.53-.15-.7.15l-2.8 4.83c-.17.19-.18.5-.03.69l2.11 1.81c-.04.32-.07.65-.07.98s.03.66.07.98l-2.11 1.81c-.19.17-.2.5-.03.69l2.8 4.83c.17.3.5.32.7.15l2.42-2.08c.51.26 1.03.48 1.58.65l.31 2.59c.03.34.32.6.67.6h3.3c.35 0 .64-.26.67-.6l.31-2.59c.55-.17 1.07-.39 1.58-.65l2.42 2.08c.2.17.53.15.7-.15l2.8-4.83c.17-.19.18-.5.03-.69l-2.11-1.81zM12 15.5c-1.93 0-3.5-1.57-3.5-3.5s1.57-3.5 3.5-3.5 3.5 1.57 3.5 3.5-1.57 3.5-3.5 3.5z"/>
                </svg>
                Pengaturan
            </h2>
            <label><input type="checkbox" onchange="toggleDarkMode()" /> Mode Gelap</label><br>
            <label><input type="checkbox" onchange="toggleNotifications()" /> Notifikasi</label>
        </div>

        <div class="section">
            <h2>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="1em" height="1em" fill="currentColor">
                    <path d="M16 11c1.66 0 2.99-1.34 2.99-3S19.66 5 18 5c-1.66 0-2.99 1.34-2.99 3S16.34 11 18 11zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-3.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62-.06-.94-.16 1.64-1.03 2.89-2.79 2.89-4.69 0-1.9-1.25-3.66-2.89-4.69.32-.1.65-.16.94-.16 2.33 0 7 1.17 7 3.5V19h-14v-3.5c0-2.33 4.67-3.5 7-3.5z"/>
                </svg>
                Komunitas
            </h2>
            <ul>
                <li>
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="1em" height="1em" fill="currentColor">
                        <path d="M20.5 2H3.5c-.83 0-1.5.67-1.5 1.5S2.67 5 3.5 5h17c.83 0 1.5-.67 1.5-1.5S21.33 2 20.5 2zm0 4H3.5c-.83 0-1.5.67-1.5 1.5S2.67 9 3.5 9h17c.83 0 1.5-.67 1.5-1.5S21.33 6 20.5 6zm0 4H3.5c-.83 0-1.5.67-1.5 1.5s.67 1.5 1.5 1.5h17c.83 0 1.5-.67 1.5-1.5s-.67-1.5-1.5-1.5zM3.5 16h17c.83 0 1.5-.67 1.5-1.5S21.33 13 20.5 13H3.5c-.83 0-1.5.67-1.5 1.5s.67 1.5 1.5 1.5z"/>
                    </svg>
                 Komunitas
                </li>
                <li>
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="1em" height="1em" fill="currentColor">
                        <path d="M20 2H4c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 18H4V4h16v16zM6 14h4v-4H6v4zm8 0h4v-4h-4v4z"/>
                    </svg>
                    Blog
                </li>
            </ul>
        </div>

        <div class="section">
            <h2>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="1em" height="1em" fill="currentColor">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zM10 10v4h4v-4h-4zm2-4c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/>
                </svg>
                Tentang Kami
            </h2>
            <ul>
                <li>
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="1em" height="1em" fill="currentColor">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zM10 10v4h4v-4h-4zm2-4c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/>
                    </svg>
                    Tentang Note Farid
                </li>
                <li>
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="1em" height="1em" fill="currentColor">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zM9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/>
                    </svg>
                    Identitas Brand
                </li>
                <li>
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="1em" height="1em" fill="currentColor">
                        <path d="M20 15.5c-1.66 0-3.17-.67-4.22-1.78L12 12.5 7.78 13.72C6.73 14.83 5.22 15.5 3.5 15.5V5c0-1.1.9-2 2-2h15c1.1 0 2 .9 2 2v10.5c-1.72 0-3.23-.67-4.28-1.78L16 12.5l4.22-1.22C20.27 10.67 21.78 10 23.5 10V15.5c-1.72 0-3.23.67-4.28 1.78L16 17.5l-4.22-1.22C10.73 15.67 9.22 15 7.5 15V5h1v10.5c1.66 0 3.17.67 4.22 1.78L12 12.5l4.22 1.22C17.27 11.67 18.78 11 20.5 11V5h1v10.5c1.72 0 3.23.67 4.28 1.78L16 17.5l-4.22 1.22C10.73 15.67 9.22 15 7.5 15V15.5z"/>
                    </svg>
                    Hubungi Kami
                </li>
                <li>
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="1em" height="1em" fill="currentColor">
                        <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14h-2v-2h2v2zm2-4h-4V6h4v6z"/>
                    </svg>
                    Aturan Penggunaan
                </li>
                <li>
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="1em" height="1em" fill="currentColor">
                        <path d="M12 4a4 4 0 0 1 4 4 4 4 0 0 1-4 4 4 4 0 0 1-4-4 4 4 0 0 1 4-4m0 10c4.42 0 8 1.79 8 4v2H4v-2c0-2.21 3.58-4 8-4z"/>
                    </svg>
                    Karir
                </li>
            </ul>
        </div>
  <button onclick="logout()" style="margin-top: 1rem;">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="1em" height="1em" fill="currentColor">
                <path d="M10.09 15.59L11.5 17l5-5-5-5-1.41 1.41L10.09 13H3v2h7.09zM21 3h-6v2h4v16h-4v2h6c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2z"/>
            </svg>
            Keluar
        </button>
    </div>
</div>
   
   
   
	
	
<div id="notificationIcon" style="position: relative; margin-left: 15px; cursor: pointer;">
    üîî
    <span id="notificationCount" style="...">0</span>
</div>

<div id="notificationPopup" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); display: none; z-index: 1000;">
    <div style="background-color: white; width: 90%; max-width: 500px; border-radius: 8px; margin: 50px auto; box-shadow: 0 2px 10px rgba(0,0,0,0.1); position: relative;">
        <div style="padding: 10px; border-bottom: 1px solid #eee; font-weight: bold; display: flex; justify-content: space-between; align-items: center;">
            <span style="font-size: 1.2em;">Info Pengumuman</span>
            <button id="closeNotificationPopup" style="border: none; background: none; font-size: 1.5em; cursor: pointer; color: #888;">&times;</button>
        </div>
        <ul id="notificationListItems" style="list-style: none; padding: 0; margin: 0;">
            <li style="padding: 15px; border-bottom: 1px solid #eee;">Tidak ada notifikasi baru</li>
        </ul>
        <div id="notificationFullContent" style="padding: 15px; display: none; border-top: 1px solid #eee;">
            </div>
        <div style="padding: 10px; text-align: center;">
            <button id="markAllRead" style="...">Tandai Semua Sudah Dibaca</button>
        </div>
    </div>
</div>



    <div class="topic-filter">
        <button class="topic-button active" data-topic="semua">Semua</button>
    </div>

    <div id="noteList"></div>
    <div id="popup" class="popup">Catatan berhasil disimpan!</div>
	
	<div class="activity-filter" style="margin-bottom: 10px; text-align: right;">
    <label for="activityYear" style="font-size: 12px; margin-right: 5px;">Tahun:</label>
    <select id="activityYear" style="padding: 5px; border-radius: 5px; border: 1px solid #ccc; font-size: 12px;">
        </select>
</div>

<div class="activity-table-container">
    </div>


 
    
	
	
<div id="guidePopup" class="guide-popup">
¬† ¬† ¬† ¬† <h3>Panduan Topik</h3>
¬† ¬† ¬† ¬† <div id="guideContent">
¬† ¬† ¬† ¬† ¬† ¬† <p id="guideText"></p>
¬† ¬† ¬† ¬† ¬† ¬† <p><a id="learnMoreLink" href="#" target="_blank">Pelajari Lebih Lanjut</a></p>
¬† ¬† ¬† ¬† </div>
¬† ¬† ¬† ¬† <button id="closeGuideBtn">Tutup</button>
¬† ¬† </div>
	

    <div id="overlay" class="overlay"></div>
	<div class="modal-overlay" id="termsModal">
  <div class="modal-content">
    <button class="close-btn" id="closeTermsModal">&times;</button>
    <div style="background-color: #E0F7FA; padding: 15px; border-radius: 8px; margin-bottom: 10px; text-align: left;">
      <div style="display: flex; align-items: center; margin-bottom: 5px;">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: 20px; height: 20px; margin-right: 8px;"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline></svg>
        <h2 style="font-size: 1.2em; margin: 0;">Ketentuan</h2>
      </div>
      <ol style="padding-left: 20px; margin-top: 5px;">
        <li>Pengguna diharapkan menggunakan platform ini, untuk tujuan catatan yang positif dan efektif..</li>
        <li style="background-color: #FFF9C4; padding: 10px; border-radius: 6px; margin-top: 8px; list-style: none;">2. Pengembang bertanggung jawab atas kesalahan pribadi pengguna yg disengaja/ga sengaja</li>
        <li style="background-color: #FFD54F; padding: 10px; border-radius: 6px; margin-top: 8px; list-style: none;">3. ...</li>
        <li style="background-color: #FFAB91; padding: 10px; border-radius: 6px; margin-top: 8px; list-style: none;">4. ...</li>
      </ol>
    </div>
    <div style="background-color: #FCE4EC; padding: 10px; border-radius: 6px; margin-bottom: 10px; text-align: left; font-size: 0.9em;">
      <span style="color: #E91E63;">: Halaman Ketentuan</span>
    </div>
    <div style="display: flex; align-items: center; font-size: 0.8em; color: #757575;">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: 16px; height: 16px; margin-right: 5px;"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
      <span>Terakhir diperbarui: 28 April 2025 Jam 21.30</span>
    </div>
  </div>
</div>

<div class="info-popup" id="info-popup">
    <div class="info-popup-content" id="info-popup-text">
        <button class="info-close-btn" onclick="closeInfoPopup()">√ó</button>
        </div>
</div>
<div class="info-card info-ketentuan" data-type="ketentuan">
    <div class="info-icon">üìú</div>
    <h3>Ketentuan</h3>
    <svg class="info-arrow-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
        <path d="M14 3h7v7h-2V6.41l-9.29 9.3-1.42-1.42L17.59 5H14V3z"/>
    </svg>
</div>
<div class="info-card info-tentang" data-type="tentang">
    <div class="info-icon">‚ÑπÔ∏è</div>
    <h3>Tentang Kami</h3>
    <svg class="info-arrow-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
        <path d="M14 3h7v7h-2V6.41l-9.29 9.3-1.42-1.42L17.59 5H14V3z"/>
    </svg>
</div>
<div class="info-card info-privasi" data-type="privasi">
    <div class="info-icon">üîí</div>
    <h3>Kebijakan Privasi</h3>
    <svg class="info-arrow-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
        <path d="M14 3h7v7h-2V6.41l-9.29 9.3-1.42-1.42L17.59 5H14V3z"/>
    </svg>
</div>


  <div class="user-card admin-border">
  <strong>Farid Ardiansyah</strong>
  <span class="badge admin">Admin</span>
</div>

<div class="user-card kontributor-border">
  <strong>Farid Ardiansyah</strong>
  <span class="badge kontributor">Kontributor</span>
</div>

<div class="user-card member-border">
  <strong>Farid Ardiansyah</strong>
  <span class="badge member">Member</span>
</div>

<!-- Popup untuk Role -->
<div id="role-popup-overlay" class="role-popup-overlay">
  <div class="role-popup-box">
    <span id="role-popup-badge" class="badge"></span>
    <p id="role-popup-desc"></p>
    <button class="close-btn">Tutup</button>
  </div>
</div>

<div id="activity-popup-overlay" class="role-popup-overlay">
    <div class="role-popup-box">
        <h3 id="activity-popup-title"></h3>
        <p id="activity-popup-details"></p>
        <button class="close-btn" id="close-activity-popup">Tutup</button>
    </div>
</div>


<div id="cookieExplanation" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <button class="close-btn" id="closeCookieExplanation">&times;</button>
		
		<li style="background-color: #7FFF00; padding: 10px; border-radius: 8px; margin-bottom: 8px;">
                <strong>Penjelasan Cookies website note farid.
            </li>
		
        <h3>Penjelasan Lebih Lanjut tentang Cookie</h3>
        <p>Cookie adalah file teks kecil yang ditempatkan di perangkat Anda untuk membantu situs web mengingat informasi tentang kunjungan Anda. Kami menggunakan cookie untuk:</p>
        <ul style="padding-left: 0; list-style: none;">
            <li style="background-color: #e0f7fa; padding: 10px; border-radius: 8px; margin-bottom: 8px;">
                <strong>1.</strong> Mengingat preferensi Anda (misalnya, bahasa, tema).
            </li>
            <li style="background-color: #fff9c4; padding: 10px; border-radius: 8px; margin-bottom: 8px;">
                <strong>2.</strong> Menganalisis bagaimana Anda menggunakan situs kami untuk meningkatkan pengalaman.
            </li>
            <li style="background-color: #ffcdd2; padding: 10px; border-radius: 8px; margin-bottom: 8px;">
                <strong>3.</strong> Mendukung fungsionalitas penting situs.
            </li>
			<li style="background-color: yellow; padding: 10px; border-radius: 8px; margin-bottom: 8px;">
                <strong>4.</strong> Dengan menyetujui, Anda mengizinkan kami menggunakan cookie sesuai dengan kebijakan kami.
            </li>
        </ul>
        <button id="acceptFromExplanation" style="background-color: #007bff; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;">Terima dan Tutup</button>
    </div>
</div>

<div class="activity-calendar"></div>


 <h2 class="text-center mt-10 mb-5 text-2xl font-semibold text-gray-800 margin-top: 30px;">
  Artikel Blog
</h2>
<div id="blogList" class="container mx-auto">
</div>
<div id="blogContentArea" class="container mx-auto bg-white rounded-lg shadow-md p-6">
  <h3 id="blogContentTitle" class="text-xl font-semibold text-gray-800 mb-4"></h3>
  <div id="blogContent" class="text-lg text-gray-700">
  </div>
  <button id="closeBlogContent" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded mt-4">Tutup Artikel</button>
</div>

<nav id="pagination" class="pagination">
  <ul class="pagination-list">
  </ul>
  <a href="#" class="pagination-next-link" onclick="nextPage()">Next Page</a>
</nav>


    <div id="filter-button-container">
        <button id="showQuoraTitles">Tampilkan Judul Quora</button>
    </div>

    <div id="blogList">
        </div>

    <div id="quoraPopup" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: white; padding: 20px; border: 1px solid #ccc; box-shadow: 0 4px 8px rgba(0,0,0,0.2); z-index: 10;">
        <h2>Judul dari Sumber: Quora</h2>
        <ul id="quoraTitleList">
            </ul>
        <button id="closeQuoraPopup">Tutup</button>
    </div>

<div class="blog-tags-container" style="display: flex; gap: 10px; margin-bottom: 20px;">
    <span class="blog-tag" data-tag="Elon Musk" style="background-color: green; color: white; padding: 5px 10px; border-radius: 15px; cursor: pointer;"></span>
    <span class="blog-tag" data-tag="Kolonisasi Mars" style="background-color: red; color: white; padding: 5px 10px; border-radius: 15px; cursor: pointer;"></span>
    <span class="blog-tag" data-tag="Planet Mars" style="background-color: yellow; padding: 5px 10px; border-radius: 15px; cursor: pointer; color: black;"></span>
    </div>

<div id="tagFilterPopup" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: white; padding: 20px; border: 1px solid #ccc; box-shadow: 0 4px 8px rgba(0,0,0,0.2); z-index: 10; width: 80%; max-width: 500px;">
    <h2 id="tagFilterTitle">Artikel dengan Tag:</h2>
    <ul id="tagArticleList" style="list-style: none; padding: 0;">
        </ul>
    <button id="closeTagFilter" style="margin-top: 15px; padding: 8px 15px; background-color: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer;">Tutup</button>
</div>




   

 







  
<script type="module">
¬† ¬† import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp, query, orderBy, deleteDoc, getDoc, writeBatch, setDoc, doc, updateDoc, where, getDocs, documentId, limit, increment, getCountFromServer,  arrayUnion, 
    arrayRemove } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-firestore.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword , signInWithPopup, signOut, onAuthStateChanged, GoogleAuthProvider,  setPersistence,
  browserLocalPersistence  } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-auth.js"; // Pastikan semua fungsi auth yang Anda butuhkan diimpor


    const firebaseConfig = {
        apiKey: "AIzaSyCYbxo8n1zn-Y3heCIn_PmrsK44_OrdEw4",
        authDomain: "noted-farid.netlify.app",
        projectId: "noted-a3498",
        storageBucket: "noted-a3498.appspot.com",
        messagingSenderId: "1077214793842",
        appId: "1:1077214793842:web:a70cc3643eceb53e3932eb",
        measurementId: "G-SENDQS5Y7K"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app); // Gunakan getAuth() untuk mendapatkan instance auth

¬† ¬† ¬† ¬† const notesRef = collection(db, "notes");
const activityRef = collection(db, "activities");


¬† ¬† ¬† ¬† const noteInput = document.getElementById("noteInput");
¬† ¬† ¬† ¬† const noteList = document.getElementById("noteList");
¬† ¬† ¬† ¬† const popup = document.getElementById("popup");
¬† ¬† ¬† ¬† const saveBtn = document.getElementById("saveBtn");
¬† ¬† ¬† ¬† const topicFilter = document.querySelector(".topic-filter");
¬† ¬† ¬† ¬† const guidePopup = document.getElementById("guidePopup");
¬† ¬† ¬† ¬† const guideText = document.getElementById("guideText");
¬† ¬† ¬† ¬† const guideLink = document.getElementById("guideLink");
¬† ¬† ¬† ¬† const closeGuideBtn = document.getElementById("closeGuideBtn");
const voiceInputBtn = document.getElementById("voiceInputBtn"); // Tetap gunakan tombol visual sebagai indikator/kontrol
const activityYearSelect = document.getElementById("activityYear");
const activityCalendarContainer = document.querySelector(".activity-calendar");
¬† ¬† ¬† ¬† const overlay = document.getElementById("overlay");
¬† ¬† ¬† ¬† let currentFilter = "semua";
		let recognition; // Variabel untuk SpeechRecognition
		let isListening = false; // Status apakah sedang mendengarkan
		let finalTranscript = ''; // Untuk menyimpan transkripsi final
		let currentYear = new Date().getFullYear();
		let topics = new Set(); // Initialize the topics Set
let activitiesData = [];

		 
	
		
		  // Cek apakah SpeechRecognition API tersedia di browser
    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
        recognition = new (window.webkitSpeechRecognition || window.SpeechRecognition)();
        recognition.continuous = false; // Hentikan setelah satu ucapan
        recognition.interimResults = false;
        recognition.lang = 'id-ID';

        recognition.onresult = function(event) {
            const transcript = event.results[0][0].transcript.trim();
            noteInput.value = transcript;
            finalTranscript = transcript; // Simpan transkripsi final
            stopListening(); // Berhenti otomatis
            addNoteFromVoice(); // Simpan otomatis ke Firebase
        };

        recognition.onerror = function(event) {
            console.error('Speech recognition error:', event);
            alert('Terjadi kesalahan pada fitur suara. Pastikan mikrofon Anda berfungsi.');
            isListening = false;
            updateVoiceButtonUI();
        };

        recognition.onend = function() {
            console.log('Speech recognition ended.');
            isListening = false;
            updateVoiceButtonUI();
        };
    } else {
        console.log('SpeechRecognition API tidak didukung di browser ini.');
        if (voiceInputBtn) {
            voiceInputBtn.style.display = 'none';
        }
    }

    function startListening() {
        if (recognition && !isListening) {
            try {
                recognition.start();
                isListening = true;
                updateVoiceButtonUI();
                console.log('Listening started.');
            } catch (error) {
                console.error('Error starting speech recognition:', error);
                alert('Tidak dapat memulai fitur suara. Pastikan izin mikrofon telah diberikan.');
                isListening = false;
                updateVoiceButtonUI();
            }
        }
    }

    function stopListening() {
        if (recognition && isListening) {
            recognition.stop();
            console.log('Listening stopped.');
            isListening = false;
            updateVoiceButtonUI();
        }
    }

    function updateVoiceButtonUI() {
        if (voiceInputBtn) {
            voiceInputBtn.classList.toggle('active', isListening);
            // Tambahkan logika perubahan ikon/gaya jika diperlukan
        }
    }

    function addNoteFromVoice() {
        const text = finalTranscript.trim();
        if (!text) return;

        const topic = categorizeNote(text); // Asumsikan kamu punya fungsi ini
        addNoteToFirebase(text, topic); // Pastikan fungsi ini bekerja sesuai kebutuhan
        finalTranscript = ''; // Reset untuk transkripsi selanjutnya
    }

    // Tambahkan event listener pada tombol
    if (voiceInputBtn) {
        voiceInputBtn.addEventListener('click', () => {
            if (!isListening) {
                startListening();
            } else {
                stopListening();
            }
        });
    }


document.addEventListener('DOMContentLoaded', () => {
    // DOM Elements
    const loginForm = document.getElementById('loginForm');
    const dashboardDiv = document.getElementById('dashboardDiv');
    const dashboardGreetingName = document.getElementById('dashboardGreetingName');
    const emailInput = document.getElementById('email');
    const passwordInput = document.getElementById('password');
    const errorMessage = document.getElementById('errorMessage');
    const showSavedNotesBtn = document.getElementById("showSavedNotesBtn");
    const savedNotesModal = document.getElementById("savedNotesModal");
    const savedNotesContainer = document.getElementById("savedNotesContainer");
    const topicFilter = document.getElementById("topicFilter");
    const closeSavedNotesModalBtn = document.getElementById("closeSavedNotesModalBtn");
    const logoutButton = document.getElementById('logoutButton');
    const emailLoginButton = document.getElementById('emailLoginBtn');
    const emailSignupButton = document.getElementById('emailSignupBtn');
    const anonymousLoginBtn = document.getElementById('anonymousLoginBtn');
    const messageInput = document.getElementById('messageInput');
    const sendMessageBtn = document.getElementById('sendMessageBtn');
    const messageBox = document.getElementById('messageBox');
    const contactsList = document.getElementById('contactsList');
    const currentChatInfo = document.getElementById('currentChatInfo');
    const currentChatWithSpan = document.getElementById('currentChatWith');
    const profileSection = document.getElementById('profileSection');
    const profileName = document.getElementById('profileName');
    const profileBio = document.getElementById('profileBio');
    const profileLastUpdated = document.getElementById('profileLastUpdated');
    const editProfileBtn = document.getElementById('editProfileBtn');
    const profileModal = document.getElementById('profileModal');
    const profileNameInput = document.getElementById('profileNameInput');
    const profileBioInput = document.getElementById('profileBioInput');
    const saveProfileBtn = document.getElementById('saveProfileBtn');
    const closeProfileModal = document.getElementById('closeProfileModal');
    const newMessageBadge = document.getElementById('newMessageBadge');
	const unreadCounts = {};



    // State variables
    let unsubscribeNotes;
    let topics = new Set();
    let currentChatWith = null;
    let currentRoomId = null;
    let unsubscribeMessages = null;
    let unsubscribeContacts = null;
	 let userProfile = null;
    let unsubscribeUserProfile = null;
    let unsubscribeStatuses = null;
	let unreadMessagesCount = 0;
    let stickerPickerVisible = false;
	let notificationTimeout;
let lastNotificationTime = 0;
let savedMessagesModal = null;
let closeModalBtn = null;
let currentChatPartnerId = null; // Ini penting untuk mengidentifikasi chat yang sedang dibuka
let currentUserId = null; // Anda perlu mendapatkan ID pengguna yang sedang login
let selectedUsersForGroup = [];
let currentGroupId = null;
let currentGroupData = null;
let unsubscribeGroups = null;
let unsubscribeGroupMessages = null
let currentProfileUserId = null; // ID pengguna yang sedang dilihat profilnya
let unsubscribeFollowers = null;
let unsubscribeFollowing = null;
let unsubscribeFollowStatus = null;
let currentMemberId = null; // ID anggota grup yang sedang dilihat
let selectedUsersToAddForGroup = [];



    // --- Helper function untuk menampilkan/menyembunyikan elemen dengan animasi ---
    function animateTransition(elementToShow, elementToHide, initialDelay = 0, hideDelay = 500) {
        if (elementToHide && !elementToHide.classList.contains("hidden")) {
            elementToHide.classList.remove("slide-in");
            elementToHide.classList.add("slide-out");
            setTimeout(() => {
                elementToHide.classList.add("hidden");
                elementToHide.classList.remove("slide-out");
                if (elementToShow) {
                    elementToShow.classList.remove("hidden");
                    elementToShow.classList.add("slide-in");
                }
            }, hideDelay);
        } else if (elementToShow && elementToShow.classList.contains("hidden")) {
            setTimeout(() => {
                elementToShow.classList.remove("hidden");
                elementToShow.classList.add("slide-in");
            }, initialDelay);
        }
    }

    // --- Success Message Popup ---
    function showSuccessMessage(message) {
        let popup = document.getElementById("success-popup") || createSuccessPopup();
        popup.textContent = message;
        popup.classList.add("show");
        setTimeout(() => popup.classList.remove("show"), 3000);
    }

    function createSuccessPopup() {
        const popup = document.createElement("div");
        popup.id = "success-popup";
        popup.className = "popup";
        popup.style.cssText = `
            position: fixed; top: 20px; right: 20px;
            background-color: #10b981; color: white;
            padding: 14px 20px; border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            font-weight: 500; opacity: 0; pointer-events: none;
            transition: all 0.4s ease; z-index: 1000;
        `;
        document.body.appendChild(popup);
        return popup;
    }




 const provider = new GoogleAuthProvider();
provider.setCustomParameters({ prompt: "select_account" });

document.getElementById("googleLoginBtn").addEventListener("click", () => {
  signInWithPopup(auth, provider)
    .then((result) => {
      const user = result.user;
      alert("Selamat datang, " + user.displayName);
    })
    .catch((error) => {
      console.error(error);
    });
});
	
	

 async function updateUIOnLoginSuccess(user) {
    const displayName = user.displayName || (user.isAnonymous ? "Guest" : (user.email ? user.email.split("@")[0] : "User"));
    
    // Hide login form and show dashboard
    if (loginForm) loginForm.classList.add("hidden");
    if (dashboardDiv) {
        dashboardDiv.classList.remove("hidden");
        dashboardDiv.classList.add("slide-in");
    }
    
    // Update UI greeting
    if (document.getElementById('userGreeting')) {
        document.getElementById('userGreeting').textContent = `Welcome, ${displayName}!`;
    }
    
    try {
        // 1. Setup saved notes listener
        setupSavedNotesListener();
        
        // 2. Load user profile
        await loadUserProfile();
		
		// 3. Load contacts and unread counts
        const contacts = await fetchContacts();
        displayContacts(contacts);
        await loadAndUpdateUnreadCounts();
        
        // 4. Initialize chat features
        initializeChat();
        monitorContactStatuses(); // Pantau status kontak
        
        
        // 5. Sync local notes if needed
        try {
            await syncLocalNotesWithFirestore(user.uid);
        } catch (syncError) {
            console.error("Note sync error:", syncError);
        }
        
        // 6. Setup profile editing
        setupProfileEdit();
		
		// 7. Setup periodic unread count updates
        setInterval(loadAndUpdateUnreadCounts, 30000); // Update setiap 30 
		
		   // Tunggu hingga DOM siap sebelum inisialisasi group chat
        if (document.readyState === 'loading') {
            await new Promise(resolve => {
                document.addEventListener('DOMContentLoaded', resolve);
            });
        }
        
        initializeGroupChat();
        loadUserGroups();
		 initializeFollowSystem();
        
    } catch (error) {
        console.error("Error during login initialization:", error);
	
        
        // Fallback: Try to load notes from local storage if Firestore fails
        try {
            const backupNotes = localStorage.getItem(`savedNotes_${user.uid}`);
            if (backupNotes) {
                const parsedNotes = JSON.parse(backupNotes);
                displaySavedNotesPopup(parsedNotes.map(note => ({
                    id: note.id,
                    data: () => note
                })));
                showSuccessMessage("Loaded notes from local backup");
            }
        } catch (localError) {
            console.error("Error loading local notes:", localError);
        }
    }
    
    // Additional initialization
	    const messageInput = getElementSafe('messageInput');
    if (messageInput) {
        setupEmojiPicker();
    }
}


async function syncLocalNotesWithFirestore(userId) {
    try {
        // Implementasi fungsi sync notes dari local storage ke Firestore
        const localNotes = localStorage.getItem(`savedNotes_${userId}`);
        if (localNotes) {
            const parsedNotes = JSON.parse(localNotes);
            // Sync ke Firestore
            for (const note of parsedNotes) {
                const noteRef = doc(db, "users", userId, "notes", note.id);
                await setDoc(noteRef, note, { merge: true });
            }
            // Hapus dari local storage setelah sync
            localStorage.removeItem(`savedNotes_${userId}`);
        }
    } catch (error) {
        console.error("Error syncing local notes:", error);
    }
}
	
	
    // --- Email/Password Signup Function ---
    async function signupWithEmail() {
        const email = emailInput.value;
        const password = passwordInput.value;

        if (!email || !password) {
            errorMessage.textContent = "Email dan password tidak boleh kosong.";
            errorMessage.classList.remove("hidden");
            return;
        }

        // Pastikan modul Firebase Auth tersedia
        if (typeof auth === 'undefined' || typeof createUserWithEmailAndPassword === 'undefined') {
            console.error("Firebase Auth modules (createUserWithEmailAndPassword) tidak dimuat atau tidak terdefinisi.");
            errorMessage.textContent = "Error: Fitur pendaftaran tidak tersedia. Pastikan Firebase Auth sudah diinisialisasi.";
            errorMessage.classList.remove("hidden");
            return;
        }

        try {
            // Nonaktifkan tombol dan tampilkan pesan loading
            if (emailSignupButton) {
                emailSignupButton.disabled = true;
                emailSignupButton.textContent = "Mendaftar...";
            }
            if (emailLoginButton) emailLoginButton.disabled = true;
            if (anonymousLoginBtn) anonymousLoginBtn.disabled = true; // Disable anonymous button too

            const userCredential = await createUserWithEmailAndPassword(auth, email, password);
            updateUIOnLoginSuccess(userCredential.user);
            showSuccessMessage("Pendaftaran berhasil! Selamat datang.");
        } catch (error) {
            console.error("Email signup error:", error);
            let userMessage = "Pendaftaran gagal. Silakan coba lagi.";
            if (error.code === 'auth/email-already-in-use') {
                userMessage = "Email sudah terdaftar. Silakan login atau gunakan email lain.";
            } else if (error.code === 'auth/invalid-email') {
                userMessage = "Format email tidak valid.";
            } else if (error.code === 'auth/weak-password') {
                userMessage = "Kata sandi terlalu lemah (minimal 6 karakter).";
            }
            errorMessage.textContent = `Pendaftaran gagal: ${userMessage}`;
            errorMessage.classList.remove("hidden");
        } finally {
            // Aktifkan kembali tombol
            if (emailSignupButton) {
                emailSignupButton.disabled = false;
                emailSignupButton.textContent = "Daftar";
            }
            if (emailLoginButton) emailLoginButton.disabled = false;
            if (anonymousLoginBtn) anonymousLoginBtn.disabled = false; // Re-enable anonymous button
        }
    }

    // --- Email/Password Login Function ---
    async function loginWithEmail() {
        const email = emailInput.value;
        const password = passwordInput.value;

        if (!email || !password) {
            errorMessage.textContent = "Email dan password tidak boleh kosong.";
            errorMessage.classList.remove("hidden");
            return;
        }

        // Pastikan modul Firebase Auth tersedia
        if (typeof auth === 'undefined' || typeof signInWithEmailAndPassword === 'undefined') {
            console.error("Firebase Auth modules (signInWithEmailAndPassword) tidak dimuat atau tidak terdefinisi.");
            errorMessage.textContent = "Error: Fitur login tidak tersedia. Pastikan Firebase Auth sudah diinisialisasi.";
            errorMessage.classList.remove("hidden");
            return;
        }

        try {
            // Nonaktifkan tombol dan tampilkan pesan loading
            if (emailLoginButton) {
                emailLoginButton.disabled = true;
                emailLoginButton.textContent = "Masuk...";
            }
            if (emailSignupButton) emailSignupButton.disabled = true;
            if (anonymousLoginBtn) anonymousLoginBtn.disabled = true; // Disable anonymous button

            const userCredential = await signInWithEmailAndPassword(auth, email, password);
            updateUIOnLoginSuccess(userCredential.user);
            showSuccessMessage("Login berhasil! Selamat datang kembali.");
        } catch (error) {
            console.error("Email login error:", error);
            let userMessage = "Login gagal. Silakan coba lagi.";
            if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                userMessage = "Email atau kata sandi salah.";
            } else if (error.code === 'auth/invalid-email') {
                userMessage = "Format email tidak valid.";
            }
            errorMessage.textContent = `Login gagal: ${userMessage}`;
            errorMessage.classList.remove("hidden");
        } finally {
            // Aktifkan kembali tombol
            if (emailLoginButton) {
                emailLoginButton.disabled = false;
                emailLoginButton.textContent = "Login";
            }
            if (emailSignupButton) emailSignupButton.disabled = false;
            if (anonymousLoginBtn) anonymousLoginBtn.disabled = false; // Re-enable anonymous button
        }
    }

    // --- Anonymous Sign-in Function (NEW) ---
    async function signInAnonymouslyFirebase() {
        // Pastikan modul Firebase Auth tersedia
        if (typeof auth === 'undefined' || typeof signInAnonymously === 'undefined') {
            console.error("Firebase Auth module (signInAnonymously) tidak dimuat atau tidak terdefinisi.");
            errorMessage.textContent = "Error: Fitur login anonim tidak tersedia. Pastikan Firebase Auth sudah diinisialisasi.";
            errorMessage.classList.remove("hidden");
            return;
        }

        try {
            // Nonaktifkan tombol dan tampilkan pesan loading
            if (anonymousLoginBtn) {
                anonymousLoginBtn.disabled = true;
                anonymousLoginBtn.textContent = "Masuk...";
            }
            if (emailLoginButton) emailLoginButton.disabled = true;
            if (emailSignupButton) emailSignupButton.disabled = true;

            const userCredential = await signInAnonymously(auth);
            updateUIOnLoginSuccess(userCredential.user);
            showSuccessMessage("Berhasil masuk sebagai tamu.");
        } catch (error) {
            console.error("Anonymous sign-in error:", error);
            errorMessage.textContent = `Gagal masuk sebagai tamu: ${error.message}`;
            errorMessage.classList.remove("hidden");
        } finally {
            // Aktifkan kembali tombol
            if (anonymousLoginBtn) {
                anonymousLoginBtn.disabled = false;
                anonymousLoginBtn.textContent = "Masuk Sebagai Tamu";
            }
            if (emailLoginButton) emailLoginButton.disabled = false;
            if (emailSignupButton) emailSignupButton.disabled = false;
        }
    }

    // --- Fungsi Logout ---
    function logout() {
        // Pastikan modul Firebase Auth tersedia
        if (typeof auth === 'undefined' || typeof signOut === 'undefined') {
            console.error("Firebase Auth signOut module tidak dimuat atau tidak terdefinisi.");
            showSuccessMessage("Error: Fitur logout tidak tersedia.");
            return;
        }
        signOut(auth)
            .then(() => {
                const greetingDiv = document.getElementById('greetingDiv'); // Get greetingDiv here
                if (greetingDiv && loginForm) { // Animate transition from greetingDiv to loginForm
                    animateTransition(loginForm, greetingDiv); 
                    // Reset input fields after logout
                    if (emailInput) emailInput.value = "";
                    if (passwordInput) passwordInput.value = "";
                }
                if (errorMessage) errorMessage.classList.add("hidden"); // Sembunyikan pesan error
                showSuccessMessage("Anda telah berhasil logout.");

                // Hentikan listener catatan saat logout
                if (unsubscribeNotes) {
                    unsubscribeNotes();
                    unsubscribeNotes = null;
                    console.log("Listener catatan sebelumnya telah dihentikan.");
                }
            })
            .catch((error) => {
                console.error("Logout error:", error);
                if (errorMessage) {
                    errorMessage.textContent = `Logout gagal: ${error.message}`;
                    errorMessage.classList.remove("hidden");
                }
            });
    }

	
  // --- Toggle Save Note (Operasi Firestore) ---
    async function toggleSaveNote(noteId, isCurrentlySaved, noteData) {
        const userId = auth.currentUser?.uid;
        if (!userId) {
            showSuccessMessage("Anda perlu login untuk menyimpan catatan.");
            return;
        }
        // Pastikan modul Firestore tersedia
        if (typeof db === 'undefined' || typeof doc === 'undefined' || typeof setDoc === 'undefined' || typeof updateDoc === 'undefined' || typeof serverTimestamp === 'undefined') {
            console.error("Firestore modules tidak dimuat untuk menyimpan catatan.");
            showSuccessMessage("Error: Database tidak tersedia.");
            return;
        }

        const noteRef = doc(db, "users", userId, "notes", noteId);

        try {
            if (!isCurrentlySaved) {
                // Pastikan noteData memiliki properti yang diperlukan dan merge true
                await setDoc(noteRef, { ...noteData, isSaved: true, savedAt: serverTimestamp() }, { merge: true });
                showSuccessMessage("Catatan disimpan!");
            } else {
                await updateDoc(noteRef, { isSaved: false });
                showSuccessMessage("Catatan dibatalkan penyimpanannya.");
            }
        } catch (err) {
            console.error("Toggle save note error:", err);
            showSuccessMessage("Gagal mengubah status simpan catatan.");
        }
    }


// Expose toggleSaveNote globally right after its definition
window.toggleSaveNote = toggleSaveNote;
	
	
	
	
	
	

    // --- Filter Catatan berdasarkan Topik ---
    function filterNotesByTopic(selectedTopic) {
        if (!savedNotesContainer) return;
        const notes = savedNotesContainer.querySelectorAll(".note");
        notes.forEach((note) => {
            const noteTopic = note.dataset.topic || "";
            // Perbandingan topik case-insensitive
            note.style.display = (selectedTopic === "all" || selectedTopic === "" || noteTopic === selectedTopic.toLowerCase())
                ? "block"
                : "none";
        });
    }

   
   
    // --- Tampilkan Catatan Tersimpan di Popup ---
    function displaySavedNotesPopup(savedNotes = []) {
        if (!savedNotesModal || !savedNotesContainer || !topicFilter) {
            console.warn("Satu atau lebih elemen modal tidak ditemukan. Tidak dapat menampilkan popup catatan tersimpan.");
            return;
        }

        savedNotesContainer.innerHTML = ""; // Clear the container before adding new notes
        topics.clear(); // Clear the topic list (assuming 'topics' is a Set or similar global/scoped variable)

        if (savedNotes.length === 0) {
            savedNotesContainer.innerHTML = "<p style='text-align: center; padding: 20px; color: #666;'>Belum ada catatan yang tersimpan.</p>";
            topicFilter.value = "all";
            topicFilter.innerHTML = '<option value="all">Semua Topik</option>';
            // If no notes, ensure the filter reflects this.
        } else {
            savedNotes.forEach((docSnap) => {
                const data = docSnap.data();

                // Prioritize content, then text if title/content are not explicitly set
                // For 'susah' type of input, 'content' is the primary field.
                const title = data.title || 'Tidak Ada Judul'; // Default title if not explicitly saved
                const content = data.content || data.text || 'Tidak Ada Konten'; // Use data.content or data.text (if raw input is saved as 'text')

                // Ensure topic defaults to 'lainlain' as shown in your design
                const topic = (data.topic || data.temaTopik || "lainlain").toLowerCase();

                // Only add unique topics to the filter, excluding the default 'lainlain' if it's not a specific topic
                if (topic && topic !== "lainlain") {
                    topics.add(topic);
                }

                const noteEl = document.createElement('div');
                noteEl.classList.add("note");
                noteEl.dataset.topic = topic; // Store topic in dataset for filtering

                // Prepare data for the toggleSaveNote function
                const noteDataForToggle = JSON.stringify({
                    title: title,
                    content: content,
                    topic: topic,
                    id: docSnap.id
                }).replace(/"/g, '&quot;');


                noteEl.innerHTML = `
                    <h3>${title}</h3>
                    <p>${content}</p>
                    <p style="font-size: 0.9em; color: #666;">Topik: ${topic.charAt(0).toUpperCase() + topic.slice(1)}</p>
                    <button class="save-toggle-btn" onclick="toggleSaveNote('${docSnap.id}', true, ${noteDataForToggle})">Batalkan Simpan</button>
                `;
                savedNotesContainer.appendChild(noteEl);
            });

            // Repopulate topic filter
            topicFilter.innerHTML = '<option value="all">Semua Topik</option>';
            Array.from(topics).sort().forEach((topic) => {
                const option = document.createElement("option");
                option.value = topic;
                option.textContent = topic.charAt(0).toUpperCase() + topic.slice(1);
                topicFilter.appendChild(option);
            });

            topicFilter.value = "all"; // Reset to "all" every time notes are updated
            filterNotesByTopic("all"); // Display all notes by default
        }

        savedNotesModal.style.display = "flex"; // Show the modal

        // Ensure event listener for topic filter is only added once
        function topicFilterChangeListener() {
            filterNotesByTopic(topicFilter.value);
        }
        topicFilter.removeEventListener("change", topicFilterChangeListener);
        topicFilter.addEventListener("change", topicFilterChangeListener);
    }

   
   
   
   
   
   
   



    // --- Setup Real-time Listener untuk Catatan Tersimpan ---
    function setupSavedNotesListener() {
        if (!auth.currentUser) {
            console.log("Tidak ada pengguna yang login, tidak dapat mengatur listener catatan.");
            return;
        }
        // Pastikan modul Firestore tersedia
        if (typeof db === 'undefined' || typeof collection === 'undefined' || typeof query === 'undefined' || typeof where === 'undefined' || typeof onSnapshot === 'undefined') {
            console.error("Firestore real-time listener modules tidak dimuat.");
            showSuccessMessage("Error: Listener catatan tidak tersedia.");
            return;
        }

        const userId = auth.currentUser.uid;
        const q = query(
            collection(db, "users", userId, "notes"),
            where("isSaved", "==", true)
        );

        // Hentikan listener yang ada sebelum membuat yang baru
        if (unsubscribeNotes) {
            unsubscribeNotes();
            console.log("Listener catatan sebelumnya telah dihentikan.");
        }

        unsubscribeNotes = onSnapshot(q, (snapshot) => {
            const savedNotes = snapshot.docs;
            displaySavedNotesPopup(savedNotes); // Perbarui tampilan catatan
        }, (error) => {
            console.error("Error fetching saved notes:", error);
            showSuccessMessage("Gagal memuat catatan tersimpan.");
        });
        console.log("Listener catatan tersimpan telah diatur.");
    }




function onAuthStateChangedHandler() {
    onAuthStateChanged(auth, async (user) => {
        const greetingDiv = document.getElementById('greetingDiv');

        if (user) {
            // Pengguna masuk
            updateUIOnLoginSuccess(user);

            await updateDoc(doc(db, "users", user.uid), {
                status: "online",
                lastSeen: null
            });

            // Initialize all features
            initializeFollowSystem();
            initializeGroupChat();
            monitorContactStatuses();
            updateUnreadCounts();
            setInterval(updateUnreadCounts, 30000);

        } else {
            // User logged out - update status to offline
            if (currentUserId) {
                await updateDoc(doc(db, "users", currentUserId), {
                    status: "offline",
                    lastSeen: serverTimestamp()
                });
            }

            // Clean up
            currentUserId = null;
            if (unsubscribeFollowers) unsubscribeFollowers();
            if (unsubscribeFollowing) unsubscribeFollowing();
            if (unsubscribeFollowStatus) unsubscribeFollowStatus();
            if (unsubscribeNotes) {
                unsubscribeNotes();
                unsubscribeNotes = null;
            }
            if (unsubscribeMessages) {
                unsubscribeMessages();
                unsubscribeMessages = null;
            }
            if (unsubscribeContacts) {
                unsubscribeContacts();
                unsubscribeContacts = null;
            }
            if (unsubscribeStatuses) {
                unsubscribeStatuses();
                unsubscribeStatuses = null;
            }

            // Reset UI
            const dashboardDiv = document.getElementById('dashboardDiv');
            if ((dashboardDiv && !dashboardDiv.classList.contains("hidden")) ||
                (greetingDiv && !greetingDiv.classList.contains("hidden"))) {
                const elementToHide = dashboardDiv && !dashboardDiv.classList.contains("hidden") ? dashboardDiv : greetingDiv;
                animateTransition(loginForm, elementToHide);
            } else if (loginForm) {
                loginForm.classList.remove("hidden");
            }

            // Reset input fields
            if (emailInput) emailInput.value = "";
            if (passwordInput) passwordInput.value = "";

            // Reset state chat
            currentChatWith = null;
            currentRoomId = null;

            // Disable input chat
            if (messageInput) messageInput.disabled = true;
            if (sendMessageBtn) sendMessageBtn.disabled = true;

            // Reset tampilan chat
            if (currentChatInfo) currentChatInfo.style.display = 'none';
            if (messageBox) messageBox.innerHTML = '<div>Pilih kontak untuk memulai percakapan</div>';
            if (contactsList) contactsList.innerHTML = '<div>Memuat daftar kontak...</div>';

            // Reset group chat state
            currentGroupId = null;
            currentGroupData = null;
            if (unsubscribeGroups) unsubscribeGroups();
            if (unsubscribeGroupMessages) unsubscribeGroupMessages();
        }
    }); // <- penutupan onAuthStateChanged
}

    // --- Penugasan Event Listener ---
    // Tombol login email
    if (emailLoginButton) {
        emailLoginButton.addEventListener('click', loginWithEmail);
    } else {
        console.warn("Elemen 'emailLoginBtn' tidak ditemukan di DOM. Tombol login email tidak akan berfungsi.");
    }

    // Tombol daftar email
    if (emailSignupButton) {
        emailSignupButton.addEventListener('click', signupWithEmail);
    } else {
        console.warn("Elemen 'emailSignupBtn' tidak ditemukan di DOM. Tombol daftar email tidak akan berfungsi.");
    }

    // New: Tombol login anonim
    if (anonymousLoginBtn) {
        anonymousLoginBtn.addEventListener('click', signInAnonymouslyFirebase);
    } else {
        console.warn("Elemen 'anonymousLoginBtn' tidak ditemukan di DOM. Tombol login anonim tidak akan berfungsi.");
    }

    // Tombol tampilkan catatan tersimpan
    if (showSavedNotesBtn) {
        showSavedNotesBtn.addEventListener('click', () => {
            if (auth && auth.currentUser) {
                // Karena setupSavedNotesListener sudah dipanggil di updateUIOnLoginSuccess,
                // kita hanya perlu menampilkan modal di sini.
                if (savedNotesModal) {
                    savedNotesModal.style.display = "flex";
                }
            } else {
                showSuccessMessage("Anda perlu login untuk melihat catatan tersimpan.");
            }
        });
    } else {
        console.warn("Elemen 'showSavedNotesBtn' tidak ditemukan di DOM. Tombol tampilkan catatan tidak akan berfungsi.");
    }

    // Tombol tutup modal catatan tersimpan
    if (closeSavedNotesModalBtn) {
        closeSavedNotesModalBtn.addEventListener('click', () => {
            if (savedNotesModal) savedNotesModal.style.display = "none";
            // Penting: Hentikan listener saat modal ditutup untuk mencegah kebocoran memori
            if (unsubscribeNotes) {
                unsubscribeNotes();
                unsubscribeNotes = null;
                console.log("Listener catatan telah dihentikan saat modal ditutup.");
            }
        });
    } else {
        console.warn("Elemen 'closeSavedNotesModalBtn' tidak ditemukan di DOM. Tombol tutup modal catatan tidak akan berfungsi.");
    }

    // Tombol logout
    if (logoutButton) {
        logoutButton.addEventListener('click', logout);
    } else {
        console.warn("Elemen 'logoutButton' tidak ditemukan di DOM. Tombol logout tidak akan berfungsi.");
    }

    // Tutup Modal saat Klik di Luar
    window.addEventListener("click", (event) => {
        if (savedNotesModal && event.target === savedNotesModal) {
            savedNotesModal.style.display = "none";
            // Penting: Hentikan listener saat modal ditutup dari luar
            if (unsubscribeNotes) {
                unsubscribeNotes();
                unsubscribeNotes = null;
                console.log("Listener catatan telah dihentikan saat modal ditutup dari luar.");
            }
        }
    });
	
	
	
	
    
    function showDesktopNotification(title, message) {
        if (!("Notification" in window)) {
            console.log("This browser does not support desktop notification");
            return;
        }
        
        if (Notification.permission === "granted") {
            new Notification(title, { body: message });
        } else if (Notification.permission !== "denied") {
            Notification.requestPermission().then(permission => {
                if (permission === "granted") {
                    new Notification(title, { body: message });
                }
            });
        }
    }
	
	
// Fungsi untuk menampilkan badge unread
function updateUnreadBadge(contactId, count) {
  const contactItem = document.querySelector(`.contact-item[data-uid="${contactId}"]`);
  if (!contactItem) return;
  
  // Hapus badge yang ada
  const existingBadge = contactItem.querySelector('.unread-badge');
  if (existingBadge) existingBadge.remove();
  
  // Tambahkan badge baru jika ada pesan belum dibaca
  if (count > 0) {
    const badge = document.createElement('span');
    badge.className = 'unread-badge';
    badge.textContent = count;
    
    const lastMessageDiv = contactItem.querySelector('.contact-last-message');
    if (lastMessageDiv) {
      lastMessageDiv.appendChild(badge);
    }
    
    // Tambahkan class has-unread untuk styling
    contactItem.classList.add('has-unread');
  } else {
    contactItem.classList.remove('has-unread');
  }
}

function displayMessageStatus(message, messageElement) {
    const statusDiv = document.createElement('div');
    statusDiv.className = 'message-status';

    if (message.readBy && Object.keys(message.readBy).length > 1) {
        // Pesan sudah dibaca (centang biru)
        statusDiv.textContent = '‚úì‚úì';
        statusDiv.classList.add('read');
    } else if (message.delivered) {
        // Pesan terkirim (centang hijau)
        statusDiv.textContent = '‚úì‚úì';
        statusDiv.classList.add('delivered');
    } else {
        // Pesan terkirim ke server (centang abu-abu)
        statusDiv.textContent = '‚úì';
        statusDiv.classList.add('sent');
    }

    messageElement.appendChild(statusDiv);
}

	
	async function loadAndDisplayContacts() {
    const user = auth.currentUser;
    if (!user) return;

    try {
        // Load all users except current user
        const usersSnapshot = await getDocs(collection(db, 'users'));
        
        // Load existing chat rooms
        const roomsQuery = query(
            collection(db, 'chat_rooms'),
            where('participants', 'array-contains', user.uid)
        );
        const roomsSnapshot = await getDocs(roomsQuery);
        
        // Process contacts
        usersSnapshot.forEach(async (userDoc) => {
            if (userDoc.id === user.uid) return;
            
            const contactData = userDoc.data();
            const contactId = userDoc.id;
            
            // Find existing chat room if any
            let roomId = null;
            roomsSnapshot.forEach(roomDoc => {
                const participants = roomDoc.data().participants;
                if (participants.includes(contactId)) {
                    roomId = roomDoc.id;
                }
            });
            
            // Update UI
            updateContactDisplay(contactId, contactData.name || contactData.email, false, 0, roomId);
        });
        
    } catch (error) {
        console.error("Error loading contacts:", error);
    }
}





function updateContactDisplay(contactId, contactName, hasUnreadMessages, unreadCount) {
    const contactsList = document.getElementById('contactsList');
    if (!contactsList) {
        console.error("contactsList element not found!");
        return;
    }

    let contactItem = document.querySelector(`.contact-item[data-id="${contactId}"]`);

    if (!contactItem) {
        // Jika contact-item untuk ID ini belum ada, buat yang baru
        contactItem = document.createElement('div');
        contactItem.classList.add('contact-item');
        contactItem.dataset.id = contactId; // Penting untuk mengidentifikasi item
        contactItem.addEventListener('click', () => {
            startChatWithUser(contactId, contactName);
            resetUnreadCount(contactId);
        });

        // Struktur HTML untuk contact-item, termasuk unread-count
        contactItem.innerHTML = `
            <div class="contact-avatar">
                ${contactName.charAt(0).toUpperCase()} </div>
            <div class="contact-info">
                <span class="contact-name">${contactName}</span>
                <span class="contact-last-message"></span> </div>
            <div class="unread-count" style="display: none;"></div> `;
        contactsList.prepend(contactItem); // Tambahkan ke daftar kontak
        console.log(`[updateContactDisplay] Created new contact item for ${contactName} (${contactId})`);
    } else {
        // Jika contact-item sudah ada, pastikan namanya tetap yang terbaru
        contactItem.querySelector('.contact-name').textContent = contactName;
    }

    // Kelola kelas 'has-unread' (untuk background-color yang berbeda)
    if (hasUnreadMessages) {
        contactItem.classList.add('has-unread');
    } else {
        contactItem.classList.remove('has-unread');
    }

    // Kelola tampilan angka notifikasi
    const unreadCountElement = contactItem.querySelector('.unread-count');
    if (unreadCountElement) { // Pastikan elemen unread-count ditemukan di dalam contact-item
        if (unreadCount > 0) {
            unreadCountElement.textContent = unreadCount;
            unreadCountElement.style.display = 'block'; // Tampilkan elemen
            console.log(`[updateContactDisplay] Displaying unread count ${unreadCount} for ${contactName}`);
        } else {
            unreadCountElement.textContent = ''; // Kosongkan teks
            unreadCountElement.style.display = 'none'; // Sembunyikan elemen
            console.log(`[updateContactDisplay] Hiding unread count for ${contactName}`);
        }
    } else {
        console.error(`[updateContactDisplay] Unread count element not found for contact ID: ${contactId}`);
    }
}

// poposs.txt - Tambahkan fungsi ini
function setupFirebaseListeners() {
    if (!currentUserId) {
        console.warn("Current User ID not set. Cannot set up Firebase listeners.");
        return;
    }

    // Listener untuk pesan pribadi yang diterima oleh currentUserId
    // Asumsi: Ada koleksi 'messages' di Firestore dengan dokumen pesan
    // yang memiliki 'senderId' dan 'receiverId'.
    firebase.firestore().collection('messages')
        .where('receiverId', '==', currentUserId) // Hanya dengarkan pesan yang ditujukan ke user ini
        .orderBy('timestamp', 'desc') // Urutkan jika perlu, tapi untuk added tidak terlalu penting
        .onSnapshot(snapshot => {
            snapshot.docChanges().forEach(change => {
                if (change.type === 'added') {
                    const message = change.doc.data();
                    const messageId = change.doc.id; // ID dokumen pesan
                    console.log("New message received:", message);

                    // PENTING: Cek apakah pesan ini dari pengirim yang BUKAN currentChatPartnerId
                    // Dan pastikan pesan ini belum ditandai sebagai 'read' jika Anda memiliki status 'read'
                    if (message.senderId !== currentChatPartnerId) {
                        console.log(`Message from ${message.senderId} (not current chat partner). Incrementing unread count.`);
                        incrementUnreadCount(message.senderId);
                    } else {
                        console.log(`Message from ${message.senderId} (current chat partner). Not incrementing unread count.`);
                        // Jika ini dari chat aktif, Anda mungkin ingin menandainya sebagai terbaca
                        // Contoh: update message status to read
                        // firebase.firestore().collection('messages').doc(messageId).update({ read: true });
                    }

                    // Tambahkan pesan ke area chat jika ini adalah chat aktif
                    if (message.senderId === currentChatPartnerId || message.receiverId === currentChatPartnerId) {
                        displayMessage(message); // Fungsi Anda untuk menampilkan pesan di chat area
                    }
                }
            });
        }, error => {
            console.error("Error listening to messages:", error);
        });

    // Tambahkan listener lain jika perlu, misal untuk update status online, dll.
}

// Panggil setupFirebaseListeners setelah currentUserId terisi
// Contoh di onAuthStateChanged listener di atas.




async function getUnreadCount(roomId, userId, senderId) {
    try {
        const messagesRef = collection(db, 'chat_rooms', roomId, 'messages');
        const unreadQuery = query(
            messagesRef,
            where('senderId', '==', senderId),
            where(`readBy.${userId}`, '==', false)
        );
        const unreadSnapshot = await getCountFromServer(unreadQuery);
        return unreadSnapshot.data().count;
    } catch (error) {
        console.error("Error getting unread count:", error);
        return 0;
    }
}



// Fungsi untuk memperbarui tampilan jumlah pesan yang belum dibaca
function updateUnreadMessageCount(contactId, count) {
    const contactItem = document.querySelector(`.contact-item[data-uid="${contactId}"]`);
    if (!contactItem) return;

    // Hapus counter yang ada jika ada
    let counter = contactItem.querySelector('.unread-message-count');
    if (counter) counter.remove();

    // Jika ada pesan yang belum dibaca, tambahkan counter baru
    if (count > 0) {
        counter = document.createElement('div');
        counter.className = 'unread-message-count';
        counter.textContent = count;
        contactItem.appendChild(counter);
        contactItem.classList.add('has-unread');
    } else {
        contactItem.classList.remove('has-unread');
    }
}



function updateContactUnreadCount(contactId, count) {
    const contactItem = document.querySelector(`.contact-item[data-uid="${contactId}"]`);
    if (!contactItem) return;

    let unreadCountElement = contactItem.querySelector('.unread-count');
    if (!unreadCountElement) {
        unreadCountElement = document.createElement('span');
        unreadCountElement.className = 'unread-count';
        contactItem.querySelector('.contact-info').appendChild(unreadCountElement);
    }

    if (count > 0) {
        unreadCountElement.textContent = count;
        unreadCountElement.style.display = 'inline-block';
        contactItem.classList.add('has-unread');
    } else {
        unreadCountElement.style.display = 'none';
        contactItem.classList.remove('has-unread');
    }
}


async function loadAndUpdateUnreadCounts() {
    const user = auth.currentUser;
    if (!user) return;

    try {
        // Dapatkan semua room chat dimana user berpartisipasi
        const roomsQuery = query(
            collection(db, 'chat_rooms'),
            where('participants', 'array-contains', user.uid)
        );
        const roomsSnapshot = await getDocs(roomsQuery);

        // Untuk setiap room, hitung pesan yang belum dibaca
        for (const roomDoc of roomsSnapshot.docs) {
            const roomData = roomDoc.data();
            const otherUserId = roomData.participants.find(id => id !== user.uid);
            
            if (otherUserId) {
                const unreadCount = await countUnreadMessages(roomDoc.id, user.uid);
                updateContactUnreadCount(otherUserId, unreadCount);
            }
        }
    } catch (error) {
        console.error("Error loading unread counts:", error);
    }
}


// Panggil fungsi ini secara berkala
setInterval(loadAndUpdateUnreadCounts, 30000); // Update setiap 30 detik




// Pastikan elemen tombol ada di DOM
const openSavedMessagesBtn = document.getElementById('openSavedMessagesBtn');
if (openSavedMessagesBtn) {
    // Tambahkan event listener untuk tombol
    openSavedMessagesBtn.addEventListener('click', () => {
        const user = auth.currentUser; // Pastikan Anda menggunakan Firebase Auth
        if (!user) {
            showSuccessMessage("Anda perlu login untuk melihat pesan tersimpan.");
            return;
        }
        showSavedMessages(); // Panggil fungsi untuk menampilkan pesan tersimpan
    });
}


async function countUnreadMessages(roomId, userId) {
    try {
        const messagesRef = collection(db, 'chat_rooms', roomId, 'messages');
        const q = query(
            messagesRef,
            where('senderId', '!=', userId) // Only messages from others
        );
        const snapshot = await getDocs(q); // Use getDocs to fetch documents
        let unreadCount = 0;
        snapshot.forEach(doc => {
            const message = doc.data();
            if (!message.readBy || !message.readBy[userId]) {
                unreadCount++;
            }
        });
        return unreadCount;
    } catch (error) {
        console.error("Error counting unread messages:", error);
        return 0;
    }
}















function monitorContactStatuses() {
    if (unsubscribeStatuses) unsubscribeStatuses();
    
    const user = auth.currentUser;
    if (!user) return;

    unsubscribeStatuses = onSnapshot(collection(db, "users"), (snapshot) => {
        snapshot.docChanges().forEach((change) => {
            if (change.doc.id !== user.uid) {
                const contactData = change.doc.data();
                updateContactStatusUI(change.doc.id, contactData.status, contactData.lastSeen);
            }
        });
    });
}

function updateContactStatusUI(contactId, status, lastSeen) {
    const contactItems = document.querySelectorAll(`.contact-item[data-uid="${contactId}"]`);
    
    contactItems.forEach(item => {
        const statusIndicator = item.querySelector('.contact-status') || createStatusIndicator(item);
        statusIndicator.className = `contact-status ${status || 'offline'}`;
        
        if (status === 'offline') {
            const lastSeenTime = lastSeen ? formatLastSeen(lastSeen.toDate()) : 'unknown';
            statusIndicator.title = `Offline - Terakhir online ${lastSeenTime}`;
        } else {
            statusIndicator.title = status === 'online' ? 'Online' : 
                                  (status === 'busy' ? 'Sibuk' : 'Offline');
        }
    });
}


// Fungsi untuk membuat indikator status jika belum ada
function createStatusIndicator(contactItem, contactId) {
    const statusIndicator = document.createElement('div');
    statusIndicator.className = 'contact-status offline';
    statusIndicator.dataset.uid = contactId;
    
    // Tempatkan indikator status di sebelah avatar
    const avatarContainer = contactItem.querySelector('.contact-avatar');
    avatarContainer.appendChild(statusIndicator);
    
    return statusIndicator;
}


function formatLastSeen(timestamp) {
    if (!timestamp) return 'tidak diketahui';
    
    const now = new Date();
    const diffMinutes = Math.floor((now - timestamp) / (1000 * 60));
    
    if (diffMinutes < 1) return 'baru saja';
    if (diffMinutes < 60) return `${diffMinutes} menit yang lalu`;
    
    const diffHours = Math.floor(diffMinutes / 60);
    if (diffHours < 24) return `${diffHours} jam yang lalu`;
    
    const diffDays = Math.floor(diffHours / 24);
    if (diffDays < 7) return `${diffDays} hari yang lalu`;
    
    return timestamp.toLocaleDateString();
}



function updateUnreadCountUI(contactId, count) {
    const contactItem = document.querySelector(`.contact-item[data-uid="${contactId}"]`);
    if (!contactItem) return;

    // Hapus badge yang ada
    const existingBadge = contactItem.querySelector('.unread-badge');
    if (existingBadge) existingBadge.remove();

    // Tambahkan badge baru jika ada pesan belum dibaca
    if (count > 0) {
        const badge = document.createElement('span');
        badge.className = 'unread-badge';
        badge.textContent = count;
        
        const lastMessageDiv = contactItem.querySelector('.contact-last-message');
        if (lastMessageDiv) {
            lastMessageDiv.appendChild(badge);
        }
        
        contactItem.classList.add('has-unread');
    } else {
        contactItem.classList.remove('has-unread');
    }
}



async function loadContactsAndUnreadCounts() {
    const user = auth.currentUser;
    if (!user) return;

    try {
        const contacts = await fetchContacts();
        displayContacts(contacts);
        
        // Hitung pesan yang belum dibaca untuk setiap kontak
        for (const contact of contacts) {
            if (contact.roomId) {
                const unreadCount = await countUnreadMessages(contact.roomId, user.uid);
                updateUnreadCountUI(contact.uid, unreadCount);
            }
        }
    } catch (error) {
        console.error("Error loading contacts and unread counts:", error);
    }
}


// Fungsi untuk memantau pesan masuk secara real-time
function setupIncomingMessageListener() {
    const user = auth.currentUser;
    if (!user) return;

    if (unsubscribeMessages) unsubscribeMessages();

    // Listener untuk semua chat rooms dimana user adalah participant
    const roomsQuery = query(
        collection(db, 'chat_rooms'),
        where('participants', 'array-contains', user.uid)
    );

    unsubscribeRooms = onSnapshot(roomsQuery, async (roomsSnapshot) => {
        roomsSnapshot.docChanges().forEach(async (roomChange) => {
            const roomId = roomChange.doc.id;
            const roomData = roomChange.doc.data();
            const otherUserId = roomData.participants.find(id => id !== user.uid);

            if (otherUserId) {
                // Setup listener untuk pesan di room ini
                const messagesQuery = query(
                    collection(db, 'chat_rooms', roomId, 'messages'),
                    orderBy('timestamp', 'desc'),
                    limit(1)
                );

                onSnapshot(messagesQuery, (messagesSnapshot) => {
                    messagesSnapshot.docChanges().forEach(async (change) => {
                        if (change.type === 'added') {
                            const message = change.doc.data();
                            
                            // Jika pesan baru dari pengirim lain dan belum dibaca
                            if (message.senderId !== user.uid && 
                                (!message.readBy || !message.readBy[user.uid])) {
                                
                                // Update unread count
                                const unreadCount = await countUnreadMessages(roomId, user.uid);
                                updateUnreadCountUI(otherUserId, unreadCount);
                                
                                // Tampilkan notifikasi jika chat tidak aktif
                                if (currentChatWith !== otherUserId) {
                                    showNotification(otherUserId, message.text);
                                }
                            }
                        }
                    });
                });
            }
        });
    });
}



function updateUnreadCountUI(contactId, count) {
    const contactItem = document.querySelector(`.contact-item[data-uid="${contactId}"]`);
    if (!contactItem) return;

    // Hapus badge yang ada
    let unreadBadge = contactItem.querySelector('.unread-badge');
    
    // Jika belum ada badge, buat yang baru
    if (!unreadBadge && count > 0) {
        unreadBadge = document.createElement('span');
        unreadBadge.className = 'unread-badge';
        contactItem.querySelector('.contact-info').appendChild(unreadBadge);
    }

    // Update tampilan
    if (count > 0) {
        unreadBadge.textContent = count;
        unreadBadge.style.display = 'inline-block';
        contactItem.classList.add('has-unread');
    } else if (unreadBadge) {
        unreadBadge.style.display = 'none';
        contactItem.classList.remove('has-unread');
    }
}


function showNotification(contactId, messageText) {
    const contactItem = document.querySelector(`.contact-item[data-uid="${contactId}"]`);
    if (!contactItem) return;

    const contactName = contactItem.querySelector('.contact-name').textContent;
    
    // Buat elemen notifikasi
    const notification = document.createElement('div');
    notification.className = 'message-notification';
    notification.innerHTML = `
        <div class="notification-avatar">${contactName.charAt(0)}</div>
        <div class="notification-content">
            <div class="notification-name">${contactName}</div>
            <div class="notification-message">${messageText}</div>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    // Hilangkan notifikasi setelah 5 detik
    setTimeout(() => {
        notification.classList.add('fade-out');
        setTimeout(() => notification.remove(), 300);
    }, 5000);
}



















async function initializeUnreadCounts() {
  const user = auth.currentUser;
  if (!user) return;

  const contacts = document.querySelectorAll('.contact-item');
  contacts.forEach(async (contactItem) => {
    const roomId = contactItem.dataset.roomId;
    const contactId = contactItem.dataset.uid;
    const count = await getUnreadCount(roomId, user.uid, contactId);
    updateUnreadCountForContact(contactId, count);
  });
}

const messageId = change.doc.id; // ID dokumen pesan
console.log("New message received:", message);

// Cek apakah pesan ini dari pengirim yang BUKAN currentChatPartnerId
// Dan pastikan pesan ini belum ditandai sebagai 'read'
if (message.senderId !== currentChatPartnerId) {
  console.log(`Message from ${message.senderId} (not current chat partner). Incrementing unread count.`);
  incrementUnreadCount(message.senderId);
} else {
  console.log(`Message from ${message.senderId} (current chat partner). Not incrementing unread count.`);
}



// Panggil fungsi saat aplikasi dimuat
initializeUnreadCounts();

  // --- Enhanced Sticker Picker ---
    function setupStickerPicker() {
        const stickerButton = document.createElement('button');
        stickerButton.innerHTML = 'üñºÔ∏è';
        stickerButton.className = 'sticker-picker-button';
        stickerButton.title = 'Stickers';
        stickerButton.addEventListener('click', toggleStickerPicker);
        
        const stickerPicker = document.createElement('div');
        stickerPicker.className = 'sticker-picker hidden';
        
        // Sticker categories
        const categories = ['memes', 'animals', 'emotions', 'food'];
        categories.forEach(cat => {
            const categoryDiv = document.createElement('div');
            categoryDiv.className = 'sticker-category';
            
            const categoryTitle = document.createElement('h4');
            categoryTitle.textContent = cat.charAt(0).toUpperCase() + cat.slice(1);
            categoryDiv.appendChild(categoryTitle);
            
            const stickersDiv = document.createElement('div');
            stickersDiv.className = 'sticker-grid';
            
            // Add 5 sample stickers per category (in a real app, these would be actual images)
            for (let i = 1; i <= 5; i++) {
                const sticker = document.createElement('div');
                sticker.className = 'sticker';
                sticker.textContent = `${cat} ${i}`;
                sticker.addEventListener('click', () => sendSticker(cat, i));
                stickersDiv.appendChild(sticker);
            }
            
            categoryDiv.appendChild(stickersDiv);
            stickerPicker.appendChild(categoryDiv);
        });
        
        messageInput.parentNode.insertBefore(stickerButton, messageInput.nextSibling);
        messageInput.parentNode.insertBefore(stickerPicker, stickerButton.nextSibling);
    }
    
	  function toggleStickerPicker() {
        const picker = document.querySelector('.sticker-picker');
        picker.classList.toggle('hidden');
        stickerPickerVisible = !stickerPickerVisible;
        
        // Close emoji picker if open
        const emojiPicker = document.querySelector('.emoji-picker-container');
        if (emojiPicker) {
            emojiPicker.classList.add('hidden');
        }
    }
    
    async function sendSticker(category, id) {
        if (!currentRoomId || !currentChatWith) {
            showSuccessMessage("Pilih kontak terlebih dahulu");
            return;
        }
        
        const user = auth.currentUser;
        if (!user) {
            showSuccessMessage("Anda harus login untuk mengirim pesan");
            return;
        }
        
        try {
            // In a real app, this would be the URL to the sticker image
            const stickerUrl = `https://example.com/stickers/${category}/${id}.png`;
            
            const message = {
                stickerUrl: stickerUrl,
                senderId: user.uid,
                senderName: user.displayName || user.email || "Anonymous",
                timestamp: serverTimestamp(),
                readBy: { [user.uid]: true },
                isSticker: true,
                stickerCategory: category,
                stickerId: id
            };
            
            await addDoc(collection(db, 'chat_rooms', currentRoomId, 'messages'), message);
            await updateDoc(doc(db, 'chat_rooms', currentRoomId), {
                lastMessageAt: serverTimestamp()
            });
            
            toggleStickerPicker();
            await updateLastMessagePreview(currentRoomId, message);
            await fetchContacts();
            
        } catch (error) {
            console.error("Error sending sticker:", error);
            showSuccessMessage("Gagal mengirim sticker");
        }
    }
    
	
	// Initialize all enhanced features
    function initializeEnhancedFeatures() {
        setupStickerPicker();
        setupProfileEdit();
        
        // Request notification permission
        if ("Notification" in window) {
            Notification.requestPermission();
        }
    }
    
	
	
	// Add this function to initialize the notification system
function initNotificationSystem() {
  savedMessagesModal = document.getElementById('savedMessagesModal');
  closeModalBtn = document.querySelector('.close-modal');
  
  if (closeModalBtn) {
    closeModalBtn.addEventListener('click', () => {
      savedMessagesModal.classList.add('hidden');
    });
  }
  
  window.addEventListener('click', (event) => {
    if (event.target === savedMessagesModal) {
      savedMessagesModal.classList.add('hidden');
    }
  });
  
  const openNotificationBtn = document.getElementById('openNotificationBtn');
  if (openNotificationBtn) {
    openNotificationBtn.addEventListener('click', () => {
      hideNotification();
      // Scroll to the chat area or focus on it
      document.getElementById('chatArea').scrollIntoView();
    });
  }
}

// Add this function to show notifications
function showNotification(senderName, messageText) {
  const now = Date.now();
  // Prevent showing multiple notifications too quickly
  if (now - lastNotificationTime < 5000) return;
  
  lastNotificationTime = now;
  
  const notificationBar = document.getElementById('notificationBar');
  const notificationAvatar = document.getElementById('notificationAvatar');
  const notificationUserName = document.getElementById('notificationUserName');
  const notificationTime = document.getElementById('notificationTime');
  
  if (notificationBar && notificationAvatar && notificationUserName && notificationTime) {
    // Update notification content
    notificationAvatar.textContent = senderName.charAt(0).toUpperCase();
    notificationUserName.textContent = senderName;
    notificationTime.textContent = 'now';
    
    // Show notification
    notificationBar.classList.remove('hidden');
    setTimeout(() => notificationBar.classList.add('show'), 10);
    
    // Update time every minute
    let minutesPassed = 0;
    const timeUpdater = setInterval(() => {
      minutesPassed++;
      notificationTime.textContent = minutesPassed === 1 ? '1 min ago' : `${minutesPassed} mins ago`;
    }, 60000);
    
    // Hide notification after 10 seconds
    clearTimeout(notificationTimeout);
    notificationTimeout = setTimeout(() => {
      hideNotification();
      clearInterval(timeUpdater);
    }, 10000);
  }
}

function hideNotification() {
  const notificationBar = document.getElementById('notificationBar');
  if (notificationBar) {
    notificationBar.classList.remove('show');
    setTimeout(() => notificationBar.classList.add('hidden'), 300);
  }
}

async function getLastMessageAndCount(roomId, userId) {
    try {
        const messagesRef = collection(db, 'chat_rooms', roomId, 'messages');
        const lastMessageQuery = query(messagesRef, orderBy('timestamp', 'desc'), limit(1));
        const unreadQuery = query(messagesRef, where('senderId', '==', userId), where(`readBy.${userId}`, '==', false));
        let lastMessageData = { lastMessage: '', lastMessageSender: null, lastMessageTime: null, unreadCount: 0 };

        // Get the last message
        const lastMessageSnapshot = await getDocs(lastMessageQuery);
        if (!lastMessageSnapshot.empty) {
            const messageDoc = lastMessageSnapshot.docs[0];
            const messageData = messageDoc.data();
            lastMessageData.lastMessage = messageData.text || "[No message content]";
            lastMessageData.lastMessageSender = messageData.senderId;
            lastMessageData.lastMessageTime = messageData.timestamp?.toDate();
        }

        // Count unread messages
        const unreadSnapshot = await getCountFromServer(unreadQuery);
        lastMessageData.unreadCount = unreadSnapshot.data().count;

        return lastMessageData;
    } catch (error) {
        console.error("Error in getLastMessageAndCount:", error);
        return { lastMessage: "Failed to load", lastMessageSender: null, lastMessageTime: null, unreadCount: 0 };
    }
}


	
	function resetChatState() {
    // Reset input fields
    if (emailInput) emailInput.value = "";
    if (passwordInput) passwordInput.value = "";

    // Hentikan semua listener
    if (unsubscribeNotes) {
        unsubscribeNotes();
        unsubscribeNotes = null;
    }
    
    if (unsubscribeMessages) {
        unsubscribeMessages();
        unsubscribeMessages = null;
    }
    
    if (unsubscribeContacts) {
        unsubscribeContacts();
        unsubscribeContacts = null;
    }
    
    if (unsubscribeStatuses) {
        unsubscribeStatuses();
        unsubscribeStatuses = null;
    }
    
    // Reset state chat
    currentChatWith = null;
    currentRoomId = null;
    
    // Disable input chat
    if (messageInput) messageInput.disabled = true;
    if (sendMessageBtn) sendMessageBtn.disabled = true;
    
    // Reset tampilan chat
    if (currentChatInfo) currentChatInfo.style.display = 'none';
    if (messageBox) messageBox.innerHTML = '<div>Pilih kontak untuk memulai percakapan</div>';
    if (contactsList) contactsList.innerHTML = '<div class="loading-contacts">Memuat daftar kontak...</div>';
}
	
	
	
	
	
	
	
	
	
 


   function updateProfileUI() {
    if (!userProfile) return;
    
    const profileNameElement = document.getElementById('profileName');
    const profileBioElement = document.getElementById('profileBio');
    const profileStatusElement = document.getElementById('profileStatus');
    const profileLastUpdatedElement = document.getElementById('profileLastUpdated');
    
    if (profileNameElement) profileNameElement.textContent = userProfile.name || 'No name';
    if (profileBioElement) profileBioElement.textContent = userProfile.bio || 'No bio';
    
    if (profileStatusElement) {
        profileStatusElement.textContent = userProfile.status === 'online' ? 'Online' : 
                                         (userProfile.status === 'busy' ? 'Busy' : 'Offline');
        profileStatusElement.className = `status-${userProfile.status || 'offline'}`;
    }
    
    if (profileLastUpdatedElement) {
        const lastUpdated = userProfile.lastUpdated?.toDate?.() || 
                          (typeof userProfile.lastUpdated === 'string' ? new Date(userProfile.lastUpdated) : null);
        profileLastUpdatedElement.textContent = lastUpdated ? 
            `Last updated: ${lastUpdated.toLocaleString()}` : 
            'Last updated: Unknown';
    }
}

	
	

	
	function getProfilePicInitial(displayName) {
    return displayName ? displayName.charAt(0).toUpperCase() : '?';
}
	
	function setupProfileEdit() {
    const editProfileBtn = document.getElementById('editProfileBtn');
    const profileModal = document.getElementById('profileModal');
    const closeProfileModal = document.getElementById('closeProfileModal');
    const saveProfileBtn = document.getElementById('saveProfileBtn');
    const profileNameInput = document.getElementById('profileNameInput');
    const profileBioInput = document.getElementById('profileBioInput');
    const profileStatusSelect = document.getElementById('profileStatusSelect');
    
    if (!editProfileBtn || !profileModal) return;
    
    editProfileBtn.addEventListener('click', () => {
        if (!userProfile) return;
        
        profileNameInput.value = userProfile.name || '';
        profileBioInput.value = userProfile.bio || '';
        profileStatusSelect.value = userProfile.status || 'online';
        
        profileModal.style.display = 'block';
    });
    
    closeProfileModal.addEventListener('click', () => {
        profileModal.style.display = 'none';
    });
    
    saveProfileBtn.addEventListener('click', async () => {
        const updates = {
            name: profileNameInput.value.trim(),
            bio: profileBioInput.value.trim(),
            status: profileStatusSelect.value,
            lastUpdated: serverTimestamp()
        };
        
        if (!updates.name) {
            showSuccessMessage("Name cannot be empty");
            return;
        }
        
        try {
            await updateDoc(doc(db, "users", auth.currentUser.uid), updates);
            showSuccessMessage("Profile updated successfully");
            profileModal.style.display = 'none';
            
            // Update UI dan kontak
            await loadUserProfile();
            await fetchContacts();
        } catch (error) {
            console.error("Error updating profile:", error);
            showSuccessMessage("Failed to update profile");
        }
    });
}


async function fetchContacts() {
    try {
        const user = auth.currentUser;
        if (!user) return [];

        // Ambil semua user kecuali user yang sedang login
        const usersSnapshot = await getDocs(collection(db, "users"));
        const allUsers = usersSnapshot.docs
            .filter(doc => doc.id !== user.uid)
            .map(doc => ({
                id: doc.id,
                ...doc.data()
            }));

        // Ambil semua chat_rooms di mana user saat ini menjadi partisipan
        const roomsQuery = query(
            collection(db, 'chat_rooms'),
            where('participants', 'array-contains', user.uid)
        );
        const roomsSnapshot = await getDocs(roomsQuery);

        // Map otherUserId ke roomId untuk akses cepat
        const userRooms = {};
        roomsSnapshot.forEach(doc => {
            const roomData = doc.data();
            const otherUserId = roomData.participants.find(id => id !== user.uid);
            if (otherUserId) {
                userRooms[otherUserId] = doc.id;
            }
        });

        // Buat daftar kontak dengan informasi lengkap
        const contacts = await Promise.all(allUsers.map(async (userData) => {
            const roomId = userRooms[userData.id];
            let lastMessageInfo = { 
                lastMessage: "No messages yet", 
                unreadCount: 0, 
                lastMessageTime: null, 
                lastMessageSender: null 
            };

            if (roomId) {
                lastMessageInfo = await getLastMessageAndCount(roomId, user.uid);
            }

            return {
                uid: userData.id,
                name: userData.name || userData.email || "Anonymous",
                status: userData.status || "offline",
                lastSeen: userData.lastSeen || null,
                lastMessage: lastMessageInfo.lastMessage,
                lastMessageSender: lastMessageInfo.lastMessageSender,
                lastMessageTime: lastMessageInfo.lastMessageTime,
                unreadCount: lastMessageInfo.unreadCount,
                roomId: roomId
            };
        }));

        // Urutkan kontak berdasarkan waktu pesan terakhir (terbaru pertama)
        contacts.sort((a, b) => {
            const timeA = a.lastMessageTime?.getTime() || 0;
            const timeB = b.lastMessageTime?.getTime() || 0;
            return timeB - timeA;
        });

        return contacts;
    } catch (error) {
        console.error("Error fetching contacts:", error);
        return [];
    }
}


async function resetUnreadCount(roomId, contactId) {
    const user = auth.currentUser;
    if (!user) return;

    try {
        // Update read status semua pesan di room ini
        const messagesRef = collection(db, 'chat_rooms', roomId, 'messages');
        const q = query(messagesRef, where(`readBy.${user.uid}`, '==', false));
        const snapshot = await getDocs(q);

        const batch = writeBatch(db);
        snapshot.forEach(doc => {
            batch.update(doc.ref, { [`readBy.${user.uid}`]: true });
        });

        await batch.commit();

        // Reset unread count di user.contact
        await updateDoc(doc(db, 'users', user.uid), {
            [`contacts.${roomId}.unreadCount`]: 0
        });

        // Update UI
        const contactItem = document.querySelector(`.contact-item[data-uid="${contactId}"]`);
        const badge = contactItem?.querySelector('.unread-count');
        if (badge) badge.remove();

    } catch (error) {
        console.error("Error resetting unread count:", error);
    }
}


function displayContacts(contacts) {
    const contactsList = document.getElementById('contactsList');
    if (!contactsList) return;
    
    contactsList.innerHTML = '';
    
    contacts.forEach(contact => {
        const contactItem = document.createElement('div');
        contactItem.className = 'contact-item';
        contactItem.dataset.uid = contact.uid;
        
        // Tambahkan class berdasarkan status dan unread count
        if (contact.unreadCount > 0) {
            contactItem.classList.add('has-unread');
        }
        
        // Avatar dengan indikator status
        const avatarContainer = document.createElement('div');
        avatarContainer.className = 'contact-avatar-container';
        
        const avatar = document.createElement('div');
        avatar.className = 'contact-avatar';
        avatar.textContent = contact.name.charAt(0).toUpperCase();
        
        const statusIndicator = document.createElement('div');
        statusIndicator.className = `contact-status ${contact.status || 'offline'}`;
        statusIndicator.title = contact.status === 'online' ? 'Online' : 
                              (contact.status === 'busy' ? 'Busy' : 
                              `Offline - Last seen ${formatLastSeen(contact.lastSeen?.toDate())}`);
        
        avatarContainer.appendChild(avatar);
        avatarContainer.appendChild(statusIndicator);
        
        // Info kontak
        const infoDiv = document.createElement('div');
        infoDiv.className = 'contact-info';
        
        const nameDiv = document.createElement('div');
        nameDiv.className = 'contact-name';
        nameDiv.textContent = contact.name;
        
        const lastMessageDiv = document.createElement('div');
        lastMessageDiv.className = 'contact-last-message';
        
        // Tampilkan pesan terakhir
        if (contact.lastMessageSender === auth.currentUser?.uid) {
            lastMessageDiv.textContent = `You: ${contact.lastMessage}`;
        } else {
            lastMessageDiv.textContent = contact.lastMessage || 'No messages yet';
        }
        
        infoDiv.appendChild(nameDiv);
        infoDiv.appendChild(lastMessageDiv);
        
        contactItem.appendChild(avatarContainer);
        contactItem.appendChild(infoDiv);
        
        // Tambahkan unread count badge jika ada pesan belum dibaca
        if (contact.unreadCount > 0) {
            const unreadBadge = document.createElement('span');
            unreadBadge.className = 'unread-count';
            unreadBadge.textContent = contact.unreadCount;
            infoDiv.appendChild(unreadBadge);
        }
        
        contactsList.appendChild(contactItem);

        // Event listener ketika kontak diklik
        contactItem.addEventListener('click', () => {
            startChatWithUser(contact.uid, contact.name, contact.roomId);
            resetUnreadCount(contact.roomId, contact.uid);
        });
    });
}







 async function updateUserStatus(status) {
    const user = auth.currentUser;
    if (!user) return;
    
    try {
        const updates = {
            status: status,
            lastSeen: status === 'online' ? null : serverTimestamp(),
            lastUpdated: serverTimestamp()
        };
        
        await updateDoc(doc(db, "users", user.uid), updates, { merge: true });
        
        if (status === 'offline') {
            // Hentikan listener saat offline
            if (unsubscribeUserProfile) unsubscribeUserProfile();
            if (unsubscribeStatuses) unsubscribeStatuses();
            if (unsubscribeContacts) unsubscribeContacts();
            if (unsubscribeMessages) unsubscribeMessages();
            if (unsubscribeNotes) unsubscribeNotes();
        }
    } catch (error) {
        console.error("Error updating status:", error);
    }
}

function initializeChat() {
    if (sendMessageBtn && messageInput) {
        messageInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendPersonalMessage();
            }
        });
        
        sendMessageBtn.addEventListener('click', sendPersonalMessage);
        
        // Inisialisasi sticker picker
        setupStickerPicker();
    }
}



async function startChatWithUser(userId, userName, roomId) {
    const user = auth.currentUser;
    if (!user) return;

    try {
        currentChatWith = userId;
        
        // Get or create chat room
        currentRoomId = roomId || await findOrCreateChatRoom(user.uid, userId);
        
        // Update UI
        currentChatWithSpan.textContent = userName;
        currentChatInfo.style.display = 'block';
        messageInput.disabled = false;
        sendMessageBtn.disabled = false;

        // Load chat history
        await displayChatHistory(currentRoomId);

        // Setup real-time listener
        setupMessageListener(currentRoomId);

    } catch (error) {
        console.error("Error starting chat:", error);
        showSuccessMessage("Failed to start chat");
    }
}







 

// Replace all instances of collection() calls with proper path construction
async function findOrCreateChatRoom(userId1, userId2) {
    try {
        const participants = [userId1, userId2].sort();
        
        // First check for existing room
        const roomsRef = collection(db, 'chat_rooms');
        const q = query(
            roomsRef,
            where('participants', '==', participants)
        );
        
        const querySnapshot = await getDocs(q);
        
        if (!querySnapshot.empty) {
            return querySnapshot.docs[0].id;
        }
        
        // Create new room if none exists
        const newRoomRef = await addDoc(collection(db, 'chat_rooms'), {
            participants: participants,
            createdAt: serverTimestamp(),
            lastMessageAt: serverTimestamp(),
            userNames: {
                [userId1]: await getUserName(userId1),
                [userId2]: await getUserName(userId2)
            }
        });
        
        return newRoomRef.id;
    } catch (error) {
        console.error("Error in findOrCreateChatRoom:", error);
        throw error;
    }
}

async function getUserName(userId) {
    const userDoc = await getDoc(doc(db, 'users', userId));
    return userDoc.exists() ? userDoc.data().name || userDoc.data().email || "Unknown" : "Unknown";
}















async function findExistingRoom(participants) {
    if (participants.length !== 2) return null;
    const q = query(
        collection(db, 'chat_rooms'),
        where('participants', 'array-contains', participants[0])
    );
    const snapshot = await getDocs(q);
    for (const doc of snapshot.docs) {
        const roomData = doc.data();
        if (roomData.participants && 
            roomData.participants.length === 2 &&
            roomData.participants.includes(participants[0]) &&
            roomData.participants.includes(participants[1])) {
            return doc.id;
        }
    }
    return null;
}  
   
   
    
async function updateLastMessagePreview(roomId, lastMessage) {
    const roomDoc = await getDoc(doc(db, 'chat_rooms', roomId));
    const roomData = roomDoc.data();
    if (!roomData) return;
    
    const participants = roomData.participants;
    const senderId = lastMessage.senderId;
    
    for (const userId of participants) {
        const updates = {
            lastMessage: {
                text: lastMessage.text,
                senderId: senderId,
                timestamp: lastMessage.timestamp
            }
        };
        
        // Tambahkan unread count hanya untuk penerima (bukan pengirim)
        if (userId !== senderId) {
            updates[`unreadCount.${senderId}`] = increment(1);
        }
        
        await updateDoc(doc(db, "users", userId), updates, { merge: true });
    }
}



function updateUnreadBadge(contactId, count) {
    const contactItem = document.querySelector(`.contact-item[data-uid="${contactId}"]`);
    if (!contactItem) return;

    // Hapus badge yang ada
    const existingBadge = contactItem.querySelector('.unread-badge');
    if (existingBadge) existingBadge.remove();

    // Tambahkan badge baru jika ada pesan belum dibaca
    if (count > 0) {
        const badge = document.createElement('span');
        badge.className = 'unread-badge';
        badge.textContent = count;

        const lastMessageDiv = contactItem.querySelector('.contact-last-message');
        if (lastMessageDiv) {
            lastMessageDiv.appendChild(badge);
        }

        // Tambahkan class has-unread untuk styling
        contactItem.classList.add('has-unread');
    } else {
        contactItem.classList.remove('has-unread');
    }
}



async function markMessagesAsRead(roomId, userId) {
  try {
    const messagesRef = collection(db, 'chat_rooms', roomId, 'messages');
    const snapshot = await getDocs(
      query(messagesRef, where('senderId', '!=', userId))
    );

    const unreadMessages = snapshot.docs.filter(doc => {
      const data = doc.data();
      return !data.readBy || data.readBy[userId] !== true;
    });

    if (unreadMessages.length === 0) {
      console.log("Tidak ada pesan yang perlu ditandai sebagai dibaca.");
      return;
    }

    const batch = writeBatch(db);
    unreadMessages.forEach(doc => {
      batch.update(doc.ref, {
        [`readBy.${userId}`]: true,
        readAt: serverTimestamp()
      });
    });

    await batch.commit();
    console.log("Berhasil menandai semua pesan sebagai dibaca.");
  } catch (error) {
    console.error("Error marking messages as read:", error);
  }
}



// Call this periodically to update unread counts
setInterval(updateUnreadCounts, 30000); // Update every 30 seconds
    
   

















function displayMessage(message, isSender, messageCount = 0) {
    const messageBox = document.getElementById('messageBox');
    if (!messageBox) return;

    const messageContainer = document.createElement('div');
    messageContainer.className = `message-container ${isSender ? 'sent' : 'received'}`;
	    messageContainer.dataset.messageId = message.id; // Tambahkan ID pesan untuk tracking


    const messageBubble = document.createElement('div');
    messageBubble.className = 'message-bubble';

    // Tambahkan nama pengirim untuk pesan masuk
    if (!isSender) {
        const senderName = document.createElement('div');
        senderName.className = 'message-sender';
        senderName.textContent = message.senderName;
        messageBubble.appendChild(senderName);
    }

    // Konten pesan
    const messageContent = document.createElement('div');
    messageContent.className = 'message-content';

    const messageText = document.createElement('span');
    messageText.className = 'message-text';
    messageText.textContent = message.text;
    messageContent.appendChild(messageText);

    // Tambahkan jumlah pesan (jika ada)
    const count = messageCount || message.count;
    if (count && count > 1) {
        const countBadge = document.createElement('span');
        countBadge.className = 'message-count';
        countBadge.textContent = count;
        messageContent.appendChild(countBadge);
    }

     // Status element setup
    const messageStatus = document.createElement('div');
    messageStatus.className = 'message-status';
    
    // Status pesan - bagian yang diperbaiki
    if (isSender) {
        const messageStatus = document.createElement('div');
        messageStatus.className = 'message-status';
        
        if (message.readBy && Object.keys(message.readBy).length > 1) {
            // ‚úì‚úì Biru - sudah dibaca oleh penerima
            messageStatus.innerHTML = '‚úì‚úì';
            messageStatus.style.color = 'blue';
            messageStatus.title = 'Dibaca';
        } else if (message.delivered) {
            // ‚úì Hijau - terkirim ke server
            messageStatus.innerHTML = '‚úì';
            messageStatus.style.color = 'green';
            messageStatus.title = 'Terkirim';
        } else {
            // ‚úì Abu-abu - sedang mengirim
            messageStatus.innerHTML = '‚úì';
            messageStatus.style.color = 'gray';
            messageStatus.title = 'Mengirim...';
        }
        
        messageContent.appendChild(messageStatus);
    }
	
    // Avatar untuk pesan masuk
    if (!isSender) {
        const avatar = document.createElement('div');
        avatar.className = 'message-avatar';
        avatar.textContent = message.senderName?.charAt(0).toUpperCase() || '?';
        messageBubble.appendChild(avatar);
    }

    messageBubble.appendChild(messageContent);

    // Timestamp
    const messageTime = document.createElement('div');
    messageTime.className = 'message-time';
    const timestamp = message.timestamp?.toDate?.() || new Date();
    messageTime.textContent = timestamp.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    messageBubble.appendChild(messageTime);

    if (!isSender) {
    const saveButton = document.createElement('button');
    saveButton.className = 'save-message-btn';
    saveButton.innerHTML = 'üíæ';
    saveButton.title = 'Simpan Pesan';
    saveButton.addEventListener('click', (e) => {
        e.stopPropagation();
        saveMessage(message);
    });
    messageBubble.appendChild(saveButton);
}


    messageContainer.appendChild(messageBubble);
    messageBox.appendChild(messageContainer);
    messageBox.scrollTop = messageBox.scrollHeight;

    // Notifikasi jika pesan masuk
    if (!isSender) {
        showNotification(message.senderName, message.text);
    }
}



function setupMessageStatusListener(roomId, messageId) {
    return onSnapshot(doc(db, 'chat_rooms', roomId, 'messages', messageId), (doc) => {
        const message = doc.data();
        const messageElement = document.querySelector(`.message-container[data-message-id="${messageId}"]`);
        
        if (messageElement) {
            // Update status pesan di UI
            const statusElement = messageElement.querySelector('.message-status');
            if (statusElement) {
                if (message.readBy && Object.keys(message.readBy).length > 1) {
                    statusElement.innerHTML = '‚úì‚úì';
                    statusElement.style.color = 'blue';
                    statusElement.title = 'Dibaca';
                } else if (message.delivered) {
                    statusElement.innerHTML = '‚úì';
                    statusElement.style.color = 'green';
                    statusElement.title = 'Terkirim';
                } else {
                    statusElement.innerHTML = '‚úì';
                    statusElement.style.color = 'gray';
                    statusElement.title = 'Mengirim...';
                }
            }
        }
    });
}



async function saveMessage(message) {
    const user = auth.currentUser;
    if (!user) {
        showSuccessMessage("Anda perlu login untuk menyimpan pesan.");
        return;
    }

    try {
        const savedMessage = {
            content: message.text || "[Pesan tanpa teks]",
            senderId: message.senderId,
            senderName: message.senderName || "Unknown",
            originalTimestamp: message.timestamp || serverTimestamp(),
            savedAt: serverTimestamp()
        };

        await addDoc(collection(db, 'users', user.uid, 'savedMessages'), savedMessage);
        showSuccessMessage("Pesan berhasil disimpan!");

        // Jika modal pesan tersimpan sedang terbuka, refresh isi
        if (document.getElementById('savedMessagesModal')?.classList.contains('show')) {
            showSavedMessages();
        }
    } catch (error) {
        console.error("Gagal menyimpan pesan:", error);
        showSuccessMessage("Gagal menyimpan pesan.");
    }
}



function addSaveButton(messageElement, message) {
    const saveButton = document.createElement('button');
    saveButton.className = 'save-message-btn';
    saveButton.innerHTML = 'üíæ Simpan';
    saveButton.title = 'Simpan Pesan ini';
    saveButton.addEventListener('click', (e) => {
        e.stopPropagation();
        saveMessage(message);
    });

    const messageActions = messageElement.querySelector('.message-actions') || document.createElement('div');
    messageActions.className = 'message-actions';
    messageActions.appendChild(saveButton);
    messageElement.appendChild(messageActions);
}
	
    if (openSavedMessagesBtn) {
        openSavedMessagesBtn.addEventListener('click', showSavedMessages);
    }
	
	
	
	
	
    
    // --- Profile Management ---
    function setupProfileEdit() {
        if (!editProfileBtn || !profileModal) return;
        
        editProfileBtn.addEventListener('click', () => {
            if (!userProfile) return;
            
            profileNameInput.value = userProfile.name || '';
            profileBioInput.value = userProfile.bio || '';
            profileModal.style.display = 'block';
        });
        
        closeProfileModal.addEventListener('click', () => {
            profileModal.style.display = 'none';
        });
        
        saveProfileBtn.addEventListener('click', async () => {
            const updates = {
                name: profileNameInput.value.trim(),
                bio: profileBioInput.value.trim(),
                lastUpdated: serverTimestamp()
            };
            
            if (!updates.name) {
                showSuccessMessage("Nama tidak boleh kosong");
                return;
            }
            
            try {
                await updateDoc(doc(db, 'users', auth.currentUser.uid), updates);
                profileModal.style.display = 'none';
                showSuccessMessage("Profil diperbarui!");
                
                // Refresh profile display
                await loadUserProfile();
                
            } catch (error) {
                console.error("Error updating profile:", error);
                showSuccessMessage("Gagal memperbarui profil");
            }
        });
    }
    
	
	
	
    async function loadUserProfile() {
        const user = auth.currentUser;
        if (!user) return;
        
        try {
            const docRef = doc(db, 'users', user.uid);
            const docSnap = await getDoc(docRef);
            
            if (docSnap.exists()) {
                userProfile = docSnap.data();
                updateProfileUI();
            } else {
                // Create new profile
                const profileData = {
                    name: user.displayName || user.email.split('@')[0],
                    email: user.email,
                    bio: 'Halo! Saya pengguna baru.',
                    lastUpdated: serverTimestamp(),
                    createdAt: serverTimestamp()
                };
                
                await setDoc(docRef, profileData);
                userProfile = profileData;
                updateProfileUI();
            }
            
        } catch (error) {
            console.error("Error loading profile:", error);
        }
    }
	
	
	
	
	
	
	
	
	
	
    
    function updateProfileUI() {
        if (!userProfile || !profileSection) return;
        
        if (profileName) {
            profileName.textContent = userProfile.name || 'Pengguna';
        }
        
        if (profileBio) {
            profileBio.textContent = userProfile.bio || 'Tidak ada bio';
        }
        
        if (profileLastUpdated) {
            const lastUpdated = userProfile.lastUpdated?.toDate?.() || 
                               (typeof userProfile.lastUpdated === 'string' ? new Date(userProfile.lastUpdated) : null);
            profileLastUpdated.textContent = lastUpdated ? 
                `Diperbarui: ${lastUpdated.toLocaleString()}` : 
                'Diperbarui: Tidak diketahui';
        }
    }



async function sendPersonalMessage() {
    const messageText = messageInput.value.trim();
    if (!messageText) return;

    const user = auth.currentUser;
    if (!user) {
        showSuccessMessage("Please login to send messages");
        return;
    }

    if (!currentChatWith) {
        showSuccessMessage("Please select a contact first");
        return;
    }

    try {
        // Ensure we have a valid room ID
        if (!currentRoomId) {
            currentRoomId = await findOrCreateChatRoom(user.uid, currentChatWith);
        }

        const messageData = {
            text: messageText,
            senderId: user.uid,
            senderName: user.displayName || user.email,
            timestamp: serverTimestamp(),
            readBy: { [user.uid]: true },
            delivered: true
        };

        // Add message to Firestore
        const messagesRef = collection(db, 'chat_rooms', currentRoomId, 'messages');
        await addDoc(messagesRef, messageData);

        // Update room's last message
        await updateDoc(doc(db, 'chat_rooms', currentRoomId), {
            lastMessage: messageText,
            lastMessageAt: serverTimestamp(),
            lastMessageSender: user.uid
        });

        messageInput.value = "";
        
    } catch (error) {
        console.error("Error sending message:", error);
        showSuccessMessage("Failed to send message");
    }
}

















// Fungsi untuk menyembunyikan indikator typing
function hideTypingIndicator(userId) {
    const contactItem = document.querySelector(`.contact-item[data-uid="${userId}"]`);
    if (contactItem) {
        const typingIndicator = contactItem.querySelector('.typing-indicator');
        if (typingIndicator) {
            typingIndicator.remove();
        }
    }
}


// Fungsi untuk menampilkan indikator typing
function showTypingIndicator(userId) {
    const contactItem = document.querySelector(`.contact-item[data-uid="${userId}"]`);
    if (contactItem) {
        let typingIndicator = contactItem.querySelector('.typing-indicator');
        if (!typingIndicator) {
            typingIndicator = document.createElement('div');
            typingIndicator.className = 'typing-indicator';
            typingIndicator.innerHTML = `
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
            `;
            const lastMessageDiv = contactItem.querySelector('.contact-last-message');
            lastMessageDiv.appendChild(typingIndicator);
        }
    }
}


	
	// Fungsi untuk menambahkan emoji ke input pesan
    function setupEmojiPicker() {
        const emojiButton = document.createElement('button');
        emojiButton.innerHTML = 'üòä';
        emojiButton.className = 'emoji-picker-button';
        emojiButton.addEventListener('click', () => toggleEmojiPicker());
        
        const emojiPickerContainer = document.createElement('div');
        emojiPickerContainer.className = 'emoji-picker-container hidden';
        
        // Daftar emoji yang tersedia
        const emojis = ['üòÄ', 'üòÉ', 'üòÑ', 'üòÅ', 'üòÜ', 'üòÖ', 'üòÇ', 'ü§£', 'üòä', 'üòá', 
                       'üôÇ', 'üôÉ', 'üòâ', 'üòå', 'üòç', 'ü•∞', 'üòò', 'üòó', 'üòô', 'üòö',
                       'üòã', 'üòõ', 'üòù', 'üòú', 'ü§™', 'ü§®', 'üßê', 'ü§ì', 'üòé', 'ü§©'];
        
        emojis.forEach(emoji => {
            const emojiElement = document.createElement('span');
            emojiElement.textContent = emoji;
            emojiElement.className = 'emoji-option';
            emojiElement.addEventListener('click', () => {
                messageInput.value += emoji;
                messageInput.focus();
            });
            emojiPickerContainer.appendChild(emojiElement);
        });
        
        messageInput.parentNode.insertBefore(emojiButton, messageInput.nextSibling);
        messageInput.parentNode.insertBefore(emojiPickerContainer, emojiButton.nextSibling);
    }

    function toggleEmojiPicker() {
        const picker = document.querySelector('.emoji-picker-container');
        picker.classList.toggle('hidden');
    }
	  // Inisialisasi emoji picker setelah elemen messageInput tersedia
    if (messageInput) {
        setupEmojiPicker();
    }



  // In displayChatHistory
async function displayChatHistory(roomId) {
    const messageBox = document.getElementById('messageBox');
    if (!messageBox) return;

    try {
        const messagesQuery = query(
            collection(db, 'chat_rooms', roomId, 'messages'),
            orderBy('timestamp', 'asc')
        );

        const querySnapshot = await getDocs(messagesQuery);
        messageBox.innerHTML = '';

        if (querySnapshot.empty) {
            messageBox.innerHTML = '<div class="no-messages">Belum ada pesan</div>';
            return;
        }

        querySnapshot.forEach((doc) => {
            const message = doc.data();
            const isSender = message.senderId === auth.currentUser?.uid;
            displayMessage(message, isSender);

            // Mark as read if receiver and not already read
            // The markMessagesAsRead function handles marking all unread messages in a batch.
            // No need to call it per message here, as it will be called for the room if any unread.
        });

        messageBox.scrollTop = messageBox.scrollHeight;

        // After displaying all messages, if there's a current user and unread messages,
        // mark them as read. This needs to be handled by the onSnapshot listener for real-time.
        // For initial load, you might want to call it here if needed, but consider the real-time listener below.
        if (auth.currentUser?.uid) {
            await markMessagesAsRead(roomId, auth.currentUser.uid);
        }


    } catch (error) {
        console.error("Error loading chat history:", error);
        messageBox.innerHTML = '<div class="error-loading">Gagal memuat riwayat chat</div>';
    }
}



// In startApplication function
window.startApplication = () => {
    firebase.auth().onAuthStateChanged(user => {
        if (user) {
            console.log("User logged in:", user.uid);
            document.getElementById('authSection').style.display = 'none';
            document.getElementById('chatContainer').style.display = 'flex';
            document.getElementById('userDisplayName').textContent = user.displayName || user.email || 'Anonymous User';

            displayContacts(); // Your function to display contacts
            console.log("Calling listenForUnreadMessages...");
            listenForUnreadMessages(); // Call this function after a user successfully logs in
            console.log("listenForUnreadMessages called.");
        } else {
            console.log("No user logged in.");
            document.getElementById('authSection').style.display = 'block';
            document.getElementById('chatContainer').style.display = 'none';
        }
    });
};

// Inside listenForUnreadMessages
let unreadMessagesUnsubscribe = null;
async function listenForUnreadMessages() {
    const currentUser = firebase.auth().currentUser;
    if (!currentUser) {
        console.warn("No user logged in to listen for unread messages. (inside listenForUnreadMessages)");
        return;
    }
    console.log(`Listening for unread messages for user: ${currentUser.uid}`);

    if (unreadMessagesUnsubscribe) {
        unreadMessagesUnsubscribe();
        console.log("Unsubscribed from previous unread messages listener.");
    }

    unreadMessagesUnsubscribe = firebase.firestore().collection('messages')
        .where('recipientId', '==', currentUser.uid)
        .where('read', '==', false)
        .onSnapshot(snapshot => {
            console.log(`New unread message snapshot received. Docs changed: ${snapshot.docChanges().length}`);
            console.log(`Total unread messages in snapshot: ${snapshot.size}`);

            const unreadCounts = {};
            snapshot.forEach(doc => {
                const message = doc.data();
                console.log("Unread message:", message); // Inspect each unread message
                if (message.senderId !== currentUser.uid) {
                    unreadCounts[message.senderId] = (unreadCounts[message.senderId] || 0) + 1;
                }
            });

            console.log("Calculated unread counts:", unreadCounts);

            document.querySelectorAll('.contact-item').forEach(item => {
                const contactUid = item.dataset.uid;
                const count = unreadCounts[contactUid] || 0;
                console.log(`Updating contact ${contactUid} with count ${count}`);
                updateUnreadCountForContact(contactUid, count);
            });

        }, error => {
            console.error("Error listening for unread messages:", error);
        });
}

function updateUnreadCountForContact(contactId, count) {
  const contactItem = document.querySelector(`.contact-item[data-uid="${contactId}"]`);
  if (!contactItem) return;

  // Hapus badge unread count yang sudah ada
  let unreadCountElement = contactItem.querySelector('.unread-count');
  if (unreadCountElement) {
    unreadCountElement.remove();
  }

  // Jika ada pesan yang belum dibaca, tambahkan badge baru
  if (count > 0) {
    unreadCountElement = document.createElement('div');
    unreadCountElement.className = 'unread-count';
    unreadCountElement.textContent = count;
    contactItem.appendChild(unreadCountElement);

    // Tambahkan class untuk gaya visual
    contactItem.classList.add('has-unread');
  } else {
    contactItem.classList.remove('has-unread');
  }
}





function setupMessageListener(roomId) {
    if (unsubscribeMessages) unsubscribeMessages();
    
    const user = auth.currentUser;
    if (!user) return;

    const messagesQuery = query(
        collection(db, 'chat_rooms', roomId, 'messages'),
        orderBy('timestamp', 'asc')
    );
    
    unsubscribeMessages = onSnapshot(messagesQuery, async (snapshot) => {
        messageBox.innerHTML = '';
        let hasUnreadForCurrentUser = false;
        
        snapshot.forEach((doc) => {
            const message = doc.data();
            const isSender = message.senderId === user.uid;
            
            // Tambahkan ID pesan ke data message untuk tracking
            const messageWithId = { ...message, id: doc.id };
            displayMessage(messageWithId, isSender);

            // Check jika pesan belum dibaca oleh penerima
            if (!isSender && (!message.readBy || !message.readBy[user.uid])) {
                hasUnreadForCurrentUser = true;
            }
        });
        
        messageBox.scrollTop = messageBox.scrollHeight;

        // Jika ada pesan yang belum dibaca, tandai sebagai sudah dibaca
        if (hasUnreadForCurrentUser) {
            await markMessagesAsRead(roomId, user.uid);
            
            // Perbarui daftar kontak untuk menghilangkan notifikasi unread
            const contacts = await fetchContacts();
            displayContacts(contacts);
        }
    });
}

function updateMessageStatus(messageId, updatedMessage) {
    const messageElement = document.querySelector(`.message-container[data-message-id="${messageId}"]`);
    if (!messageElement) return;

    const statusElement = messageElement.querySelector('.message-status');
    if (!statusElement) return;

    if (updatedMessage.readBy && Object.keys(updatedMessage.readBy).length > 1) {
        statusElement.innerHTML = '‚úì‚úì';
        statusElement.style.color = 'blue';
        statusElement.title = 'Dibaca';
    } else if (updatedMessage.delivered) {
        statusElement.innerHTML = '‚úì';
        statusElement.style.color = 'green';
        statusElement.title = 'Terkirim';
    } else {
        statusElement.innerHTML = '‚úì';
        statusElement.style.color = 'gray';
        statusElement.title = 'Mengirim...';
    }
}






// Fungsi untuk menampilkan pesan tersimpan yang diperbaiki
async function showSavedMessages() {
    const user = auth.currentUser;
    if (!user) {
        showSuccessMessage("Anda perlu login untuk melihat pesan tersimpan");
        return;
    }

    try {
        // Query pesan tersimpan dari Firestore
        const q = query(
            collection(db, 'users', user.uid, 'savedMessages'),
            orderBy('savedAt', 'desc')
        );
        const querySnapshot = await getDocs(q);

        // Container untuk pesan tersimpan
        const container = document.getElementById('savedMessagesContainer');
        container.innerHTML = '';

        if (querySnapshot.empty) {
            container.innerHTML = `
                <div class="empty-saved-messages">
                    <i class="fas fa-inbox"></i>
                    <p>Belum ada pesan tersimpan</p>
                </div>
            `;
        } else {
            querySnapshot.forEach((doc) => {
                const message = doc.data();
                const time = message.originalTimestamp?.toDate() || new Date();

                // Buat elemen untuk setiap pesan tersimpan
                const messageEl = document.createElement('div');
                messageEl.className = 'saved-message-item';
                messageEl.innerHTML = `
                    <div class="saved-message-header">
                        <div class="saved-message-avatar">
                            ${message.senderName?.charAt(0).toUpperCase() || '?'}
                        </div>
                        <div class="saved-message-info">
                            <div class="saved-message-sender">${message.senderName || 'Unknown'}</div>
                            <div class="saved-message-time">${time.toLocaleString()}</div>
                        </div>
                    </div>
                    <div class="saved-message-content">
                        ${message.content || '[Pesan tanpa teks]'}
                    </div>
                    <div class="saved-message-actions">
                        <button class="delete-saved-message" data-id="${doc.id}">
                            <i class="fas fa-trash"></i> Hapus
                        </button>
                    </div>
                `;

                // Tambahkan event listener untuk tombol hapus
                const deleteButton = messageEl.querySelector('.delete-saved-message');
                deleteButton.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    const messageId = e.currentTarget.dataset.id;
                    await deleteDoc(doc(db, 'users', user.uid, 'savedMessages', messageId));
                    showSuccessMessage("Pesan dihapus dari tersimpan");
                    showSavedMessages(); // Refresh the list
                });

                // Tambahkan pesan ke container
                container.appendChild(messageEl);
            });
        }

        // Tampilkan modal
        const modal = document.getElementById('savedMessagesModal');
        if (modal) {
            modal.classList.add('show');
        }
    } catch (error) {
        console.error("Error loading saved messages:", error);
        showSuccessMessage("Gagal memuat pesan tersimpan");
    }
}






// Tambahkan event listener ke tombol "Buka Pesan Tersimpan"
document.getElementById('openSavedMessagesBtn').addEventListener('click', () => {
  const user = auth.currentUser;
  if (!user) {
    showSuccessMessage("Anda perlu login untuk melihat pesan tersimpan.");
    return;
  }
  showSavedMessages();
});

// Tutup modal saat klik tombol √ó
document.querySelector('.close-saved-messages').addEventListener('click', () => {
    document.getElementById('savedMessagesModal').classList.remove('show');
});

// Tutup modal saat klik di luar konten
window.addEventListener('click', (event) => {
    const modal = document.getElementById('savedMessagesModal');
    if (event.target === modal) {
        modal.classList.remove('show');
    }
});


// Fungsi untuk menghapus pesan tersimpan
async function deleteSavedMessage(messageId) {
    const user = auth.currentUser;
    if (!user) return;

    try {
        await deleteDoc(doc(db, 'users', user.uid, 'savedMessages', messageId));
        showSuccessMessage("Pesan dihapus dari tersimpan");
        
        // Perbarui tampilan
        await showSavedMessages();
    } catch (error) {
        console.error("Error deleting saved message:", error);
        showSuccessMessage("Gagal menghapus pesan");
    }
}






// Initialize Group Chat
function initializeGroupChat() {
    try {
        // Tab switching
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', function() {
                const tab = this.dataset.tab;
                switchTab(tab);
            });
        });

        // Group creation button
        document.getElementById('createGroupBtn')?.addEventListener('click', openCreateGroupModal);

        // Confirm group creation
        document.getElementById('confirmCreateGroupBtn')?.addEventListener('click', createNewGroup);

        // Add member button
        document.getElementById('addMemberBtn')?.addEventListener('click', openAddMemberModal);

        // Confirm add member
        document.getElementById('confirmAddMemberBtn')?.addEventListener('click', addMembersToGroup);

        // Follow group button
        document.getElementById('followGroupBtn')?.addEventListener('click', toggleGroupFollow);

        // Send group message
        document.getElementById('sendGroupMessageBtn')?.addEventListener('click', sendGroupMessage);

        // Group message input
        document.getElementById('groupMessageInput')?.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') sendGroupMessage();
        });

        // Search inputs
        document.getElementById('searchUserInput')?.addEventListener('input', searchUsersForGroup);
        document.getElementById('searchContactInput')?.addEventListener('input', searchContactsForGroup);

        // Group search input
        document.getElementById('groupSearchInput')?.addEventListener('input', searchGroups);

        // Modal close buttons
        document.querySelectorAll('.close-modal').forEach(button => {
            button.addEventListener('click', function() {
                const modal = this.closest('.modal');
                if (modal) modal.style.display = 'none';
            });
        });

        // Event listener untuk tombol follow
        document.getElementById('followUserBtn')?.addEventListener('click', async () => {
            const userId = document.querySelector('.user-follow-section')?.dataset?.userId;
            if (userId) {
                await toggleUserFollow(userId);
            }
        });

        // Event listener untuk tombol lihat followers
        document.getElementById('showFollowersBtn')?.addEventListener('click', async () => {
            const userId = document.querySelector('.user-follow-section')?.dataset?.userId;
            if (userId) {
                await openFollowersModal(userId);
            }
        });

        // Event listener untuk menutup modal
        document.querySelector('.close-modal')?.addEventListener('click', () => {
            document.getElementById('userFollowersModal').style.display = 'none';
        });

        // Event listener untuk menutup modal saat klik di luar
        window.addEventListener('click', (event) => {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        });

        // Event listener untuk jumlah followers yang bisa diklik
        document.getElementById('followersCount')?.addEventListener('click', async () => {
            const userId = document.querySelector('.user-follow-section')?.dataset?.userId;
            if (userId) {
                await openFollowersModal(userId);
            }
        });

        // Close modals when clicking outside (This was a duplicate, integrated into the above window click listener)
        // window.addEventListener('click', function(event) {
        //     if (event.target.classList.contains('modal')) {
        //         event.target.style.display = 'none';
        //     }
        // });

        // Di dalam fungsi initializeGroupChat(), tambahkan event listener untuk pencarian anggota
        document.getElementById('searchMemberInput')?.addEventListener('input', function() {
            searchUsersForGroup(this.value, document.getElementById('memberSearchResults'), 'member');
        });

        // Tab switching antara "Cari Kontak" dan "Cari Pengguna" saat membuat grup
        document.querySelectorAll('.group-search-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                // Hapus class active dari semua tab
                document.querySelectorAll('.group-search-tab').forEach(t => t.classList.remove('active'));

                // Tambahkan class active ke tab yang diklik
                this.classList.add('active');

                const selectedTab = this.getAttribute('data-tab');

                // Tampilkan bagian yang sesuai
                if (selectedTab === 'contacts') {
                    document.getElementById('contactsSearchSection').style.display = 'block';
                    document.getElementById('usersSearchSection').style.display = 'none';
                } else if (selectedTab === 'users') {
                    document.getElementById('contactsSearchSection').style.display = 'none';
                    document.getElementById('usersSearchSection').style.display = 'block';
                }
            });
        });

        // Followers button for group
        document.getElementById('groupFollowersCount')?.addEventListener('click', openGroupFollowersModal);

        // Followers button for user profile
        document.getElementById('showFollowersBtn')?.addEventListener('click', function() {
            openUserFollowersModal(currentProfileUserId); // Assuming currentProfileUserId is defined elsewhere
        });
		
		    // Event listener for member follow buttons
        document.addEventListener('click', async (e) => {
            if (e.target.classList.contains('member-follow-btn')) {
                const userId = e.target.dataset.userId;
                if (!userId) return;
                
                const isFollowing = e.target.classList.contains('following');
                const result = await toggleUserFollow(userId);
                
                if (result !== null) {
                    e.target.textContent = result ? 'Mengikuti' : 'Ikuti';
                    e.target.classList.toggle('following', result);
                    
                    // Update counts in real-time
                    updateMemberFollowCounts(userId);
                    
                    // Show notification
                    showFollowNotification(userId, result);
                }
            }
        });
// Initialize follow system
        initializeFollowSystem();

        // Load groups if user is logged in
        if (auth.currentUser) {
            loadUserGroups();
        }

		
		 const requiredElements = [
            'createGroupBtn', 'confirmCreateGroupBtn', 'addMemberBtn',
            'confirmAddMemberBtn', 'followGroupBtn', 'sendGroupMessageBtn',
            'groupMessageInput', 'searchUserInput', 'searchContactInput',
            'groupSearchInput'
        ];

        for (const id of requiredElements) {
            if (!document.getElementById(id)) {
                console.error(`Element with ID ${id} not found`);
                return;
            }
        }

        // Follow user button
        document.getElementById('followUserBtn')?.addEventListener('click', toggleUserFollow);

        // Load groups if user is logged in
        // Make sure 'auth' is defined globally or passed into this function's scope.
        if (typeof auth !== 'undefined' && auth.currentUser) {
            loadUserGroups();
        }

    } catch (error) {
        console.error("Error initializing group chat:", error);
    }
}


function showFollowNotification(userId, isFollowing) {
    const notification = document.createElement('div');
    notification.className = 'follow-notification';
    notification.textContent = isFollowing ? 'Berhasil mengikuti pengguna' : 'Berhenti mengikuti pengguna';
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.classList.add('show');
    }, 10);
    
    setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => {
            notification.remove();
        }, 300);
    }, 3000);
}






































// Switch between personal and group chat tabs
function switchTab(tab) {
    const chatContainer = document.getElementById('chatContainer');
    const groupChatContainer = document.getElementById('groupChatContainer');
    
    if (!chatContainer || !groupChatContainer) return;
    
    if (tab === 'personal') {
        chatContainer.style.display = 'flex';
        groupChatContainer.style.display = 'none';
    } else {
        chatContainer.style.display = 'none';
        groupChatContainer.style.display = 'block';
    }
    
    // Update active tab styling
    document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.tab === tab);
    });
}



// Open create group modal
function openCreateGroupModal() {
    const modal = document.getElementById('createGroupModal');
    if (!modal) return;

    modal.style.display = 'flex';

    // Reset form
    document.getElementById('newGroupName').value = '';
    document.getElementById('newGroupBio').value = '';
    document.getElementById('searchUserInput').value = '';
    document.getElementById('searchContactInput').value = '';
    document.getElementById('userSearchResults').innerHTML = '';
    document.getElementById('contactSearchResults').innerHTML = '';
    document.getElementById('selectedMembers').innerHTML = '';

    selectedUsersForGroup = [];
}

// Close create group modal
function closeCreateGroupModal() {
    const modal = document.getElementById('createGroupModal');
    if (modal) modal.style.display = 'none';
}

// Search contacts for group creation
async function searchContactsForGroup() {
    try {
        const searchTerm = document.getElementById('searchContactInput').value.trim().toLowerCase();
        if (!searchTerm) {
            document.getElementById('contactSearchResults').innerHTML = '';
            document.getElementById('contactSearchResults').style.display = 'none';
            return;
        }

        const currentUser = auth.currentUser;
        if (!currentUser) {
            console.warn('User not logged in');
            return;
        }
        
        const contactsSnapshot = await getDocs(collection(db, 'users', currentUser.uid, 'contacts'));
        const results = [];
        
        const promises = contactsSnapshot.docs.map(async doc => {
            const userDoc = await getDoc(doc(db, 'users', doc.id));
            if (userDoc.exists()) {
                const userData = userDoc.data();
                const displayName = userData.displayName || userData.name || userData.email || 'Unknown';
                const email = userData.email || '';
                
                if (displayName.toLowerCase().includes(searchTerm) || email.toLowerCase().includes(searchTerm)) {
                    return {
                        id: doc.id,
                        name: displayName,
                        email,
                        photoURL: userData.photoURL
                    };
                }
            }
            return null;
        });

        const contacts = await Promise.all(promises);
        const filteredResults = contacts.filter(contact => contact !== null);

        const resultsContainer = document.getElementById('contactSearchResults');
        resultsContainer.innerHTML = '';
        
        if (filteredResults.length === 0) {
            resultsContainer.innerHTML = '<div class="no-results">No contacts found</div>';
        } else {
            filteredResults.forEach(user => {
                const userElement = document.createElement('div');
                userElement.className = 'search-result-item';
                userElement.innerHTML = `
                    <div class="search-result-avatar">
                        ${user.photoURL ? `<img src="${user.photoURL}" alt="${user.name}">` : 
                        `<span>${user.name.charAt(0)}</span>`}
                    </div>
                    <div class="search-result-info">
                        <div class="search-result-name">${user.name}</div>
                        <div class="search-result-email">${user.email}</div>
                    </div>
                `;
                userElement.addEventListener('click', () => selectUserForGroup(user));
                resultsContainer.appendChild(userElement);
            });
        }
        
        resultsContainer.style.display = 'block';
    } catch (error) {
        console.error("Error searching contacts:", error);
        document.getElementById('contactSearchResults').innerHTML = '<div class="error-message">Failed to load contacts</div>';
        document.getElementById('contactSearchResults').style.display = 'block';
    }
}



// Initialize follow system
function initializeFollowSystem() {
    // Close modals when clicking outside
    window.addEventListener('click', function(event) {
        if (event.target.classList.contains('modal')) {
            event.target.style.display = 'none';
        }
    });

    // Event delegation for follower/following count clicks
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('follow-count')) {
            const userId = e.target.closest('[data-user-id]')?.dataset?.userId;
            if (userId) {
                if (e.target.classList.contains('followers-count')) {
                    openUserFollowersModal(userId);
                } else if (e.target.classList.contains('following-count')) {
                    openUserFollowingModal(userId);
                }
            }
        }
    });
}




// Perbaikan fungsi searchUsersForGroup
async function searchUsersForGroup(searchTerm, resultsContainer, context = 'create') {
    try {
        // Jika searchTerm adalah string langsung (bukan event)
        const searchText = typeof searchTerm === 'string' ? searchTerm : searchTerm.target?.value || '';
        
        if (!resultsContainer) {
            resultsContainer = context === 'member' 
                ? document.getElementById('memberSearchResults')
                : document.getElementById('userSearchResults');
        }

        if (!searchText || searchText.length < 2) {
            resultsContainer.innerHTML = '';
            resultsContainer.style.display = 'none';
            return;
        }

        const currentUser = auth.currentUser;
        if (!currentUser) {
            console.warn('User not logged in');
            return;
        }

        const usersSnapshot = await getDocs(collection(db, 'users'));
        const results = [];

        usersSnapshot.forEach(doc => {
            const userData = doc.data();
            const displayName = userData.displayName || userData.name || userData.email || 'Unknown';
            const email = userData.email || '';
            
            // Skip current user
            if (doc.id === currentUser.uid) return;

            if (displayName.toLowerCase().includes(searchText.toLowerCase()) || 
               email.toLowerCase().includes(searchText.toLowerCase())) {
                results.push({
                    id: doc.id,
                    name: displayName,
                    email: email,
                    photoURL: userData.photoURL || ''
                });
            }
        });

        resultsContainer.innerHTML = '';
        
        if (results.length === 0) {
            resultsContainer.innerHTML = '<div class="no-results">No users found</div>';
        } else {
            results.forEach(user => {
                const userElement = document.createElement('div');
                userElement.className = 'search-result-item';
                userElement.innerHTML = `
                    <div class="search-result-avatar">
                        ${user.photoURL ? `<img src="${user.photoURL}" alt="${user.name}">` : 
                        `<span>${user.name.charAt(0)}</span>`}
                    </div>
                    <div class="search-result-info">
                        <div class="search-result-name">${user.name}</div>
                        <div class="search-result-email">${user.email}</div>
                    </div>
                `;
                userElement.addEventListener('click', () => selectUserForGroup(user, context));
                resultsContainer.appendChild(userElement);
            });
        }
        
        resultsContainer.style.display = 'block';
    } catch (error) {
        console.error("Error searching users:", error);
        if (resultsContainer) {
            resultsContainer.innerHTML = '<div class="error-message">Failed to load users</div>';
            resultsContainer.style.display = 'block';
        }
    }
}


async function showUserProfile(targetUserId) {
    const currentUser = auth.currentUser;
    const followBtn = document.getElementById('followUserBtn');

    if (!currentUser || !targetUserId) return;

    if (currentUser.uid === targetUserId) {
        // Jangan tampilkan tombol follow untuk akun sendiri
        followBtn.style.display = 'none';
        return;
    }

    // Cek apakah sudah di-follow
    const followDoc = await getDoc(doc(db, 'users', targetUserId, 'followers', currentUser.uid));
    const isFollowing = followDoc.exists();

    followBtn.textContent = isFollowing ? 'Unfollow' : 'Follow';
    followBtn.style.backgroundColor = isFollowing ? '#f44336' : '#4CAF50';
    followBtn.style.display = 'inline-block';

    followBtn.onclick = async () => {
        if (isFollowing) {
            // Unfollow
            await Promise.all([
                deleteDoc(doc(db, 'users', targetUserId, 'followers', currentUser.uid)),
                deleteDoc(doc(db, 'users', currentUser.uid, 'following', targetUserId))
            ]);
            followBtn.textContent = 'Follow';
            followBtn.style.backgroundColor = '#4CAF50';
        } else {
            // Follow
            await Promise.all([
                setDoc(doc(db, 'users', targetUserId, 'followers', currentUser.uid), {
                    followedAt: serverTimestamp()
                }),
                setDoc(doc(db, 'users', currentUser.uid, 'following', targetUserId), {
                    followedAt: serverTimestamp()
                })
            ]);
            followBtn.textContent = 'Unfollow';
            followBtn.style.backgroundColor = '#f44336';
        }
    };
}



















// Perbaikan fungsi selectUserForGroup
function selectUserForGroup(user, context = 'create') {
    if (!user || !user.id) return;
    
    let targetArray, targetContainer;
    
    if (context === 'member') {
        // Untuk modal tambah anggota
        if (!window.selectedUsersToAddForGroup) {
            window.selectedUsersToAddForGroup = [];
        }
        targetArray = window.selectedUsersToAddForGroup;
        targetContainer = document.getElementById('selectedMembersToAdd');
    } else {
        // Untuk modal buat grup baru
        targetArray = selectedUsersForGroup;
        targetContainer = document.getElementById('selectedMembers');
    }

    // Cek apakah user sudah dipilih
    const isAlreadySelected = targetArray.some(u => u.id === user.id);
    
    if (!isAlreadySelected) {
        targetArray.push(user);
        updateSelectedMembersDisplay(targetArray, targetContainer.id);
    }
}





// Perbaikan fungsi updateSelectedMembersDisplay
function updateSelectedMembersDisplay(usersArray, containerId) {
    const container = document.getElementById(containerId);
    if (!container) return;
    
    container.innerHTML = '';
    
    if (!usersArray || usersArray.length === 0) {
        container.innerHTML = '<div class="no-members">No members selected</div>';
        return;
    }
    
    usersArray.forEach(user => {
        const memberElement = document.createElement('div');
        memberElement.className = 'selected-member';
        memberElement.innerHTML = `
            ${user.name}
            <button onclick="removeSelectedMember('${user.id}', '${containerId}')">&times;</button>
        `;
        container.appendChild(memberElement);
    });
}

// Perbaikan fungsi removeSelectedMember
function removeSelectedMember(userId, containerId) {
    let targetArray;
    
    if (containerId === 'selectedMembersToAdd') {
        targetArray = window.selectedUsersToAddForGroup;
    } else {
        targetArray = selectedUsersForGroup;
    }
    
    if (!targetArray) return;
    
    // Filter out the user to remove
    const newArray = targetArray.filter(u => u.id !== userId);
    
    // Update the correct array
    if (containerId === 'selectedMembersToAdd') {
        window.selectedUsersToAddForGroup = newArray;
    } else {
        selectedUsersForGroup = newArray;
    }
    
    updateSelectedMembersDisplay(newArray, containerId);
}

















async function createNewGroup() {
    const groupName = document.getElementById('newGroupName').value.trim();
    const groupBio = document.getElementById('newGroupBio').value.trim();

    if (!groupName) {
        alert("Nama grup tidak boleh kosong");
        return;
    }

    const currentUser = auth.currentUser;
    if (!currentUser) {
        alert("Anda harus login untuk membuat grup");
        return;
    }

    // Tambahkan user login ke selectedUsersForGroup jika belum ada
    if (!selectedUsersForGroup.some(user => user.id === currentUser.uid)) {
        selectedUsersForGroup.unshift({
            id: currentUser.uid,
            name: currentUser.displayName || currentUser.email,
            email: currentUser.email,
            photoURL: currentUser.photoURL || ''
        });
    }

    if (selectedUsersForGroup.length === 0) {
        alert("Silakan tambahkan minimal satu anggota ke grup");
        return;
    }

    try {
        const createButton = document.getElementById('confirmCreateGroupBtn');
        if (createButton) {
            createButton.disabled = true;
            createButton.textContent = "Membuat Grup...";
        }

        // Ambil semua ID member tanpa duplikat
        const members = [...new Set(selectedUsersForGroup.map(user => user.id))];

        const groupData = {
            name: groupName,
            bio: groupBio,
            photoURL: '',
            members: members,
            followers: [currentUser.uid],
            createdBy: currentUser.uid,
            createdAt: serverTimestamp(),
            lastMessageAt: serverTimestamp(),
            lastUpdated: serverTimestamp()
        };

        const groupRef = await addDoc(collection(db, 'chat_groups'), groupData);

        const batch = writeBatch(db);
        members.forEach(memberId => {
            const userGroupRef = doc(db, 'users', memberId, 'groups', groupRef.id);
            batch.set(userGroupRef, {
                joinedAt: serverTimestamp(),
                lastSeen: serverTimestamp()
            });
        });

        await batch.commit();

        // Reset form dan UI
        document.getElementById('newGroupName').value = '';
        document.getElementById('newGroupBio').value = '';
        selectedUsersForGroup = [];
        updateSelectedMembersDisplay();

        // Tutup modal dan refresh
        closeCreateGroupModal();
        loadUserGroups();
        showGroupDetail(groupRef.id);

    } catch (error) {
        console.error("Gagal membuat grup:", error);
        alert("Terjadi kesalahan saat membuat grup");
    } finally {
        const createButton = document.getElementById('confirmCreateGroupBtn');
        if (createButton) {
            createButton.disabled = false;
            createButton.textContent = "Buat Grup";
        }
    }
}



function initializeGroupFollowSystem() {
    // Event listener untuk tombol follow di anggota grup
    document.addEventListener('click', async function(e) {
        if (e.target.classList.contains('member-follow-btn')) {
            const followBtn = e.target;
            const userId = followBtn.dataset.userId;
            
            try {
                // Toggle follow status
                const isNowFollowing = await toggleUserFollow(userId);
                
                // Update tombol UI
                followBtn.textContent = isNowFollowing ? 'Mengikuti' : 'Ikuti';
                followBtn.classList.toggle('following', isNowFollowing);
                
                // Update counts
                await updateFollowCounts(userId);
                
            } catch (error) {
                console.error("Error toggling follow:", error);
            }
        }
        
        // Tombol lihat followers
        if (e.target.id === 'followersCountBtn') {
            const userId = e.target.closest('.user-follow-section').dataset.userId;
            openFollowersModal(userId);
        }
        
        // Tombol lihat following
        if (e.target.id === 'followingCountBtn') {
            const userId = e.target.closest('.user-follow-section').dataset.userId;
            openFollowingModal(userId);
        }
    });
}





// Get the last message in a group
async function getLastGroupMessage(groupId) {
    try {
        const q = query(
            collection(db, 'chat_groups', groupId, 'messages'),
            orderBy('timestamp', 'desc'),
            limit(1)
        );
        
        const snapshot = await getDocs(q);
        if (snapshot.empty) return null;
        
        return snapshot.docs[0].data();
    } catch (error) {
        console.error("Error getting last group message:", error);
        return null;
    }
}

// Create group list item
function createGroupListItem(group) {
    const groupElement = document.createElement('div');
    groupElement.className = 'group-item';
    groupElement.dataset.groupId = group.id;
    
    const time = group.lastMessageTime?.toDate?.();
    const timeString = time ? time.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '';
    
    groupElement.innerHTML = `
        <div class="group-item-avatar">
            ${group.photoURL ? `<img src="${group.photoURL}" alt="${group.name}">` : 
              `<span>${group.name.charAt(0)}</span>`}
        </div>
        <div class="group-item-info">
            <div class="group-item-name">${group.name}</div>
            <div class="group-item-last">${group.lastMessage}</div>
        </div>
        <div class="group-item-time">${timeString}</div>
        <div class="group-item-members">${group.members.length} members</div>
    `;
    
    groupElement.addEventListener('click', () => {
        showGroupDetail(group.id);
        updateLastSeen(group.id);
    });
    
    return groupElement;
}

// Show group details
async function showGroupDetail(groupId) {
    currentGroupId = groupId;
    
    try {
        const groupDoc = await getDoc(doc(db, 'chat_groups', groupId));
        if (!groupDoc.exists()) {
            alert("Group not found");
            return;
        }
        
        currentGroupData = groupDoc.data();
        
        // Update UI elements
        document.getElementById('groupDisplayName').textContent = currentGroupData.name;
        document.getElementById('groupDisplayBio').textContent = currentGroupData.bio || "No description";
        
        // Format creation date
        const createdAt = currentGroupData.createdAt?.toDate?.();
        const lastUpdated = currentGroupData.lastUpdated?.toDate?.();
        
        let dateInfo = '';
        if (createdAt) {
            dateInfo = `Created: ${createdAt.toLocaleDateString()}`;
            if (lastUpdated && lastUpdated.getTime() !== createdAt.getTime()) {
                dateInfo += ` | Updated: ${lastUpdated.toLocaleDateString()}`;
            }
        }
        document.getElementById('groupCreatedAt').textContent = dateInfo || 'Date unknown';
        
        // Update counts
        document.getElementById('groupMemberCount').textContent = `${currentGroupData.members?.length || 0} members`;
        document.getElementById('groupFollowersCount').textContent = `${currentGroupData.followers?.length || 0} followers`;
        
        // Update group photo
        const groupDisplayPhoto = document.getElementById('groupDisplayPhoto');
        if (currentGroupData.photoURL) {
            groupDisplayPhoto.innerHTML = `<img src="${currentGroupData.photoURL}" alt="${currentGroupData.name}">`;
        } else {
            groupDisplayPhoto.innerHTML = `<span>${currentGroupData.name.charAt(0)}</span>`;
        }
        
        // Update follow button
        const currentUser = auth.currentUser;
        const isFollowing = currentGroupData.followers?.includes(currentUser.uid);
        const followButton = document.getElementById('followGroupBtn');
        followButton.textContent = isFollowing ? 'Unfollow Group' : 'Follow Group';
        followButton.style.backgroundColor = isFollowing ? '#f44336' : '#4CAF50';
        
        // Show/hide add member button based on admin status
        const isAdmin = currentGroupData.createdBy === currentUser.uid;
        document.getElementById('addMemberBtn').style.display = isAdmin ? 'block' : 'none';
        
        // Load members and messages
        loadGroupMembers(currentGroupData.members);
        loadGroupMessages(groupId);
        
        // Show group detail view
        document.getElementById('noGroupSelected').style.display = 'none';
        document.getElementById('groupDetailView').style.display = 'block';
        
        // Update last seen
        updateLastSeen(groupId);
    } catch (error) {
        console.error("Error loading group details:", error);
        alert("Failed to load group details");
    }
}


// Initialize when DOM is loaded
document.addEventListener('DOMContentLoaded', () => {
    initializeGroupChat();
    
    // Close modals when clicking X
    document.querySelectorAll('.close-modal').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.modal').forEach(modal => {
                modal.style.display = 'none';
            });
        });
    });
});



async function loadGroupMembers(memberIds) {
    const memberList = document.getElementById('memberList');
    if (!memberList) return;
    
    memberList.innerHTML = '<li class="loading">Memuat anggota grup...</li>';
    
    try {
        const currentUser = auth.currentUser;
        if (!currentUser) {
            memberList.innerHTML = '<li class="login-prompt">Silakan login untuk melihat anggota grup</li>';
            return;
        }

        const members = await Promise.all(memberIds.map(async memberId => {
            const userDoc = await getDoc(doc(db, 'users', memberId));
            let isFollowing = false;

            if (memberId !== currentUser.uid) {
                const followDoc = await getDoc(doc(db, 'users', currentUser.uid, 'following', memberId));
                isFollowing = followDoc.exists();
            }

            // Get follow counts
            const userData = userDoc.exists() ? userDoc.data() : {};
            const followersCount = userData.followersCount || 0;
            const followingCount = userData.followingCount || 0;

            return {
                id: memberId,
                name: userDoc.exists() ? (userDoc.data().displayName || userDoc.data().email) : 'Unknown',
                email: userDoc.exists() ? userDoc.data().email : '',
                photoURL: userDoc.exists() ? userDoc.data().photoURL : '',
                isCurrentUser: memberId === currentUser.uid,
                isFollowing: isFollowing,
                followersCount,
                followingCount
            };
        }));

        memberList.innerHTML = '';
        
        members.forEach(member => {
            const memberItem = document.createElement('li');
            memberItem.className = 'member-item';
            memberItem.dataset.userId = member.id;
            
            let followButton = '';
            if (!member.isCurrentUser) {
                followButton = `
                    <button class="member-follow-btn ${member.isFollowing ? 'following' : ''}" 
                            data-user-id="${member.id}">
                        ${member.isFollowing ? 'Mengikuti' : 'Ikuti'}
                    </button>
                `;
            }
            
            memberItem.innerHTML = `
                <div class="member-info">
                    <div class="member-avatar">
                        ${member.photoURL ? `<img src="${member.photoURL}" alt="${member.name}">` : 
                         `<span>${member.name.charAt(0)}</span>`}
                    </div>
                    <div class="member-details">
                        <div class="member-name">${member.name}</div>
                        ${member.email ? `<div class="member-email">${member.email}</div>` : ''}
                    </div>
                </div>
                <div class="member-actions">
                    ${followButton}
                    <div class="member-follow-stats" data-user-id="${member.id}">
                        <span class="follow-count followers-count" data-user-id="${member.id}">
                            ${member.followersCount} Pengikut
                        </span>
                        <span class="follow-count following-count" data-user-id="${member.id}">
                            ${member.followingCount} Mengikuti
                        </span>
                    </div>
                </div>
            `;
            
            memberList.appendChild(memberItem);
            
            // Setup real-time updates for this member's follow counts
            setupRealtimeFollowUpdates(member.id);
        });

        // Add event listeners for follow counts
        document.querySelectorAll('.follow-count').forEach(element => {
            element.addEventListener('click', (e) => {
                const userId = e.target.dataset.userId;
                const isFollowers = e.target.classList.contains('followers-count');
                
                if (isFollowers) {
                    openUserFollowersModal(userId);
                } else {
                    openUserFollowingModal(userId);
                }
            });
        });

    } catch (error) {
        console.error("Error loading group members:", error);
        memberList.innerHTML = '<li class="error">Gagal memuat anggota grup</li>';
    }
}



async function updateFollowCounts(userId) {
    try {
        const userDoc = await getDoc(doc(db, 'users', userId));
        if (!userDoc.exists()) return;

        const userData = userDoc.data();
        
        // Update all followers count elements
        document.querySelectorAll(`.followers-count[data-user-id="${userId}"]`).forEach(el => {
            el.textContent = `${userData.followersCount || 0} Pengikut`;
        });
        
        // Update all following count elements
        document.querySelectorAll(`.following-count[data-user-id="${userId}"]`).forEach(el => {
            el.textContent = `${userData.followingCount || 0} Mengikuti`;
        });
        
    } catch (error) {
        console.error("Error updating follow counts:", error);
    }
}






async function updateMemberFollowCounts(userId) {
    try {
        const userDoc = await getDoc(doc(db, 'users', userId));
        if (!userDoc.exists()) return;

        const followersCount = userDoc.data().followersCount || 0;
        const followingCount = userDoc.data().followingCount || 0;
        
        // Update all elements with this user ID
        document.querySelectorAll(`.member-follow-stats[data-user-id="${userId}"]`).forEach(el => {
            el.innerHTML = `
                <span class="follow-count followers-count" data-user-id="${userId}">${followersCount} Pengikut</span>
                <span class="follow-count following-count" data-user-id="${userId}">${followingCount} Mengikuti</span>
            `;
        });
    } catch (error) {
        console.error("Error updating member follow counts:", error);
    }
}













// Fungsi untuk menampilkan bagian follow anggota grup
function showMemberFollowSection(memberId) {
  currentMemberId = memberId;
  const section = document.querySelector('.member-follow-section');
  section.style.display = 'flex';
  
  // Load data follow
  loadMemberFollowData(memberId);
}

// Fungsi untuk memuat data follow anggota
async function loadMemberFollowData(memberId) {
  if (!memberId) return;
  
  try {
    // Ambil data user dari Firestore
    const userDoc = await getDoc(doc(db, 'users', memberId));
    
    if (userDoc.exists()) {
      const userData = userDoc.data();
      
      // Update counter
      document.getElementById('memberFollowersCount').textContent = userData.followersCount || 0;
      document.getElementById('memberFollowingCount').textContent = userData.followingCount || 0;
      
      // Update tombol follow
      const currentUser = auth.currentUser;
      if (currentUser && currentUser.uid !== memberId) {
        const followDoc = await getDoc(doc(db, 'users', memberId, 'followers', currentUser.uid));
        const followBtn = document.getElementById('memberFollowBtn');
        
        if (followDoc.exists()) {
          followBtn.textContent = 'Mengikuti';
          followBtn.classList.add('following');
        } else {
          followBtn.textContent = 'Ikuti';
          followBtn.classList.remove('following');
        }
      }
    }
  } catch (error) {
    console.error("Error loading member follow data:", error);
  }
}





document.getElementById('memberFollowBtn')?.addEventListener('click', async () => {
  if (!currentMemberId) return;
  
  try {
    const followBtn = document.getElementById('memberFollowBtn');
    const isFollowing = followBtn.classList.contains('following');
    
    // Toggle follow status
    await toggleFollowStatus(currentMemberId, !isFollowing);
    
    // Update UI
    if (isFollowing) {
      followBtn.textContent = 'Ikuti';
      followBtn.classList.remove('following');
    } else {
      followBtn.textContent = 'Mengikuti';
      followBtn.classList.add('following');
    }
    
    // Update counts
    await loadMemberFollowData(currentMemberId);
    
  } catch (error) {
    console.error("Error toggling follow:", error);
  }
});


async function loadUserGroups() {
  try {
    const userId = auth.currentUser?.uid;
    if (!userId) {
      console.warn("User belum login. Tidak bisa memuat grup.");
      return;
    }

    const groupListContainer = document.getElementById('groupList');
    if (!groupListContainer) return;

    groupListContainer.innerHTML = '<div class="loading">Memuat grup Anda...</div>';

    const querySnapshot = await getDocs(query(
      collection(db, 'groups'),
      where('members', 'array-contains', userId)
    ));

    if (querySnapshot.empty) {
      groupListContainer.innerHTML = '<div class="empty">Belum tergabung dalam grup apa pun.</div>';
      return;
    }

    groupListContainer.innerHTML = ''; // Kosongkan container
    querySnapshot.forEach(docSnap => {
      const group = docSnap.data();
      const groupId = docSnap.id;

      groupListContainer.innerHTML += `
        <div class="group-item" data-group-id="${groupId}">
          <div class="group-name">${group.name || 'Tanpa Nama'}</div>
          <div class="group-bio">${group.bio || '-'}</div>
        </div>
      `;
    });

    // Tambahkan event listener ke setiap item grup
    document.querySelectorAll('.group-item').forEach(item => {
      item.addEventListener('click', () => {
        const groupId = item.dataset.groupId;
        if (groupId) {
          openGroupChat(groupId);
        }
      });
    });

  } catch (error) {
    console.error("Gagal memuat grup pengguna:", error);
    const groupListContainer = document.getElementById('groupList');
    if (groupListContainer) {
      groupListContainer.innerHTML = '<div class="error">Gagal memuat daftar grup</div>';
    }
  }
}




async function toggleFollowStatus(targetUserId, follow) {
  const currentUser = auth.currentUser;
  if (!currentUser) return;

  const batch = writeBatch(db);
  
  if (follow) {
    // Follow user
    batch.set(doc(db, 'users', targetUserId, 'followers', currentUser.uid), {
      followedAt: serverTimestamp()
    });
    batch.set(doc(db, 'users', currentUser.uid, 'following', targetUserId), {
      followedAt: serverTimestamp()
    });
    batch.update(doc(db, 'users', targetUserId), {
      followersCount: increment(1)
    });
    batch.update(doc(db, 'users', currentUser.uid), {
      followingCount: increment(1)
    });
  } else {
    // Unfollow user
    batch.delete(doc(db, 'users', targetUserId, 'followers', currentUser.uid));
    batch.delete(doc(db, 'users', currentUser.uid, 'following', targetUserId));
    batch.update(doc(db, 'users', targetUserId), {
      followersCount: increment(-1)
    });
    batch.update(doc(db, 'users', currentUser.uid), {
      followingCount: increment(-1)
    });
  }

  await batch.commit();
}




// Event listener untuk tombol followers/following
document.querySelector('.followers-btn')?.addEventListener('click', () => {
  if (!currentMemberId) return;
  showMemberFollowers(currentMemberId);
});

document.querySelector('.following-btn')?.addEventListener('click', () => {
  if (!currentMemberId) return;
  showMemberFollowing(currentMemberId);
});

// Fungsi untuk menampilkan daftar followers anggota
async function showMemberFollowers(userId) {
  const modal = document.getElementById('memberFollowersModal');
  const list = document.getElementById('memberFollowersList');
  
  modal.style.display = 'block';
  list.innerHTML = '<div class="loading">Memuat daftar pengikut...</div>';
  
  try {
    const followersSnapshot = await getDocs(collection(db, 'users', userId, 'followers'));
    const followers = [];
    
    for (const doc of followersSnapshot.docs) {
      const userDoc = await getDoc(doc(db, 'users', doc.id));
      if (userDoc.exists()) {
        followers.push({
          id: doc.id,
          name: userDoc.data().displayName || userDoc.data().email,
          photoURL: userDoc.data().photoURL
        });
      }
    }
    
    renderUserList(followers, list);
  } catch (error) {
    console.error("Error loading followers:", error);
    list.innerHTML = '<div class="error">Gagal memuat daftar pengikut</div>';
  }
}

// Fungsi untuk menampilkan daftar following anggota
async function showMemberFollowing(userId) {
  const modal = document.getElementById('memberFollowingModal');
  const list = document.getElementById('memberFollowingList');
  
  modal.style.display = 'block';
  list.innerHTML = '<div class="loading">Memuat daftar yang diikuti...</div>';
  
  try {
    const followingSnapshot = await getDocs(collection(db, 'users', userId, 'following'));
    const following = [];
    
    for (const doc of followingSnapshot.docs) {
      const userDoc = await getDoc(doc(db, 'users', doc.id));
      if (userDoc.exists()) {
        following.push({
          id: doc.id,
          name: userDoc.data().displayName || userDoc.data().email,
          photoURL: userDoc.data().photoURL
        });
      }
    }
    
    renderUserList(following, list);
  } catch (error) {
    console.error("Error loading following:", error);
    list.innerHTML = '<div class="error">Gagal memuat daftar yang diikuti</div>';
  }
}


function renderUserList(users, containerId) {
    const container = document.getElementById(containerId);
    if (!container) return;
    
    container.innerHTML = '';
    
    if (!users || users.length === 0) {
        container.innerHTML = '<div class="empty">Tidak ada data</div>';
        return;
    }
    
    const currentUser = auth.currentUser;
    
    users.forEach(user => {
        const userElement = document.createElement('div');
        userElement.className = 'user-item';
        userElement.dataset.userId = user.id;

        let followButton = '';
        if (!user.isCurrentUser && currentUser) {
            followButton = `
                <button class="follow-btn ${user.isFollowing ? 'following' : ''}" 
                        data-user-id="${user.id}">
                    ${user.isFollowing ? 'Mengikuti' : 'Ikuti'}
                </button>
            `;
        }
        
        let currentUserBadge = '';
        if (user.isCurrentUser) {
            currentUserBadge = '<div class="user-badge">Anda</div>';
        }

        userElement.innerHTML = `
            <div class="user-avatar">
                ${user.photoURL ? `<img src="${user.photoURL}" alt="${user.name}">` : 
                 `<span>${user.name.charAt(0)}</span>`}
            </div>
            <div class="user-info">
                <div class="user-name">${user.name} ${currentUserBadge}</div>
                ${user.email ? `<div class="user-email">${user.email}</div>` : ''}
            </div>
            ${followButton}
        `;

        container.appendChild(userElement);
    });

    // Setup event listeners for follow buttons
    setupFollowButtons(container);
}




function setupFollowButtons(container) {
    container.querySelectorAll('.follow-btn').forEach(btn => {
        btn.addEventListener('click', async function() {
            const userId = this.dataset.userId;
            if (!userId) return;
            
            try {
                this.disabled = true;
                const result = await toggleUserFollow(userId);
                
                if (result !== null) {
                    this.textContent = result ? 'Mengikuti' : 'Ikuti';
                    this.classList.toggle('following', result);
                    
                    // Update counts in real-time
                    updateFollowCounts(userId);
                    if (auth.currentUser) {
                        updateFollowCounts(auth.currentUser.uid);
                    }
                }
            } catch (error) {
                console.error("Error toggling follow:", error);
            } finally {
                this.disabled = false;
            }
        });
    });
}


function setupRealtimeFollowUpdates(userId, type, listId) {
    // Pastikan semua parameter ada dan valid
    if (!userId || !type || !listId) {
        console.warn('setupRealtimeFollowUpdates: parameter tidak lengkap');
        return;
    }

    // Unsubscribe listener sebelumnya (jika ada)
    if (window[`unsubscribe_${type}`]) {
        window[`unsubscribe_${type}`]();
    }

    const collectionName = type === 'followers' ? 'followers' : 'following';

    // Set listener baru
    window[`unsubscribe_${type}`] = onSnapshot(
        collection(db, 'users', userId, collectionName),
        async () => {
            try {
                const users = await loadFollowData(userId, type);
                renderUserList(users, listId); // Pastikan renderUserList ada
            } catch (error) {
                console.error(`Error updating ${type} list:`, error);
                const container = document.getElementById(listId);
                if (container) {
                    container.innerHTML = `<div class="error">Gagal memperbarui daftar ${type}</div>`;
                }
            }
        }
    );
}





function updateFollowButton(targetUserId, isFollowing) {
    // Update main follow button
    const followButton = document.getElementById('followUserBtn');
    if (followButton && followButton.dataset.userId === targetUserId) {
        followButton.textContent = isFollowing ? 'Mengikuti' : 'Ikuti';
        followButton.classList.toggle('following', isFollowing);
    }
    
    // Update all follow buttons for this user in members list
    document.querySelectorAll(`.member-follow-btn[data-user-id="${targetUserId}"]`).forEach(btn => {
        btn.textContent = isFollowing ? 'Mengikuti' : 'Ikuti';
        btn.classList.toggle('following', isFollowing);
    });
    
    // Update follow buttons in open modals
    document.querySelectorAll(`.follow-btn[data-user-id="${targetUserId}"]`).forEach(btn => {
        btn.textContent = isFollowing ? 'Mengikuti' : 'Ikuti';
        btn.classList.toggle('following', isFollowing);
    });
}

async function openGroupChat(groupId) {
  try {
    const groupDoc = await getDoc(doc(db, 'groups', groupId));
    if (!groupDoc.exists()) {
      console.warn('Grup tidak ditemukan:', groupId);
      return;
    }

    const groupData = groupDoc.data();

    // Tampilkan detail di UI
    document.getElementById('groupDisplayName').textContent = groupData.name || 'Tanpa Nama';
    document.getElementById('groupDisplayBio').textContent = groupData.bio || '-';
    document.getElementById('groupCreatedAt').textContent = groupData.createdAt?.toDate().toLocaleString() || '-';
    document.getElementById('groupMemberCount').textContent = `${groupData.members.length} anggota`;

    // Tampilkan kontainer chat
    document.getElementById('noGroupSelected').style.display = 'none';
    document.getElementById('groupDetailView').style.display = 'block';

    // Muat pesan dan anggota
    loadGroupMessages(groupId);
    loadGroupMembers(groupId);
    setupGroupFollowUI(groupId);

  } catch (error) {
    console.error('Gagal membuka grup:', error);
  }
}







// Fungsi helper untuk format tanggal
function formatDate(date) {
    if (!date) return '';
    return date.toLocaleDateString('id-ID', {
        year: 'numeric',
        month: 'long',
        day: 'numeric'
    });
}


function openFollowersModal(userId) {
    const modal = document.getElementById('followersModal');
    if (!modal) return;
    
    modal.style.display = 'flex';
    modal.dataset.userId = userId;
    
    const followersList = document.getElementById('followersList');
    followersList.innerHTML = '<div class="loading">Memuat daftar pengikut...</div>';
    
    // Load followers data
    loadFollowersData(userId);
}

// Fungsi untuk membuka modal following
async function openFollowingModal(userId) {
    const modal = document.getElementById('followingModal');
    if (!modal) return;
    
    modal.style.display = 'flex';
    document.getElementById('followingList').innerHTML = '<div class="loading">Memuat daftar yang diikuti...</div>';
    
    try {
        const followingSnapshot = await getDocs(collection(db, 'users', userId, 'following'));
        const following = [];
        
        for (const doc of followingSnapshot.docs) {
            const userDoc = await getDoc(doc(db, 'users', doc.id));
            if (userDoc.exists()) {
                following.push({
                    id: doc.id,
                    name: userDoc.data().displayName || userDoc.data().email,
                    photoURL: userDoc.data().photoURL
                });
            }
        }
        
        displayUserList(following, 'followingList');
    } catch (error) {
        console.error("Error loading following:", error);
        document.getElementById('followingList').innerHTML = '<div class="error">Gagal memuat daftar yang diikuti</div>';
    }
}

async function loadFollowersData(userId) {
  const followersList = document.getElementById('userFollowersList');
  if (!followersList) return;

  followersList.innerHTML = '<div class="loading">Memuat daftar pengikut...</div>';

  try {
    const snapshot = await getDocs(collection(db, 'users', userId, 'followers'));

    if (snapshot.empty) {
      followersList.innerHTML = '<div class="no-followers">Belum ada pengikut</div>';
      return;
    }

    const followers = await Promise.all(snapshot.docs.map(async docSnap => {
      const followerUserId = docSnap.id;
      const userDoc = await getDoc(doc(db, 'users', followerUserId));
      if (!userDoc.exists()) return null;

      const data = userDoc.data();
      return {
        id: followerUserId,
        name: data.displayName || data.email || 'Unknown',
        email: data.email || '',
        photoURL: data.photoURL || ''
      };
    }));

    followersList.innerHTML = '';
    followers.filter(Boolean).forEach(user => {
      followersList.innerHTML += `
        <div class="user-item">
          <div class="user-avatar">
            ${user.photoURL ? `<img src="${user.photoURL}" alt="${user.name}">` : `<span>${user.name.charAt(0)}</span>`}
          </div>
          <div class="user-info">
            <div class="user-name">${user.name}</div>
            <div class="user-email">${user.email}</div>
          </div>
        </div>
      `;
    });

  } catch (error) {
    console.error("Error loading followers:", error);
    followersList.innerHTML = '<div class="error">Gagal memuat daftar pengikut</div>';
  }
}




async function loadFollowingData(userId) {
  const followingList = document.getElementById('userFollowingList');
  if (!followingList) return;

  followingList.innerHTML = '<div class="loading">Memuat daftar yang diikuti...</div>';

  try {
    const snapshot = await getDocs(collection(db, 'users', userId, 'following'));

    if (snapshot.empty) {
      followingList.innerHTML = '<div class="no-following">Belum mengikuti siapapun</div>';
      return;
    }

    const following = await Promise.all(snapshot.docs.map(async docSnap => {
      const followedUserId = docSnap.id;
      const userDoc = await getDoc(doc(db, 'users', followedUserId));
      if (!userDoc.exists()) return null;

      const data = userDoc.data();
      return {
        id: followedUserId,
        name: data.displayName || data.email || 'Unknown',
        email: data.email || '',
        photoURL: data.photoURL || ''
      };
    }));

    followingList.innerHTML = '';
    following.filter(Boolean).forEach(user => {
      followingList.innerHTML += `
        <div class="user-item">
          <div class="user-avatar">
            ${user.photoURL ? `<img src="${user.photoURL}" alt="${user.name}">` : `<span>${user.name.charAt(0)}</span>`}
          </div>
          <div class="user-info">
            <div class="user-name">${user.name}</div>
            <div class="user-email">${user.email}</div>
          </div>
        </div>
      `;
    });

  } catch (error) {
    console.error("Error loading following:", error);
    followingList.innerHTML = '<div class="error">Gagal memuat daftar yang diikuti</div>';
  }
}


document.getElementById('followersCount')?.addEventListener('click', () => {
  const userId = document.querySelector('.user-follow-section')?.dataset.userId;
  if (userId) openUserFollowersModal(userId);
});

document.getElementById('followingCount')?.addEventListener('click', () => {
  const userId = document.querySelector('.user-follow-section')?.dataset.userId;
  if (userId) openUserFollowingModal(userId);
});







// Load group messages
function loadGroupMessages(groupId) {
    const messageBox = document.getElementById('groupMessageBox');
    messageBox.innerHTML = '<div class="loading-messages">Loading messages...</div>';
    
    if (unsubscribeGroupMessages) unsubscribeGroupMessages();
    
    const q = query(
        collection(db, 'chat_groups', groupId, 'messages'),
        orderBy('timestamp', 'asc')
    );
    
    unsubscribeGroupMessages = onSnapshot(q, (snapshot) => {
        messageBox.innerHTML = '';
        
        if (snapshot.empty) {
            messageBox.innerHTML = '<div class="no-messages">No messages in this group yet</div>';
            return;
        }
        
        snapshot.forEach(doc => {
            const message = doc.data();
            displayGroupMessage(message);
        });
        
        // Scroll to bottom
        messageBox.scrollTop = messageBox.scrollHeight;
    }, error => {
        console.error("Error loading group messages:", error);
        messageBox.innerHTML = '<div class="error-loading">Failed to load messages</div>';
    });
}

// Display a group message
function displayGroupMessage(message) {
    const messageBox = document.getElementById('groupMessageBox');
    const currentUser = auth.currentUser;
    const isCurrentUser = message.senderId === currentUser.uid;
    
    const messageElement = document.createElement('div');
    messageElement.className = `message-container ${isCurrentUser ? 'sent' : 'received'}`;
    
    const messageContent = `
        <div class="message-bubble">
            ${!isCurrentUser ? `<div class="message-sender">${message.senderName}</div>` : ''}
            <div class="message-text">${message.text}</div>
            <div class="message-time">
                ${message.timestamp?.toDate?.().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
            </div>
        </div>
    `;
    
    messageElement.innerHTML = messageContent;
    messageBox.appendChild(messageElement);
}

// Send group message
async function sendGroupMessage() {
    const messageInput = document.getElementById('groupMessageInput');
    if (!messageInput || !currentGroupId) return;
    
    const messageText = messageInput.value.trim();
    if (!messageText) return;
    
    const currentUser = auth.currentUser;
    if (!currentUser) {
        alert("You must be logged in to send messages");
        return;
    }
    
    try {
        const message = {
            text: messageText,
            senderId: currentUser.uid,
            senderName: currentUser.displayName || currentUser.email || 'Anonymous',
            timestamp: serverTimestamp()
        };
        
        await addDoc(collection(db, 'chat_groups', currentGroupId, 'messages'), message);
        
        // Update last message time
        await updateDoc(doc(db, 'chat_groups', currentGroupId), {
            lastMessageAt: serverTimestamp()
        });
        
        // Clear input
        messageInput.value = '';
    } catch (error) {
        console.error("Error sending group message:", error);
        alert("Failed to send group message");
    }
}

async function updateProfileCounts(userId) {
    const userDoc = await getDoc(doc(db, 'users', userId));
    if (userDoc.exists()) {
        const userData = userDoc.data();
        const followersCountElement = document.getElementById('followersCount');
        const followingCountElement = document.getElementById('followingCount');

        if (followersCountElement) {
            followersCountElement.textContent = `${userData.followersCount || 0} Pengikut`;
        }

        if (followingCountElement) {
            followingCountElement.textContent = `${userData.followingCount || 0} Mengikuti`;
        }
    }
}

// Function to handle the follow/unfollow button
async function setupFollowButton(targetUserId, followButtonId) {
    const followButton = document.getElementById(followButtonId);
    if (!followButton) return;

    // Check initial follow state
    const currentUser = auth.currentUser;
    if (!currentUser) {
        followButton.textContent = 'Login to Follow';
        followButton.disabled = true;
        return;
    }

    if (targetUserId === currentUser.uid) {
        followButton.style.display = 'none'; // Hide follow button for self
        return;
    }

    const userFollowingRef = doc(db, 'users', currentUser.uid, 'following', targetUserId);
    const followDoc = await getDoc(userFollowingRef);
    let isFollowing = followDoc.exists();

    followButton.textContent = isFollowing ? 'Mengikuti' : 'Ikuti';
    followButton.classList.toggle('followed', isFollowing); // Add a class for styling

    followButton.onclick = async () => {
        try {
            const result = await toggleUserFollow(targetUserId); // result is true if followed, false if unfollowed
            isFollowing = result; // Update the state
            followButton.textContent = isFollowing ? 'Mengikuti' : 'Ikuti';
            followButton.classList.toggle('followed', isFollowing);

            // Immediately update counts for both current user and target user after toggle
            if (currentUser) {
                updateProfileCounts(currentUser.uid); // Update current user's following count
            }
            updateProfileCounts(targetUserId); // Update target user's followers count

            // If the modal showing followers of the TARGET_USER_ID is open, refresh it
            const modal = document.getElementById('myModal');
            if (modal && modal.classList.contains('perjalanan-hidup-modal-show') && modal.dataset.userId === targetUserId) {
                 displayUserFollowers(targetUserId); // Assuming displayUserFollowers is the one used for the modal
            }

        } catch (error) {
            console.error("Error toggling follow status:", error);
            // Error handling already in toggleUserFollow, but you can add more here if needed
        }
    };
}

document.addEventListener('DOMContentLoaded', () => {
    // Initialize group chat
    initializeGroupChat();
    
    // Setup event listeners for modals
    initializeFollowModals();
    
    // Get userId from URL or current user
    const urlParams = new URLSearchParams(window.location.search);
    const userId = urlParams.get('userId') || auth.currentUser?.uid;
    
    if (userId) {
        // Setup real-time updates for follow counts
        setupRealtimeFollowUpdates(userId);
        
        // Initialize main follow button
        const followButton = document.getElementById('followUserBtn');
        if (followButton && userId !== auth.currentUser?.uid) {
            followButton.dataset.userId = userId;
            followButton.addEventListener('click', () => toggleUserFollow(userId));
        }
    }
    
    // Close modals when clicking outside
    window.addEventListener('click', (event) => {
        if (event.target.classList.contains('modal')) {
            event.target.style.display = 'none';
        }
    });
});


function displayUserList(users, containerId) {
    const container = document.getElementById(containerId);
    if (!container) return;
    
    container.innerHTML = '';
    
    if (users.length === 0) {
        container.innerHTML = '<div class="empty">Belum ada data</div>';
        return;
    }
    
    const currentUser = auth.currentUser;
    
    users.forEach(user => {
        const userElement = document.createElement('div');
        userElement.className = 'user-item';
        userElement.innerHTML = `
            <div class="user-avatar">
                ${user.photoURL ? `<img src="${user.photoURL}" alt="${user.name}">` : 
                 `<span>${user.name.charAt(0)}</span>`}
            </div>
            <div class="user-info">
                <div class="user-name">${user.name}</div>
                ${user.id === currentUser?.uid ? 
                 '<div class="user-badge">Anda</div>' : ''}
            </div>
        `;
        container.appendChild(userElement);
    });
}


async function toggleUserFollow(targetUserId) {
    try {
        const currentUser = auth.currentUser;
        if (!currentUser) {
            alert("Silakan login untuk mengikuti pengguna");
            return null;
        }

        if (targetUserId === currentUser.uid) {
            console.warn("Tidak bisa mengikuti diri sendiri");
            return null;
        }

        // Check current follow status
        const followDoc = await getDoc(doc(db, 'users', currentUser.uid, 'following', targetUserId));
        const isFollowing = followDoc.exists();

        const batch = writeBatch(db);

        if (isFollowing) {
            // Unfollow actions
            batch.delete(doc(db, 'users', currentUser.uid, 'following', targetUserId));
            batch.delete(doc(db, 'users', targetUserId, 'followers', currentUser.uid));
            batch.update(doc(db, 'users', currentUser.uid), {
                followingCount: increment(-1)
            });
            batch.update(doc(db, 'users', targetUserId), {
                followersCount: increment(-1)
            });
        } else {
            // Follow actions
            batch.set(doc(db, 'users', currentUser.uid, 'following', targetUserId), {
                followedAt: serverTimestamp()
            });
            batch.set(doc(db, 'users', targetUserId, 'followers', currentUser.uid), {
                followedAt: serverTimestamp()
            });
            batch.update(doc(db, 'users', currentUser.uid), {
                followingCount: increment(1)
            });
            batch.update(doc(db, 'users', targetUserId), {
                followersCount: increment(1)
            });
        }

        await batch.commit();
        return !isFollowing; // Return new follow state

    } catch (error) {
        console.error("Error toggling follow:", error);
        alert("Terjadi kesalahan saat memproses permintaan");
        return null;
    }
}



















function updateOpenFollowersModals(userId) {
    // Update followers modal if open for this user
    const followersModal = document.getElementById('userFollowersModal');
    if (followersModal.style.display === 'flex' && followersModal.dataset.userId === userId) {
        loadFollowersData(userId);
    }
}

function updateOpenFollowingModals(userId) {
    // Update following modal if open for this user
    const followingModal = document.getElementById('userFollowingModal');
    if (followingModal.style.display === 'flex' && followingModal.dataset.userId === userId) {
        loadFollowingData(userId);
    }
}













document.addEventListener('DOMContentLoaded', () => {
    initializeGroupFollowSystem();
    
    // Close modal when clicking X
    document.querySelectorAll('.close-modal').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.modal').forEach(modal => {
                modal.style.display = 'none';
            });
        });
    });
    
    // Close modal when clicking outside
    window.addEventListener('click', (event) => {
        if (event.target.classList.contains('modal')) {
            event.target.style.display = 'none';
        }
    });
});




function openAddMemberModal() {
    if (!currentGroupId) {
        console.error('Group ID tidak tersedia');
        return;
    }
    
    const modal = document.getElementById('addMemberModal');
    if (!modal) return;
    
    // Reset form
    document.getElementById('searchMemberInput').value = '';
    document.getElementById('memberSearchResults').innerHTML = '';
    document.getElementById('selectedMembersToAdd').innerHTML = '';
    window.selectedUsersToAddForGroup = [];
    
    modal.style.display = 'flex';
    
    // Load current group data if not already loaded
    if (!window.currentGroupData) {
        fetchGroupData(currentGroupId);
    }
}



async function fetchGroupData(groupId) {
    try {
        const groupDoc = await getDoc(doc(db, 'chat_groups', groupId));
        if (groupDoc.exists()) {
            window.currentGroupData = groupDoc.data();
        } else {
            console.error("Grup tidak ditemukan");
            window.currentGroupData = null;
        }
    } catch (error) {
        console.error("Error fetching group data:", error);
        window.currentGroupData = null;
    }
}




// Close add member modal
function closeAddMemberModal() {
    const modal = document.getElementById('addMemberModal');
    if (modal) modal.style.display = 'none';
}


async function addMembersToGroup() {
    if (!currentGroupId || !window.currentGroupData || !window.selectedUsersToAddForGroup || window.selectedUsersToAddForGroup.length === 0) {
        alert("Silakan pilih anggota yang akan ditambahkan");
        return;
    }
    
    try {
        const addButton = document.getElementById('confirmAddMemberBtn');
        if (addButton) {
            addButton.disabled = true;
            addButton.textContent = "Menambahkan...";
        }
        
        const currentUser = auth.currentUser;
        const newMemberIds = window.selectedUsersToAddForGroup.map(u => u.id);

        // Verifikasi bahwa pengguna saat ini adalah admin grup
        if (currentGroupData.createdBy !== currentUser.uid) {
            alert("Hanya admin grup yang dapat menambahkan anggota");
            return;
        }

        const existingMembers = window.currentGroupData.members || [];
        const uniqueNewMembers = window.selectedUsersToAddForGroup.filter(
            u => !existingMembers.includes(u.id)
        );
        
        if (uniqueNewMembers.length === 0) {
            alert("Semua pengguna yang dipilih sudah menjadi anggota grup");
            return;
        }

        // Update group members in Firestore
        const groupRef = doc(db, 'chat_groups', currentGroupId);
        const batch = writeBatch(db);

        // Add new members to group
        batch.update(groupRef, {
            members: arrayUnion(...uniqueNewMembers.map(u => u.id)),
            lastUpdated: serverTimestamp()
        });

        // Add group reference to each new member's groups subcollection
        uniqueNewMembers.forEach(user => {
            const userGroupRef = doc(db, 'users', user.id, 'groups', currentGroupId);
            batch.set(userGroupRef, { 
                joinedAt: serverTimestamp(),
                lastSeen: serverTimestamp(),
                addedBy: currentUser.uid
            });
            
            // Add notification for new member
            const notificationRef = doc(collection(db, 'users', user.id, 'notifications'));
            batch.set(notificationRef, {
                type: 'group_invitation',
                groupId: currentGroupId,
                groupName: currentGroupData.name,
                fromUserId: currentUser.uid,
                fromUserName: currentUser.displayName || currentUser.email,
                timestamp: serverTimestamp(),
                read: false,
                message: `Anda telah ditambahkan ke grup "${currentGroupData.name}"`
            });
        });

        await batch.commit();
        
        // Update local group data
        window.currentGroupData.members = [...existingMembers, ...uniqueNewMembers.map(u => u.id)];
        
        // Update UI
        document.getElementById('groupMemberCount').textContent = 
            `${window.currentGroupData.members.length} anggota`;
        
        // Reload members list
        loadGroupMembers(window.currentGroupData.members);
        
        // Close modal and reset
        closeAddMemberModal();
        alert(`${uniqueNewMembers.length} anggota berhasil ditambahkan ke grup`);
        
    } catch (error) {
        console.error("Error menambahkan anggota ke grup:", error);
        alert("Gagal menambahkan anggota: " + error.message);
    } finally {
        const addButton = document.getElementById('confirmAddMemberBtn');
        if (addButton) {
            addButton.disabled = false;
            addButton.textContent = "Tambah Anggota";
        }
    }
}


// Initialize modals and event listeners
function initializeFollowModals() {
    // Close modals when clicking X
    document.querySelectorAll('.close-modal').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.modal').forEach(modal => {
                modal.style.display = 'none';
            });
        });
    });

    // Close modal when clicking outside
    window.addEventListener('click', (event) => {
        if (event.target.classList.contains('modal')) {
            event.target.style.display = 'none';
        }
    });

    // Initialize follow buttons
    document.addEventListener('click', (e) => {
        if (e.target.classList.contains('show-followers') || 
           e.target.classList.contains('followers-count')) {
            const userId = e.target.closest('[data-user-id]')?.dataset?.userId;
            if (userId) openUserFollowersModal(userId);
        }
        
        if (e.target.classList.contains('show-following') || 
           e.target.classList.contains('following-count')) {
            const userId = e.target.closest('[data-user-id]')?.dataset?.userId;
            if (userId) openUserFollowingModal(userId);
        }
    });
}




async function toggleGroupFollow() {
    if (!currentGroupId || !currentGroupData) {
        console.error("Tidak ada grup yang dipilih atau data grup hilang");
        alert("Silakan pilih grup terlebih dahulu");
        return;
    }
    
    const currentUser = auth.currentUser;
    if (!currentUser) {
        alert("Anda harus login untuk mengikuti grup");
        return;
    }
    
    try {
        const isFollowing = currentGroupData.followers?.includes(currentUser.uid);
        const groupRef = doc(db, 'chat_groups', currentGroupId);
        const userGroupFollowingRef = doc(db, 'users', currentUser.uid, 'group_following', currentGroupId);
        
        // Update UI segera untuk feedback visual
        const followButton = document.getElementById('followGroupBtn');
        if (followButton) {
            followButton.disabled = true;
            followButton.textContent = isFollowing ? 'Berhenti Mengikuti...' : 'Mengikuti...';
        }
        
        if (isFollowing) {
            // Unfollow
            await Promise.all([
                updateDoc(groupRef, {
                    followers: arrayRemove(currentUser.uid),
                    lastUpdated: serverTimestamp()
                }),
                deleteDoc(userGroupFollowingRef)
            ]);
        } else {
            // Follow
            await Promise.all([
                updateDoc(groupRef, {
                    followers: arrayUnion(currentUser.uid),
                    lastUpdated: serverTimestamp()
                }),
                setDoc(userGroupFollowingRef, {
                    groupId: currentGroupId,
                    groupName: currentGroupData.name,
                    followedAt: serverTimestamp()
                })
            ]);
        }
        
        // Refresh group data
        const updatedGroupDoc = await getDoc(groupRef);
        if (updatedGroupDoc.exists()) {
            currentGroupData = updatedGroupDoc.data();
            updateGroupFollowUI();
        }
        
    } catch (error) {
        console.error("Error toggling group follow:", error);
        alert("Gagal memperbarui status follow grup: " + error.message);
    } finally {
        const followButton = document.getElementById('followGroupBtn');
        if (followButton) {
            followButton.disabled = false;
        }
    }
}


async function toggleFollow(targetUserId) {
  const user = auth.currentUser;
  if (!user || user.uid === targetUserId) return;

  const userRef = doc(db, "users", user.uid);
  const targetRef = doc(db, "users", targetUserId);

  const userSnap = await getDoc(userRef);
  const targetSnap = await getDoc(targetRef);

  if (!userSnap.exists() || !targetSnap.exists()) return;

  const userData = userSnap.data();
  const targetData = targetSnap.data();

  const following = userData.following || [];
  const followers = targetData.followers || [];

  const isFollowing = following.includes(targetUserId);

  if (isFollowing) {
    await updateDoc(userRef, { following: arrayRemove(targetUserId) });
    await updateDoc(targetRef, { followers: arrayRemove(user.uid) });
    document.getElementById(`followBtn-${targetUserId}`).textContent = 'Ikuti';
  } else {
    await updateDoc(userRef, { following: arrayUnion(targetUserId) });
    await updateDoc(targetRef, { followers: arrayUnion(user.uid) });
    document.getElementById(`followBtn-${targetUserId}`).textContent = 'Mengikuti';
  }

  updateFollowerStats(user.uid);
}
















function updateGroupFollowUI() {
    if (!currentGroupData) return;
    
    const currentUser = auth.currentUser;
    if (!currentUser) return;
    
    const isFollowing = currentGroupData.followers?.includes(currentUser.uid);
    const followButton = document.getElementById('followGroupBtn');
    const followersCountElement = document.getElementById('groupFollowersCount');
    
    if (followButton) {
        followButton.textContent = isFollowing ? 'Berhenti Mengikuti' : 'Ikuti Grup';
        followButton.style.backgroundColor = isFollowing ? '#f44336' : '#4CAF50';
    }
    
    if (followersCountElement) {
        followersCountElement.textContent = `${currentGroupData.followers?.length || 0} pengikut`;
    }
    
    // Update followers list if modal is open
    if (document.getElementById('groupFollowersModal')?.style.display === 'flex') {
        displayGroupFollowers(currentGroupData.followers);
    }
}








// Fungsi untuk membuka modal daftar pengikut grup
function openGroupFollowersModal() {
    if (!currentGroupId || !currentGroupData) return;
    
    const modal = document.getElementById('groupFollowersModal');
    if (!modal) return;
    
    modal.style.display = 'flex';
    displayGroupFollowers(currentGroupData.followers);
}

// Fungsi untuk menampilkan daftar pengikut grup
async function displayGroupFollowers(followerIds) {
    const followersList = document.getElementById('groupFollowersList');
    if (!followersList) return;
    
    followersList.innerHTML = '<div class="loading">Loading followers...</div>';
    
    if (!followerIds || followerIds.length === 0) {
        followersList.innerHTML = '<div class="no-followers">No followers yet</div>';
        return;
    }
    
    try {
        // Get follower details
        const followers = await Promise.all(followerIds.map(async userId => {
            const userDoc = await getDoc(doc(db, 'users', userId));
            return {
                id: userId,
                name: userDoc.exists() ? (userDoc.data().displayName || userDoc.data().email || 'Unknown') : 'Unknown',
                email: userDoc.exists() ? userDoc.data().email : '',
                photoURL: userDoc.exists() ? userDoc.data().photoURL : ''
            };
        }));
        
        // Display followers
        followersList.innerHTML = '';
        followers.forEach(user => {
            const followerItem = document.createElement('div');
            followerItem.className = 'follower-item';
            followerItem.innerHTML = `
                <div class="follower-avatar">
                    ${user.photoURL ? `<img src="${user.photoURL}" alt="${user.name}">` : 
                      `<span>${user.name.charAt(0)}</span>`}
                </div>
                <div class="follower-info">
                    <div class="follower-name">${user.name}</div>
                    ${user.email ? `<div class="follower-email">${user.email}</div>` : ''}
                </div>
            `;
            followersList.appendChild(followerItem);
        });
    } catch (error) {
        console.error("Error loading followers:", error);
        followersList.innerHTML = '<div class="error">Failed to load followers</div>';
    }
}




// Event listener for the "Follow" button
document.getElementById('followUserBtn')?.addEventListener('click', async () => {
    const userId = document.querySelector('.user-follow-section')?.dataset?.userId;
    if (!userId) return;

    try {
        // Toggle follow status
        const isNowFollowing = await toggleUserFollow(userId);

        // Update button text and class
        const followButton = document.getElementById('followUserBtn');
        if (followButton) {
            followButton.textContent = isNowFollowing ? 'Unfollow' : 'Follow';
            followButton.className = isNowFollowing ? 'unfollow-btn' : 'follow-btn';
        }

        // Update follower count
        const followersCountElement = document.getElementById('followersCount');
        if (followersCountElement) {
            const currentCount = parseInt(followersCountElement.dataset.count, 10) || 0;
            const newCount = isNowFollowing ? currentCount + 1 : currentCount - 1;
            followersCountElement.textContent = `${newCount} Pengikut`;
            followersCountElement.dataset.count = newCount;
        }
    } catch (error) {
        console.error("Error toggling follow:", error);
    }
});



















async function updateFollowUI(userId) {
    try {
        const currentUser = auth.currentUser;
        if (!currentUser) return;

        const db = getFirestore();
        
        const [userDoc, followDoc] = await Promise.all([
            getDoc(doc(db, 'users', userId)),
            currentUser.uid !== userId 
                ? getDoc(doc(db, 'users', userId, 'followers', currentUser.uid))
                : Promise.resolve({ exists: () => false })
        ]);

        if (!userDoc.exists()) {
            console.error("User document not found");
            return;
        }

        const userData = userDoc.data();
        const isFollowing = followDoc.exists();
        const isCurrentUser = currentUser.uid === userId;

        // Update follow button
        const followButton = document.getElementById('followUserBtn');
        if (followButton) {
            if (isCurrentUser) {
                followButton.style.display = 'none';
            } else {
                followButton.textContent = isFollowing ? 'Unfollow' : 'Follow';
                followButton.className = isFollowing ? 'unfollow-btn' : 'follow-btn';
                followButton.style.display = 'inline-block';
                followButton.onclick = () => toggleUserFollow(userId);
            }
        }

        // Update followers count
        const followersCountElement = document.getElementById('followersCount');
        if (followersCountElement) {
            const count = userData.followersCount || 0;
            followersCountElement.textContent = `${count} Followers`;
            followersCountElement.onclick = () => openFollowersModal(userId);
        }

        // Update following count if needed
        const followingCountElement = document.getElementById('followingCount');
        if (followingCountElement) {
            const count = userData.followingCount || 0;
            followingCountElement.textContent = `${count} Following`;
        }

    } catch (error) {
        console.error("Error in updateFollowUI:", error);
    }
}








async function displayUserProfile(userId) {
    const currentUser = auth.currentUser;
    const isCurrentUser = currentUser && userId === currentUser.uid;

    try {
        // Ambil data profil pengguna dari Firestore
        const userDoc = await db.collection('users').doc(userId).get();

        if (!userDoc.exists) {
            console.error('User not found');
            return;
        }

        const userData = userDoc.data();

        // Tampilkan data profil ke UI (contoh elemen)
        document.getElementById('profileName').textContent = userData.displayName || 'No Name';
        document.getElementById('profileBio').textContent = userData.bio || '';
        document.getElementById('profilePic').src = userData.photoURL || '/default-avatar.png';

        // Update follow section
        const followSection = document.querySelector('.user-follow-section');
        if (followSection) {
            followSection.dataset.userId = userId;

            // Tampilkan/sembunyikan tombol follow/unfollow
            const followBtn = document.getElementById('followUserBtn');
            const followersBtn = document.getElementById('showFollowersBtn');
            const unfollowBtn = document.getElementById('unfollowUserBtn');

            if (followBtn) followBtn.classList.toggle('hidden', isCurrentUser);
            if (unfollowBtn) unfollowBtn.classList.toggle('hidden', isCurrentUser);
            if (followersBtn) followersBtn.classList.toggle('hidden', isCurrentUser);

            // Jika bukan profil sendiri, perbarui tampilan tombol follow
            if (!isCurrentUser) {
                await updateUserFollowUI(userId);
            }
        }

    } catch (error) {
        console.error('Error loading user profile:', error);
    }
}



async function updateFollowUI(userId) {
    const currentUser = auth.currentUser;
    if (!currentUser) return;
    
    try {
        const isCurrentUserProfile = userId === currentUser.uid;
        const followButton = document.getElementById('followUserBtn');
        const followersCountElement = document.getElementById('followersCount');
        
        if (isCurrentUserProfile) {
            // Hide follow button if viewing own profile
            if (followButton) followButton.classList.add('hidden');
            if (followersCountElement) {
                const userDoc = await getDoc(doc(db, 'users', userId));
                if (userDoc.exists()) {
                    followersCountElement.textContent = `${userDoc.data().followersCount || 0} followers`;
                }
            }
            return;
        }
        
        // Check follow status
        const followDoc = await getDoc(doc(db, 'users', userId, 'followers', currentUser.uid));
        const isFollowing = followDoc.exists();
        
        // Update follow button
        if (followButton) {
            followButton.textContent = isFollowing ? 'Unfollow' : 'Follow';
            followButton.className = isFollowing ? 'unfollow' : 'follow';
            followButton.classList.remove('hidden');
        }
        
        // Update followers count
        if (followersCountElement) {
            const userDoc = await getDoc(doc(db, 'users', userId));
            if (userDoc.exists()) {
                followersCountElement.textContent = `${userDoc.data().followersCount || 0} followers`;
            }
        }
        
    } catch (error) {
        console.error("Error updating follow UI:", error);
    }
}











// Show followers modal
async function showFollowersModal() {
    const modal = document.getElementById('userFollowersModal');
    if (!modal) return;
    
    modal.style.display = 'flex';
    await displayFollowersList(currentProfileUserId);
}


async function displayFollowersList(userId) {
    const followersList = document.getElementById('userFollowersList');
    if (!followersList) return;

    followersList.innerHTML = '<div class="loading">Loading followers...</div>';

    try {
        // Get followers snapshot (documents in the 'followers' subcollection)
        const followersSnapshot = await getDocs(collection(db, 'users', userId, 'followers'));

        if (followersSnapshot.empty) {
            followersList.innerHTML = '<div class="no-followers">No followers yet</div>';
            return;
        }

        // Get user details for each follower
        const followers = await Promise.all(
            followersSnapshot.docs.map(async (followerDocSnapshot) => { // Renamed 'doc' to 'followerDocSnapshot'
                // followerDocSnapshot.id is the UID of the follower
                const userDoc = await getDoc(doc(db, 'users', followerDocSnapshot.id)); // Corrected
                return {
                    id: followerDocSnapshot.id,
                    ...(userDoc.exists() ? userDoc.data() : {}) // Ensure data exists before spreading
                };
            })
        );

        // Display followers
        followersList.innerHTML = '';
        followers.forEach(user => {
            if (!user.displayName && !user.email) return; // Skip if no identifiable info

            const followerItem = document.createElement('div');
            followerItem.className = 'follower-item';
            followerItem.innerHTML = `
                <div class="follower-avatar">
                    ${user.photoURL ? `<img src="${user.photoURL}" alt="${user.displayName || user.email}">` :
                    `<span>${(user.displayName?.charAt(0) || user.email?.charAt(0) || 'U').toUpperCase()}</span>`}
                </div>
                <div class="follower-info">
                    <div class="follower-name">${user.displayName || user.email || 'Unknown'}</div>
                    ${user.email ? `<div class="follower-email">${user.email}</div>` : ''}
                </div>
            `;
            followersList.appendChild(followerItem);
        });

    } catch (error) {
        console.error("Error loading followers:", error);
        followersList.innerHTML = '<div class="error">Failed to load followers</div>';
    }
}



async function displayUserFollowers(userId) {
    const followersList = document.getElementById('userFollowersList');
    if (!followersList) return;

    try {
        const followersSnapshot = await getDocs(collection(db, 'users', userId, 'followers'));
        followersList.innerHTML = '';

        for (const doc of followersSnapshot.docs) {
            const followerId = doc.id;

            const userDoc = await getDoc(doc(db, 'users', followerId));
            if (userDoc.exists()) {
                const userData = userDoc.data();

                const followerItem = document.createElement('div');
                followerItem.className = 'follower-item';

                followerItem.innerHTML = `
                    <img src="${userData.photoURL || 'default-avatar.png'}" alt="${userData.displayName}" class="follower-avatar">
                    <div class="follower-info">
                        <div class="follower-name">${userData.displayName}</div>
                        <div class="follower-email">${userData.email}</div>
                    </div>
                `; // ‚úÖ Penutup backtick diperbaiki di sini

                followersList.appendChild(followerItem);
            }
        }
    } catch (error) {
        console.error("Error loading followers:", error);
        followersList.innerHTML = '<div class="error">Gagal memuat daftar pengikut</div>';
    }
}


function openUserFollowersModal(userId) {
  const modal = document.getElementById('userFollowersModal');
  if (!modal) return;

  modal.style.display = 'flex';
  modal.dataset.userId = userId;

  loadFollowersData(userId);
}

function openUserFollowingModal(userId) {
  const modal = document.getElementById('userFollowingModal');
  if (!modal) return;

  modal.style.display = 'flex';
  modal.dataset.userId = userId;

  loadFollowingData(userId);
}




async function loadUserFollowers(userId) {
    const followersList = document.getElementById('userFollowersList');
    if (!followersList) return;

    try {
        const followersSnapshot = await getDocs(collection(db, 'users', userId, 'followers'));
        const followers = [];

        for (const doc of followersSnapshot.docs) {
            const userDoc = await getDoc(doc(db, 'users', doc.id));
            if (userDoc.exists()) {
                const userData = userDoc.data();
                followers.push({
                    id: doc.id,
                    name: userData.displayName || userData.email,
                    email: userData.email,
                    photoURL: userData.photoURL
                });
            }
        }

        renderUserList(followers, 'userFollowersList');
    } catch (error) {
        console.error("Error loading followers:", error);
        followersList.innerHTML = '<div class="error">Gagal memuat daftar pengikut</div>';
    }
}

// Load user following
async function loadUserFollowing(userId) {
    const followingList = document.getElementById('userFollowingList');
    if (!followingList) return;

    try {
        const followingSnapshot = await getDocs(collection(db, 'users', userId, 'following'));
        const following = [];

        for (const doc of followingSnapshot.docs) {
            const userDoc = await getDoc(doc(db, 'users', doc.id));
            if (userDoc.exists()) {
                const userData = userDoc.data();
                following.push({
                    id: doc.id,
                    name: userData.displayName || userData.email,
                    email: userData.email,
                    photoURL: userData.photoURL
                });
            }
        }

        renderUserList(following, 'userFollowingList');
    } catch (error) {
        console.error("Error loading following:", error);
        followingList.innerHTML = '<div class="error">Gagal memuat daftar yang diikuti</div>';
    }
}



// Search groups
async function searchGroups() {
    const searchTerm = document.getElementById('groupSearchInput').value.trim().toLowerCase();
    const groupList = document.getElementById('groupList');
    
    if (!searchTerm || searchTerm.length < 1) {
        loadUserGroups(); // Reset to show all groups
        return;
    }

    try {
        const currentUser = auth.currentUser;
        if (!currentUser) return;
        
        const q = query(
            collection(db, 'chat_groups'),
            where('members', 'array-contains', currentUser.uid)
        );
        
        const snapshot = await getDocs(q);
        groupList.innerHTML = '';
        
        if (snapshot.empty) {
            groupList.innerHTML = '<div class="no-groups">No matching groups found</div>';
            return;
        }
        
        const matchingGroups = [];
        for (const doc of snapshot.docs) {
            const groupData = doc.data();
            const groupName = groupData.name.toLowerCase();
            
            if (groupName.includes(searchTerm)) {
                const lastMessage = await getLastGroupMessage(doc.id);
                
                matchingGroups.push({
                    id: doc.id,
                    ...groupData,
                    lastMessage: lastMessage?.text || "No messages yet",
                    lastMessageTime: lastMessage?.timestamp || groupData.createdAt
                });
            }
        }
        
        if (matchingGroups.length === 0) {
            groupList.innerHTML = '<div class="no-groups">No matching groups found</div>';
            return;
        }
        
        // Sort by last activity time
        matchingGroups.sort((a, b) => {
            const timeA = a.lastMessageTime?.toDate?.()?.getTime?.() || 0;
            const timeB = b.lastMessageTime?.toDate?.()?.getTime?.() || 0;
            return timeB - timeA;
        });
        
        // Display matching groups
        matchingGroups.forEach(group => {
            const groupElement = createGroupListItem(group);
            groupList.appendChild(groupElement);
        });
        
    } catch (error) {
        console.error("Error searching groups:", error);
        groupList.innerHTML = '<div class="error-loading">Failed to search groups</div>';
    }
}

// Update last seen time for group
async function updateLastSeen(groupId) {
    const currentUser = auth.currentUser;
    if (!currentUser) return;
    
    try {
        await updateDoc(doc(db, 'users', currentUser.uid, 'groups', groupId), {
            lastSeen: serverTimestamp()
        });
    } catch (error) {
        console.error("Error updating last seen:", error);
    }
}


document.addEventListener('DOMContentLoaded', function() {
    initializeFollowSystem();
    
    // Jika ada user ID di URL, load data follow
    const urlParams = new URLSearchParams(window.location.search);
    const userId = urlParams.get('userId');
    if (userId) {
        updateFollowCounts(userId);
        setupFollowersRealtime(userId);
    }
});





// Fungsi untuk real-time update jumlah followers
function setupFollowersRealtime(userId) {
    if (!userId) return;

    // Unsubscribe sebelumnya jika ada
    if (unsubscribeFollowers) unsubscribeFollowers();

    // Subscribe ke perubahan jumlah followers
    const userRef = doc(db, 'users', userId);
    unsubscribeFollowers = onSnapshot(userRef, (doc) => {
        if (doc.exists()) {
            const followersCount = doc.data().followersCount || 0;
            const followersCountElement = document.getElementById('followersCount');
            if (followersCountElement) {
                followersCountElement.textContent = `${followersCount} Pengikut`;
                followersCountElement.setAttribute('data-count', followersCount);
            }
        }
    });
}



async function loadFollowData(userId, type) {
  try {
    const collectionName = type === 'followers' ? 'followers' : 'following';
    const snapshot = await getDocs(collection(db, 'users', userId, collectionName));

    const users = [];
    const currentUser = auth.currentUser;

    for (const snap of snapshot.docs) {
      const targetUserId = snap.id;
      const userDocSnap = await getDoc(doc(db, 'users', targetUserId));
      if (!userDocSnap.exists()) continue;

      const userData = userDocSnap.data();
      let isFollowing = false;

      if (currentUser && currentUser.uid !== targetUserId) {
        const followCheck = await getDoc(doc(db, 'users', currentUser.uid, 'following', targetUserId));
        isFollowing = followCheck.exists();
      }

      users.push({
        id: targetUserId,
        name: userData.displayName || userData.email || 'Unknown',
        email: userData.email || '',
        photoURL: userData.photoURL || '',
        isFollowing,
        isCurrentUser: currentUser && currentUser.uid === targetUserId
      });
    }

    return users;
  } catch (error) {
    console.error(`Error loading ${type}:`, error);
    throw error;
  }
}





// Helper function to check follow status
async function checkIfFollowing(currentUserId, targetUserId) {
    if (currentUserId === targetUserId) return false;
    
    const followDoc = await getDoc(doc(db, 'users', currentUserId, 'following', targetUserId));
    return followDoc.exists();
}


async function openFollowModal(userId, type) {
    const modalId = `user${type.charAt(0).toUpperCase() + type.slice(1)}Modal`;
    const modal = document.getElementById(modalId);
    if (!modal) return;

    const listId = `user${type.charAt(0).toUpperCase() + type.slice(1)}List`;
    const listElement = document.getElementById(listId);
    
    // Show loading state
    modal.style.display = 'flex';
    listElement.innerHTML = '<div class="loading">Memuat data...</div>';
    
    try {
        // Load data
        const users = await loadFollowData(userId, type);
        
        // Render list
        renderUserList(users, listId);
        
        // Setup real-time updates
        setupRealtimeFollowUpdates(userId, type, listId);
        
    } catch (error) {
        console.error(`Error opening ${type} modal:`, error);
        listElement.innerHTML = '<div class="error">Gagal memuat data</div>';
    }
}



// Tambahkan tombol untuk membuka saved messages
const savedMessagesBtn = document.createElement('button');
savedMessagesBtn.textContent = 'Pesan Tersimpan';
savedMessagesBtn.id = 'showSavedMessagesBtn';
savedMessagesBtn.addEventListener('click', showSavedMessages);

// Tempatkan tombol di UI yang sesuai
document.querySelector('#profileSection').appendChild(savedMessagesBtn);




async function showSavedMessages() {
    const user = auth.currentUser;
    if (!user) {
        showSuccessMessage("Anda perlu login untuk melihat pesan tersimpan.");
        return;
    }

    const container = document.getElementById('savedMessagesContainer');
    container.innerHTML = '';

    try {
        const q = query(
            collection(db, 'users', user.uid, 'savedMessages'),
            orderBy('savedAt', 'desc')
        );
        const snapshot = await getDocs(q);

        if (snapshot.empty) {
            container.innerHTML = '<p style="text-align:center;">Belum ada pesan tersimpan.</p>';
            return;
        }

        snapshot.forEach(doc => {
            const data = doc.data();
            const messageEl = document.createElement('div');
            messageEl.className = 'saved-message-item';

            messageEl.innerHTML = `
                <div class="saved-message-header">
                    <div class="sender">${data.senderName}</div>
                    <div class="time">${data.savedAt.toDate().toLocaleString()}</div>
                </div>
                <div class="saved-message-text">${data.content}</div>
                <button class="delete-saved-message" data-id="${doc.id}">Hapus</button>
            `;

            // Hapus pesan tersimpan
            messageEl.querySelector('.delete-saved-message').addEventListener('click', async () => {
                await deleteDoc(doc(db, 'users', user.uid, 'savedMessages', doc.id));
                showSuccessMessage("Pesan berhasil dihapus.");
                showSavedMessages(); // Refresh daftar
            });

            container.appendChild(messageEl);
        });

        // Tampilkan modal
        document.getElementById('savedMessagesModal').classList.add('show');

    } catch (error) {
        console.error("Error loading saved messages:", error);
        showSuccessMessage("Gagal memuat pesan tersimpan.");
    }
}


    function updateCurrentChatInfo(userId, userName) {
        if (currentChatInfo && currentChatWithSpan) {
            currentChatWithSpan.textContent = userName;
            currentChatInfo.style.display = 'block';
        }
        
        const contactItems = document.querySelectorAll('.contact-item');
        contactItems.forEach(item => {
            if (item.dataset.uid === userId) {
                item.classList.add('active');
            } else {
                item.classList.remove('active');
            }
        });
    }

    function initializeChat() {
        if (sendMessageBtn && messageInput) {
            messageInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendPersonalMessage();
                }
            });
            
            sendMessageBtn.addEventListener('click', sendPersonalMessage);
        }
    }

    // Event Listeners
    if (emailLoginButton) emailLoginButton.addEventListener('click', loginWithEmail);
    if (emailSignupButton) emailSignupButton.addEventListener('click', signupWithEmail);
    if (anonymousLoginBtn) anonymousLoginBtn.addEventListener('click', signInAnonymouslyFirebase);
    if (showSavedNotesBtn) showSavedNotesBtn.addEventListener('click', () => {
        if (auth && auth.currentUser && savedNotesModal) {
            savedNotesModal.style.display = "flex";
        } else {
            showSuccessMessage("Anda perlu login untuk melihat catatan tersimpan.");
        }
    });
    if (closeSavedNotesModalBtn) closeSavedNotesModalBtn.addEventListener('click', () => {
        if (savedNotesModal) savedNotesModal.style.display = "none";
        if (unsubscribeNotes) {
            unsubscribeNotes();
            unsubscribeNotes = null;
        }
    });
    if (logoutButton) logoutButton.addEventListener('click', logout);
    
    window.addEventListener("click", (event) => {
        if (savedNotesModal && event.target === savedNotesModal) {
            savedNotesModal.style.display = "none";
            if (unsubscribeNotes) {
                unsubscribeNotes();
                unsubscribeNotes = null;
            }
        }
    });

    initNotificationSystem();
  
  // Add button to show saved messages (you can add this button to your HTML)
  const showSavedMessagesBtn = document.getElementById('showSavedMessagesBtn');
  if (showSavedMessagesBtn) {
    showSavedMessagesBtn.addEventListener('click', showSavedMessages);
  }
	
	
// --- Global functions ---
       window.logoutFirebase = logout; 
    window.toggleSaveNote = toggleSaveNote;
    window.loginWithEmail = loginWithEmail;
    window.signupWithEmail = signupWithEmail;
    window.signInAnonymouslyFirebase = signInAnonymouslyFirebase;
    window.sendPersonalMessage = sendPersonalMessage;
    window.startChatWithUser = startChatWithUser;
	window.switchTab = switchTab;
window.searchGroups = searchGroups;
window.createNewGroup = createNewGroup;
window.searchContactsForGroup = searchContactsForGroup;
window.searchUsersForGroup = searchUsersForGroup;
window.removeSelectedMember = removeSelectedMember;
window.openCreateGroupModal = openCreateGroupModal;
window.closeCreateGroupModal = closeCreateGroupModal;
window.openAddMemberModal = openAddMemberModal;
window.closeAddMemberModal = closeAddMemberModal;
window.addMembersToGroup = addMembersToGroup;
window.toggleGroupFollow = toggleGroupFollow;
window.sendGroupMessage = sendGroupMessage;



    // Start the application - HANYA SATU KALI
    onAuthStateChangedHandler();
}); // <-- Hanya SATU penutup disini




		

  const cookieNameConsent = 'cookieConsent';
  const cookieNameTheme = 'themePreference';
  const cookieExpiryDays = 30; // Masa berlaku cookie (dalam hari)

  // Fungsi untuk mengatur cookie
  function setCookie(name, value, days) {
    let expires = "";
    if (days) {
      const date = new Date();
      date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
      expires = "; expires=" + date.toUTCString();
    }
    document.cookie = name + "=" + (value || "") + expires + "; path=/";
    console.log('Cookie diatur:', name, '=', value);
  }

  // Fungsi untuk mendapatkan cookie
  function getCookie(name) {
    const nameEQ = name + "=";
    const ca = document.cookie.split(';');
    for (let i = 0; i < ca.length; i++) {
      let c = ca[i];
      while (c.charAt(0) === ' ') c = c.substring(1, c.length);
      if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
    }
    console.log('Cookie tidak ditemukan:', name);
    return null;
  }

  function applyThemeFromCookie() {
    const theme = getCookie(cookieNameTheme);
    if (theme) {
      document.body.classList.toggle('dark-theme', theme === 'dark');
      // Lakukan tindakan lain untuk menerapkan tema sesuai nilai cookie
      console.log('Tema diterapkan dari cookie:', theme);
    }
  }

  function showCookieNotification() {
    const cookieNotification = document.createElement('div');
    cookieNotification.className = 'cookie-notification';
    cookieNotification.innerHTML = `
      <p style="margin: 0;">Situs ini menggunakan cookies. <a href="#" id="readMoreCookies" style="color: #eee; text-decoration: underline;">Baca lebih lanjut</a> <button id="acceptCookies" style="background-color: #007bff; color: white; border: none; padding: 8px 15px; margin-left: 10px; border-radius: 5px; cursor: pointer;">Terima</button> <button id="rejectCookies" style="background-color: transparent; color: #ccc; border: none; padding: 8px 15px; margin-left: 10px; cursor: pointer;">Tolak</button></p>
    `;
    document.body.appendChild(cookieNotification);
    console.log('Notifikasi cookie ditampilkan.');

    const acceptButton = document.getElementById('acceptCookies');
    const rejectButton = document.getElementById('rejectCookies');
    const readMoreLink = document.getElementById('readMoreCookies');

    acceptButton.addEventListener('click', () => {
      setCookie(cookieNameConsent, 'accepted', cookieExpiryDays);
      cookieNotification.remove();
    });

    rejectButton.addEventListener('click', () => {
      setCookie(cookieNameConsent, 'rejected', 1);
      cookieNotification.remove();
      alert('Anda telah menolak penggunaan cookies. Beberapa fitur mungkin tidak berfungsi dengan baik.');
    });

    readMoreLink.addEventListener('click', (e) => {
      e.preventDefault();
      alert('Ini adalah informasi lebih lanjut tentang bagaimana kami menggunakan cookies...');
    });
  }

  // Cek dan tampilkan notifikasi cookie saat halaman dimuat jika belum ada persetujuan
  console.log('Memeriksa cookie consent:', getCookie(cookieNameConsent));
  if (!getCookie(cookieNameConsent)) {
    showCookieNotification();
  } else if (getCookie(cookieNameConsent) === 'accepted') {
    console.log('Cookie consent diterima.');
    // Lakukan tindakan lain jika cookie consent sudah diterima
  } else if (getCookie(cookieNameConsent) === 'rejected') {
    console.log('Cookie consent ditolak.');
    // Lakukan tindakan lain jika cookie consent ditolak (misalnya, batasi fitur tertentu)
  }

  // Contoh penyimpanan preferensi tema (misalnya, saat tombol tema diubah)
  function saveThemePreference(theme) {
    setCookie(cookieNameTheme, theme, cookieExpiryDays);
    applyThemeFromCookie(); // Terapkan tema segera
  }

  // Terapkan tema dari cookie saat halaman dimuat
  applyThemeFromCookie();
  
  const readMoreLink = document.getElementById('readMoreCookies');
const cookieExplanationModal = document.getElementById('cookieExplanation');
const closeCookieExplanationBtn = document.getElementById('closeCookieExplanation');
const acceptFromExplanationBtn = document.getElementById('acceptFromExplanation');
const cookieNotification = document.querySelector('.cookie-notification'); // Ambil notifikasi cookie

if (readMoreLink) {
    readMoreLink.addEventListener('click', (e) => {
        e.preventDefault();
        cookieExplanationModal.style.display = 'flex';
    });
}

if (closeCookieExplanationBtn) {
    closeCookieExplanationBtn.addEventListener('click', () => {
        cookieExplanationModal.style.display = 'none';
    });
}

if (acceptFromExplanationBtn && cookieNotification) {
    acceptFromExplanationBtn.addEventListener('click', () => {
        setCookie(cookieNameConsent, 'accepted', cookieExpiryDays);
        cookieExplanationModal.style.display = 'none';
        cookieNotification.remove(); // Hilangkan notifikasi setelah menerima dari penjelasan
    });
}

// Pastikan modal tertutup saat area di luar modal diklik
window.addEventListener('click', (event) => {
    if (event.target === cookieExplanationModal) {
        cookieExplanationModal.style.display = 'none';
    }
});


document.getElementById('activityYear').addEventListener('change', function (event) {
    const selectedYear = parseInt(event.target.value);

    // Asumsikan data aktivitas manual Anda ada dalam variabel bernama 'activityDataManual'
    const rawData = activity; // Ganti dengan nama variabel data manual Anda
    const filteredData = {};

    Object.keys(rawData).forEach(month => {
        filteredData[month] = rawData[month]?.filter(entry => {
            return new Date(entry.date).getFullYear() === selectedYear;
        });
    });

    // Render ulang kalender
    const calendarHTML = renderActivity(filteredData, selectedYear);
    const activityCalendarContainer = document.querySelector('.activity-calendar');
    if (activityCalendarContainer) {
        activityCalendarContainer.innerHTML = calendarHTML;
    }
});


function populateYearOptions() {
    const startYear = 2023; // Atau tahun awal data Anda
    const endYear = new Date().getFullYear() + 1;
    const selectElement = document.getElementById('activityYear'); // Pastikan Anda memiliki elemen select dengan ID ini
    if (selectElement) {
        for (let i = startYear; i <= endYear; i++) {
            const option = document.createElement('option');
            option.value = i;
            option.textContent = i;
            option.selected = i === new Date().getFullYear();
            selectElement.appendChild(option);
        }
    }
}

const activity = {
    Jan: [
        { day: "Mon", status: "baru", date: "2025-01-06" },
        { day: "Wed", status: "selesai", date: "2025-01-08" },
        // Tambahkan data aktivitas lainnya untuk bulan Januari di sini
    ],
    Feb: [
        { day: "Fri", status: "selesai", date: "2025-02-14" },
        // Tambahkan data aktivitas lainnya untuk bulan Februari di sini
    ],
    Mar: [
        { day: "Fri", status: "selesai", date: "2025-03-14" },
        // Tambahkan data aktivitas lainnya untuk bulan Maret di sini
    ],
    Apr: [
        { day: "Fri", status: "revisi", date: "2025-04-14" },
        { day: "Fri", status: "selesai", date: "2025-04-25" },
        // Tambahkan data aktivitas lainnya untuk bulan April di sini
    ],
    May: [],
    Jun: [],
    Jul: [],
    Aug: [],
    Sep: [],
    Oct: [],
    Nov: [],
    Dec: []
    // Anda bisa menambahkan data untuk bulan-bulan lainnya di sini
};

           
document.addEventListener('DOMContentLoaded', () => {
    populateYearOptions();
    const currentYear = new Date().getFullYear();
    const initialActivitiesForYear = {};
    const rawData = activity; // Gunakan variabel 'activity' yang berisi data bulanan
    for (const month in rawData) {
        initialActivitiesForYear[month] = rawData[month]?.filter(item => { // Gunakan 'item' sebagai parameter filter
            return new Date(item.date).getFullYear() === currentYear;
        });
    }
    const activityCalendarContainer = document.querySelector('.activity-calendar');
    if (activityCalendarContainer) {
        activityCalendarContainer.innerHTML = renderActivity(initialActivitiesForYear, currentYear);
    }
});


const notificationIconDiv = document.getElementById('notificationIcon');
const notificationPopupDiv = document.getElementById('notificationPopup');
const notificationListItemsUl = document.getElementById('notificationListItems');
const markAllReadButton = document.getElementById('markAllRead');
const notificationCountSpan = document.getElementById('notificationCount');
const closeNotificationPopup = document.getElementById('closeNotificationPopup');
const notificationFullContentDiv = document.getElementById('notificationFullContent');
const fullNotificationPopupDiv = document.createElement('div');
fullNotificationPopupDiv.id = 'fullNotificationPopup';
fullNotificationPopupDiv.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
    display: none;
    z-index: 1001;
    overflow-y: auto;
`;
const fullNotificationContentDiv = document.createElement('div');
fullNotificationContentDiv.style.cssText = `
    background-color: white;
    width: 80%;
    max-width: 600px;
    border-radius: 8px;
    margin: 50px auto;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    position: relative;
    padding: 20px;
`;
const fullNotificationCloseButton = document.createElement('button');
fullNotificationCloseButton.innerHTML = '&times;';
fullNotificationCloseButton.style.cssText = `
    position: absolute;
    top: 10px;
    right: 10px;
    border: none;
    background: none;
    font-size: 1.5em;
    cursor: pointer;
    color: #888;
`;

fullNotificationContentDiv.appendChild(fullNotificationCloseButton);
fullNotificationPopupDiv.appendChild(fullNotificationContentDiv);
document.body.appendChild(fullNotificationPopupDiv);

let unreadNotifications = 0;
let notifications = [];
let currentNotificationIndex = null;

function updateNotificationCount() {
    notificationCountSpan.textContent = unreadNotifications;
    notificationCountSpan.style.display = unreadNotifications > 0 ? 'inline-block' : 'none';
}

function addNotification(notification) {
    notifications.unshift(notification);
    if (!notification.read) {
        unreadNotifications++;
        updateNotificationCount();
    }
    updateNotificationDisplay();
}

function updateNotificationDisplay() {
    notificationListItemsUl.innerHTML = '';
    if (notifications.length === 0) {
        const emptyMessage = document.createElement('li');
        emptyMessage.textContent = 'Tidak ada notifikasi baru';
        notificationListItemsUl.appendChild(emptyMessage);
    } else {
        notifications.forEach((notif, index) => {
            const listItem = document.createElement('li');
            listItem.className = 'notification-item';
            listItem.style.cursor = 'pointer';
            listItem.style.padding = '10px';
            listItem.style.borderBottom = '1px solid #eee';

            const categorySpan = document.createElement('span');
            categorySpan.className = 'notification-category';
            categorySpan.style.borderRadius = '4px';
            categorySpan.style.padding = '5px 8px';
            categorySpan.style.fontSize = '0.8em';
            categorySpan.style.fontWeight = 'bold';
            categorySpan.style.marginRight = '8px';

            if (notif.type === 'maintenance') {
                categorySpan.textContent = '[maintenance]';
                categorySpan.style.backgroundColor = '#ffe082';
                categorySpan.style.color = '#7a5206';
            } else if (notif.type === 'blog') {
                categorySpan.textContent = '[blog & note]';
                categorySpan.style.backgroundColor = '#b2ebf2';
                categorySpan.style.color = '#006064';
            } else {
                categorySpan.textContent = '[Info Umum]';
                categorySpan.style.backgroundColor = '#d1c4e9';
                categorySpan.style.color = '#311b92';
            }

            const titleSpan = document.createElement('span');
            titleSpan.className = 'notification-title';
            titleSpan.textContent = notif.title || 'No Title';
            titleSpan.style.display = 'block';
            titleSpan.style.textAlign = 'left';
            titleSpan.style.fontWeight = 'bold';
            titleSpan.style.marginBottom = '5px';

            listItem.appendChild(categorySpan);
            listItem.appendChild(titleSpan);

            listItem.addEventListener('click', (event) => {
                showFullNotificationPopup(index);
                markNotificationAsRead(index);
                event.stopPropagation();
            });

            notificationListItemsUl.appendChild(listItem);
        });
    }
}

function markNotificationAsRead(index) {
    if (notifications[index] && !notifications[index].read) {
        notifications[index].read = true;
        unreadNotifications--;
        updateNotificationCount();
    }
}

function markAllNotificationsAsRead() {
    notifications.forEach(notif => {
        if (!notif.read) {
            notif.read = true;
        }
    });
    unreadNotifications = 0;
    updateNotificationCount();
    updateNotificationDisplay();
}

notificationIconDiv.addEventListener('click', (event) => {
    event.stopPropagation();
    notificationPopupDiv.style.display = 'block';
    fullNotificationPopupDiv.style.display = 'none';
    currentNotificationIndex = null;
});

document.addEventListener('click', (event) => {
    if (!notificationIconDiv.contains(event.target) && !notificationPopupDiv.contains(event.target) && !fullNotificationPopupDiv.contains(event.target)) {
        notificationPopupDiv.style.display = 'none';
        fullNotificationPopupDiv.style.display = 'none';
        currentNotificationIndex = null;
    }
});

closeNotificationPopup.addEventListener('click', (event) => {
    notificationPopupDiv.style.display = 'none';
    fullNotificationPopupDiv.style.display = 'none';
    currentNotificationIndex = null;
    event.stopPropagation();
});

fullNotificationCloseButton.addEventListener('click', (event) => {
    fullNotificationPopupDiv.style.display = 'none';
    event.stopPropagation();
});

markAllReadButton.addEventListener('click', (event) => {
    markAllNotificationsAsRead();
    event.stopPropagation();
});

function addNoteToFirebase(text, topic) {
    addNotification({
        title: `Catatan baru: ${text.substring(0, 20)}...`,
        message: `Isi lengkap catatan: ${text}`,
        read: false,
        type: topic === 'maintenance' ? 'maintenance' : topic === 'blog' ? 'blog' : 'umum',
        fullText: text
    });
}



function showFullNotificationPopup(index) {
    const notif = notifications[index];
    if (notif) {
        let categoryText = '';
        let categoryColor = '';
        let textColor = '';

        if (notif.type === 'maintenance') {
            categoryText = '[maintenance]';
            categoryColor = '#ffe082';
            textColor = '#7a5206';
        } else if (notif.type === 'blog') {
            categoryText = '[blog & note]';
            categoryColor = '#b2ebf2';
            textColor = '#006064';
        } else {
            categoryText = '[Info Umum]';
            categoryColor = '#d1c4e9';
            textColor = '#311b92';
        }

        const fullTextWithLinks = notif.fullText
            .replace(/(https?:\/\/[^\s]+)/g, `<a href="$1" style="color: blue; text-decoration: underline;">$1</a>`);

        // Fungsi untuk membuat blok warna
        const createColoredBlock = (title, content, color) => {
            return `<div style="background-color: ${color}; padding: 10px; border-radius: 4px; margin-bottom: 10px;">
                        <h4 style="margin-top: 0; margin-bottom: 5px; font-weight: bold;">${title}</h4>
                        <p style="margin-bottom: 0;">${content}</p>
                    </div>`;
        };

        let fullTextContent = '';
        if (notif.title) {
            fullTextContent += createColoredBlock("Title", notif.title, '#f0f4c3');
        }
        if (notif.message) {
            fullTextContent += createColoredBlock("Message", notif.message, '#e0f7fa');
        }
        if (notif.tanggal) {
            fullTextContent += createColoredBlock("Tanggal", notif.tanggal, '#f8bbd0');
        }
        if (notif.deskripsi) {
            fullTextContent += createColoredBlock("Deskripsi", notif.deskripsi, '#d1c4e9');
        }
        if (notif.link) {
            fullTextContent += `<div style="margin-top: 10px; font-size: 0.9em;">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-right-circle-fill" viewBox="0 0 16 16" style="margin-right: 5px; vertical-align: middle; display: inline-block; transform: rotate(45deg);">
                                        <path d="M8 0a8 8 0 1 0 0 16A8 8 0 0 0 8 0zm3.964 8.56l-5.146 2.573a.5.5 0 0 1-.72-.488v-5.146a.5.5 0 0 1 .72-.487l5.146 2.573z"/>
                                    </svg>
                                    <a href="${notif.link}" style="color: blue; text-decoration: underline;">${notif.linkText || 'Pelajari Selengkapnya'}</a>
                                </div>`;
        }


        fullNotificationContentDiv.innerHTML = `
            <div style="position: relative;">
                <div style="background-color: ${categoryColor}; color: ${textColor}; padding: 8px; border-radius: 4px; margin-bottom: 10px; font-weight: bold; text-align: center;">
                    ${categoryText}
                </div>
                <h3 style="color: ${textColor}; margin-bottom: 10px;">${notif.title || 'Tidak Ada Judul'}</h3>
                <div style="text-align: left;">
                    ${fullTextContent}
                    ${notif.imageUrl ? `<div style="margin-top: 10px;"><img src="${notif.imageUrl}" alt="Notification Image" style="max-width: 100%; border-radius: 8px;"></div>` : ''}
                </div>
                <button style="position: absolute; top: 10px; right: 10px; border: none; background: none; font-size: 1.5em; cursor: pointer; color: #888;" onclick="this.parentNode.parentNode.style.display='none';">√ó</button>
            </div>
        `;
        fullNotificationPopupDiv.style.display = 'block';
        currentNotificationIndex = index;
    }
}

// Contoh penambahan notifikasi
addNotification({
    type: 'maintenance',
    title: 'Transaksi Berhasil',
    message: 'Pembayaran Anda telah berhasil diproses.',
    tanggal: '07 Mei 2025 pukul 13:00 WIB',
    deskripsi: 'Status: Berhasil',
    fullText: `
        
        <p>Terima kasih telah melakukan transaksi.</p>
    `,
    read: false,
    imageUrl: 'https://placehold.co/600x400/EEE/31343C',
});
addNotification({
    type: 'blog',
    title: 'Pengumuman Event Seru!',
    message: 'Jangan lewatkan event mingguan kami dengan hadiah menarik.',
    tanggal: 'Setiap hari Sabtu',
    deskripsi: 'Dapatkan kesempatan memenangkan hadiah menarik!',
    fullText: `
        
        <p>Segera daftarkan diri Anda!</p>
    `,
    read: false,
    imageUrl: 'https://placehold.co/600x400/EEE/31343C',
});
addNotification({
    type: 'umum',
    title: 'Informasi Pemeliharaan Sistem',
    message: 'Sistem akan dalam pemeliharaan pada tanggal 9 Mei 2025.',
    tanggal: '9 Mei 2025, 22:00 - 23:00 WIB',
    deskripsi: 'Mohon maaf atas ketidaknyamanannya.',
    fullText: `
        
    `,
    read: false,
    imageUrl: 'https://placehold.co/600x400/EEE/31343C',
});
addNotification({
    type: 'maintenance',
    title: 'Transaksi Uji Coba',
    message: 'Ini adalah pesan uji coba transaksi.',
    tanggal: '10 Mei 2025',
    deskripsi: 'Waktu: 14:00 WIB',
    fullText: `
        
        <p>Terima kasih telah melakukan uji coba transaksi.</p>
        
    `,
    read: false,
    imageUrl: 'https://placehold.co/600x400/EEE/31343C',
});

addNotification({
    type: 'blog',
    title: 'Event Uji Coba',
    message: 'Ini adalah pesan uji coba event.',
    tanggal: '12 Mei 2025',
    deskripsi: 'Deskripsi: Ini adalah event uji coba yang menarik.',
    fullText: `
        
        <p>Jangan lewatkan kesempatan untuk berpartisipasi dalam event uji coba ini.</p>
        
    `,
    read: false,
    imageUrl: 'https://placehold.co/600x400/EEE/31343C',
});

updateNotificationDisplay();
updateNotificationCount();


    
     

   
   
   
   
   
   
   
   
   
   
   
   
   




const blogListDiv = document.getElementById("blogList");
const blogContentArea = document.getElementById("blogContentArea");
const blogContentTitle = document.getElementById("blogContentTitle");
const blogContent = document.getElementById("blogContent");
const closeBlogContentBtn = document.getElementById("closeBlogContent");
const paginationList = document.querySelector(".pagination-list");
const paginationNext = document.querySelector(".pagination-next-link");
const showQuoraTitlesBtn = document.getElementById("showQuoraTitles");


let currentPage = 1;
const articlesPerPage = 5;
let totalPages = 0;
let currentDisplayedArticles = []; // Untuk menyimpan artikel yang sedang ditampilkan


const blogArticles = [
    {
        id: "blog-1",
        title: "Siapa Farid Ardiansyah?",
        content: `.

        <ul>
            <li></li>
            <li></li>
            <li></li>
        </ul>

        ....

        .

        .

        Seperti jawaban <a href="" style="text-decoration: underline; text-color: black; "></a>  <a href="" style="text-decoration: underline;"></a> .

        <div style="background-color: yellow; padding: 15px; border-left: 4px solid black; margin: 10px 0;">
            .
        </div>

        .

      

        <div style="text-align: center;">
            <img src="images/5.jpg" alt="Elon Musk on Mars" style="width: 80%; max-width: 500px;">
        </div>

        .
        .

        .

        <div style="position: relative; display: inline-block; margin-top: 10px;">
           <iframe width="560" height="315" 
  src="https://www.youtube.com/embed/cTPYUox41bU" 
  title="YouTube video player" 
  frameborder="0" 
  allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
  allowfullscreen>
</iframe>

            <a href="https://www.youtube.com/watch?v=cTPYUox41bU&t=2s" target="_blank" style="position: absolute; left: 50%; top: 100%; transform: translateX(-50%); margin-top: 5px; color: #000; font-size: 0.7em;">Tonton di YouTube</a>
        </div>

        <div style="background-color: yellow; padding: 15px; border-left: 4px solid red; margin: 10px 0;">
            .
        </div>

        .

        .

        .
		
		
		 <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; margin-bottom: 10px;">
            <span style="background-color: green; padding: 5px 10px; border-radius: 15px; font-size: 29px;"></span>
            <span style="background-color: red; padding: 5px 10px; border-radius: 15px; font-size: 29px;"></span>
            <span style="background-color: yellow; padding: 5px 10px; border-radius: 15px; font-size: 29px;"></span>
        </div>


        <a href="#" style="text-decoration: underline; color: #000; font-size: 29px; ">Previous : ?</a>`,
        category: "Self",
        date: "May 08, 2025",
        source: "Quora"
    },
    {
        id: "blog-2",
        title: "Coming Soon",
        content: "Coming Soon.",
        category: "Self",
        date: "May 08, 2025",
        source: "Quora"
    },
    {
        id: "blog-3",
        title: "Coming Soon",
        content: "Coming Soon.",
        category: "Arduino",
        date: "May 08, 2025",
        source: "Quora"
    },
    {
        id: "blog-4",
        title: "Coming Soon",
        content: "Coming Soon.",
        category: "IoT",
        date: "May 08, ¬†2025",
        source: "Quora"
    },
    {
        id: "blog-5",
        title: "Coming Soon?",
        content: "Coming Soon.",
        category: "Others",
        date: "May 08, 2025",
        source: "Quora"
    },
    {
        id: "blog-6",
        title: "Coming Soon?",
        content: "Coming Soon.",
        category: "Others",
        date: "May 08, 2025",
        source: "Quora"
    },
];

	
	function displayArticles(page, articlesToDisplay = blogArticles) {
    blogListDiv.innerHTML = '';
    const startIndex = (page - 1) * articlesPerPage;
    const endIndex = startIndex + articlesPerPage;
    const currentArticles = articlesToDisplay.slice(startIndex, endIndex);
    currentDisplayedArticles = articlesToDisplay; // Update artikel yang sedang ditampilkan

    const categories = ["Self", "Arduino", "IoT", "Others"];

    categories.forEach(category => {
        const categoryArticles = currentArticles.filter(article => article.category === category);

        if (categoryArticles.length > 0) {
            const categoryTitle = document.createElement('h2');
            categoryTitle.classList.add('blog-category-title');
            categoryTitle.textContent = category;
            // blogListDiv.appendChild(categoryTitle); // Kategori tidak ditampilkan

            const articleList = document.createElement('div');
            articleList.classList.add('article-list');

            categoryArticles.forEach(article => {
                const articleItem = document.createElement('div');
                articleItem.classList.add('article-item');
                articleItem.innerHTML = `
                    <div class="category-container">
                        <h3 class="blog-title" data-blog-id="${article.id}">${article.title}</h3>
                        <div style="display: flex; flex-direction: column; align-items: flex-end;">
                            <span class="blog-date">${article.date}</span>
                            <span class="blog-source">${article.source}</span>
                        </div>
                    </div>
                `;
                articleList.appendChild(articleItem);
            });
            blogListDiv.appendChild(articleList);

            const categoryDivider = document.createElement('div');
            categoryDivider.classList.add('category-divider');
            blogListDiv.appendChild(categoryDivider);
        }
    });

    // Event listener untuk menampilkan konten blog saat judul diklik
    blogListDiv.addEventListener('click', function (event) {
        const target = event.target;
        if (target.classList.contains('blog-title')) { // Pastikan yang diklik adalah judul
            const blogId = target.dataset.blogId;
            const selectedArticle = blogArticles.find(article => article.id === blogId);
            if (selectedArticle) {
                // ... (kode untuk menampilkan popup konten) ...
            }
        }
    });
}

    // Event listener untuk menampilkan konten blog saat judul diklik
    blogListDiv.addEventListener('click', function (event) {
        const target = event.target;
        if (target.classList.contains('blog-title')) { // Pastikan yang diklik adalah judul
            const blogId = target.dataset.blogId;
            const selectedArticle = blogArticles.find(article => article.id === blogId);
            if (selectedArticle) {
                // Gunakan innerHTML untuk memasukkan judul, tanggal, sumber, dan konten
                blogContentArea.innerHTML = `
                    <div id="blog-content-popup" style="display:none;
                        position: fixed;
                        top: 50%;
                        left: 50%;
                        transform: translate(-50%, -50%);
                        background-color: white;
                        padding: 20px;
                        border: 1px solid #ccc;
                        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
                        z-index: 10;
                        width: 90%;  /* Increased width */
                        max-width: 90vw; /* Ensure it doesn't overflow */
                        height: auto; /* Let height adjust to content */
                        max-height: 90vh; /* Added max-height for very large screens */
                        overflow-y: auto;">
                        <h2 class="blog-content-main-title">${selectedArticle.title}</h2>
                        <div class="blog-content-meta">
                            <span class="blog-content-date">${selectedArticle.date}</span>
                            <span class="blog-content-source">Sumber: ${selectedArticle.source}</span>
                        </div>
                        <div class="blog-content-text">${selectedArticle.content}</div>
                        <button id="close-popup" style="margin-top: 15px;">Tutup</button>
                    </div>
                `;

                // Tambahkan ini ke body, bukan ke blogContentArea
                document.body.appendChild(blogContentArea);

                const popup = document.getElementById('blog-content-popup');
                const closePopupBtn = document.getElementById('close-popup');
                const youtubePlaceholder = document.getElementById('youtube-placeholder');


                popup.style.display = 'block';

                closePopupBtn.addEventListener('click', () => {
                    popup.style.display = 'none';
                    // Bersihkan konten video saat popup ditutup.
                    if (youtubePlaceholder) {
                        youtubePlaceholder.innerHTML = `<svg style="width: 60px; height: 40px; fill: white; filter: drop-shadow(0 0 6px rgba(0,0,0,0.6));" viewBox="0 0 68 48"><path d="M66.52 7.74c-.78-2.93-2.49-5.41-5.42-6.19C55.79.13 34 0 34 0S12.21.13 6.9 1.55c-2.93.78-4.64 3.26-5.42 6.19C.06 13.05 0 24 0 24s.06 10.95 1.48 16.26c.78 2.93 2.49 5.41 5.42 6.19C12.21 47.87 34 48 34 48s21.79-.13 27.1-1.55c2.93-.78 4.64-3.26 5.42-6.19C67.94 34.95 68 24 68 24s-.06-10.95-1.48-16.26z"></path><path d="M27 33.7v-22.18c0-1.16.96-2.08 2.16-1.44l24.32 11.09c1.2 0.55 1.2 1.91 0 2.46L29.16 35.14c-1.2 0.62-2.16-.3-2.16-1.44z"></path></svg>`;
                    }
                });

                youtubePlaceholder.addEventListener('click', () => {
                    youtubePlaceholder.innerHTML = `<iframe width="100%" height="100%" src="https://www.youtube.com/embed/dQw4w9WgXcQ" frameborder="0" allow="autoplay; encrypted-media; picture-in-picture" allowfullscreen></iframe>`;
                });
            }
        }
    });


function updatePagination() {
    paginationList.innerHTML = '';
    totalPages = Math.ceil(currentDisplayedArticles.length / articlesPerPage); // Gunakan artikel yang sedang ditampilkan

    if (totalPages <= 1) {
        paginationNext.style.display = 'none';
        return; // No pagination needed if there's only one page
    } else {
        paginationNext.style.display = 'block';
    }

    for (let i = 1; i <= totalPages; i++) {
        const pageItem = document.createElement('li');
        pageItem.classList.add('pagination-item');
        if (i === currentPage) {
            pageItem.classList.add('active');
        }
        const pageLink = document.createElement('a');
        pageLink.classList.add('pagination-link');
        pageLink.href = '#';
        pageLink.textContent = i;
        pageLink.style.color = '#000';
        pageLink.addEventListener('click', (e) => {
            e.preventDefault();
            currentPage = i;
            displayArticles(currentPage, currentDisplayedArticles); // Pass artikel yang sedang ditampilkan
            updatePagination();
        });
        pageItem.appendChild(pageLink);
        paginationList.appendChild(pageItem);
    }


    // Disable "Next Page" button if on the last page
    if (currentPage === totalPages) {
        paginationNext.classList.add('disabled');
        paginationNext.onclick = function (e) {
            e.preventDefault();
        };
    } else {
        paginationNext.classList.remove('disabled');
        paginationNext.onclick = function () {
            nextPage();
        };
    }
}

function nextPage() {
    if (currentPage < totalPages) {
        currentPage++;
        displayArticles(currentPage, currentDisplayedArticles); // Pass artikel yang sedang ditampilkan
        updatePagination();
    }
}

const quoraPopup = document.getElementById('quoraPopup');
const quoraTitleList = document.getElementById('quoraTitleList');
const closeQuoraPopupBtn = document.getElementById('closeQuoraPopup');

function showQuoraTitles() {
    console.log('showQuoraTitles dijalankan');
    const quoraArticles = blogArticles.filter(article => article.source.toLowerCase() === "quora");
    console.log('Jumlah artikel Quora:', quoraArticles.length);
    console.log('Isi artikel Quora:', quoraArticles);

    // Bersihkan daftar sebelumnya
    quoraTitleList.innerHTML = '';

    // Tambahkan judul Quora ke dalam daftar
    quoraArticles.forEach(article => {
        const listItem = document.createElement('li');
        listItem.innerHTML = `
            <h3 class="blog-title-popup" data-blog-id="${article.id}" style="font-size: 1.2em; margin-bottom: 5px; cursor: pointer;">
                ${article.title}
            </h3>
            <div style="font-size: 0.8em; color: #777; margin-bottom: 8px;">
                ${article.date} ‚Äî in ${article.source}
            </div>
            ${article.id === 'blog-1' ? `<div style="margin-top: 5px; font-size: 0.9em; color: #777;">${blogArticles.find(item => item.id === 'blog-1').content.substring(0, 100)}...</div>` : ''}
        `;
        quoraTitleList.appendChild(listItem);
    });

    // Tampilkan popup
    quoraPopup.style.display = 'block';
}

// Event listener untuk menutup popup (tetap sama)
closeQuoraPopupBtn.addEventListener('click', () => {
    quoraPopup.style.display = 'none';
});

// Event listener untuk tombol "Tampilkan Judul Quora" (tetap sama)
showQuoraTitlesBtn.addEventListener('click', showQuoraTitles);

// Event listener untuk menampilkan konten blog saat judul diklik (baik di daftar utama maupun di popup)
blogListDiv.addEventListener('click', handleTitleClick);
quoraTitleList.addEventListener('click', handleTitleClick);

function handleTitleClick(event) {
    const target = event.target;
    if (target.classList.contains('blog-title') || target.classList.contains('blog-title-popup')) {
        const blogId = target.dataset.blogId;
        const selectedArticle = blogArticles.find(article => article.id === blogId);
        if (selectedArticle) {
            // Gunakan innerHTML untuk memasukkan judul, tanggal, sumber, dan konten ke dalam blogContentArea
            blogContentArea.innerHTML = `
                <div id="blog-content-popup" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: white; padding: 20px; border: 1px solid #ccc; box-shadow: 0 4px 8px rgba(0,0,0,0.2); z-index: 10; width: 90%; max-width: 90vw; height: auto; max-height: 90vh; overflow-y: auto;">
                    <h2 class="blog-content-main-title">${selectedArticle.title}</h2>
                    <div class="blog-content-meta">
                        <span class="blog-content-date">${selectedArticle.date}</span>
                        <span class="blog-content-source">Sumber: ${selectedArticle.source}</span>
                    </div>
                    <div class="blog-content-text">${selectedArticle.content}</div>
                    <button id="close-popup" style="margin-top: 15px;">Tutup</button>
                </div>
            `;

            // Tambahkan popup konten ke body
            document.body.appendChild(blogContentArea);

            const popup = document.getElementById('blog-content-popup');
            const closePopupBtn = document.getElementById('close-popup');

            popup.style.display = 'block';

            closePopupBtn.addEventListener('click', () => {
                popup.style.display = 'none';
            });
        }
    }
}


const tagFilterPopup = document.getElementById('tagFilterPopup');
const tagFilterTitle = document.getElementById('tagFilterTitle');
const tagArticleList = document.getElementById('tagArticleList');
const closeTagFilter = document.getElementById('closeTagFilter');
const blogTagElements = document.querySelectorAll('.blog-tag');

blogTagElements.forEach(tagElement => {
    tagElement.addEventListener('click', function() {
        const selectedTag = this.dataset.tag;
        const filteredArticles = filterArticlesByTagForPopup(selectedTag);
        displayFilteredArticlesInPopup(selectedTag, filteredArticles);
        tagFilterPopup.style.display = 'block';
    });
});

closeTagFilter.addEventListener('click', () => {
    tagFilterPopup.style.display = 'none';
});

function filterArticlesByTagForPopup(tag) {
    return blogArticles.filter(article =>
        article.content.toLowerCase().includes(tag.toLowerCase()) ||
        article.title.toLowerCase().includes(tag.toLowerCase())
        // Anda bisa menambahkan kondisi pencarian lain di sini jika perlu,
        // misalnya mencari di array tags jika Anda menambahkannya ke objek artikel.
    );
}

function displayFilteredArticlesInPopup(tag, articles) {
    tagFilterTitle.textContent = `Artikel dengan Tag: ${tag}`;
    tagArticleList.innerHTML = '';
    if (articles.length === 0) {
        tagArticleList.innerHTML = '<p>Tidak ada artikel dengan tag ini.</p>';
        return;
    }
    articles.forEach(article => {
        const listItem = document.createElement('li');
        listItem.style.marginBottom = '10px';
        listItem.innerHTML = `
            <h3 class="blog-title-popup" data-blog-id="${article.id}" style="font-size: 1.2em; margin-bottom: 5px; cursor: pointer;">
                ${article.title}
            </h3>
            <div style="font-size: 0.8em; color: #777;">
                ${article.date} ‚Äî in ${article.source}
            </div>
            ${article.id === 'blog-1' ? `<div style="margin-top: 5px; font-size: 0.9em; color: #777;">${blogArticles.find(item => item.id === 'blog-1').content.substring(0, 100)}...</div>` : ''}
        `;
        listItem.addEventListener('click', (event) => {
            handleTitleClick(event); // Gunakan fungsi yang sama untuk menampilkan konten blog
            tagFilterPopup.style.display = 'none'; // Tutup popup filter setelah artikel diklik
        });
        tagArticleList.appendChild(listItem);
    });
}




// Initial display (tetap menampilkan berdasarkan kategori)
displayArticles(currentPage);
updatePagination();








// Definisi kata kunci dan panduan topik
         const topicKeywords = {
            makanan: {
                keywords: ["makan", "sarapan", "siang", "malam", "restoran", "kafe", "masak", "nasi", "roti", "buah", "sayur", "daging", "ikan", "minum", "kopi", "teh", "lezat", "enak", "lapar", "kenyang"],
                guide: "Catat semua hal yang berkaitan dengan makanan di sini. Mulai dari resep, daftar belanja, hingga ulasan restoran favoritmu.",
activity: {}, // Tambahkan data aktivitas jika ada
                link: "https://id.wikipedia.org/wiki/Makanan", // Tambahkan koma di sini
                 termsContent: [
            "Ketentuan terkait topik makanan:...",
            "[gambar]images/5.jpg", // Indikasi gambar dan path
            "Informasi tambahan tentang makanan:...",
            "Tips dan trik untuk catatan makanan:..."
        ]
            },
            belajar: {
                keywords: ["belajar", "kuliah", "sekolah", "ujian", "buku", "catatan", "materi", "soal", "paham", "mengerti", "ilmu", "edukasi", "kursus", "pelajaran", "guru", "dosen"],
                guide: "Gunakan topik ini untuk mencatat materi pelajaran, tugas, atau ide-ide saat belajar.",
activity: {
            Jan: [
                { day: "Mon", status: "baru", date: "2025-01-06" },
                { day: "Wed", status: "selesai", date: "2025-01-08" }
                // ... data lain di bulan Januari
            ],
            Feb: [
                { day: "Fri", status: "selesai", date: "2025-02-14" }
                // ... data lain di bulan Februari
            ],
            // ... bulan-bulan lain
			Mar: [
                { day: "Fri", status: "selesai", date: "2025-03-14" }
                // ... data lain di bulan Februari
            ],
            // ... bulan-bulan lain
			Apr: [
                { day: "Fri", status: "revisi", date: "2025-04-14" },
				{ day: "Fri", status: "selesai", date: "2025-04-25" }
                // ... data lain di bulan Februari
            ],
            // ... bulan-bulan lain
        },
 
                link: "https://id.wikipedia.org/wiki/Pendidikan"
            },

                
            pekerjaan: {
                keywords: ["kerja", "kantor", "meeting", "proyek", "deadline", "tugas", "karir", "gaji", "bos", "rekan kerja", "laporan", "presentasi", "wawancara", "promosi", "bisnis"],
                guide: "Catat semua hal terkait pekerjaanmu, seperti ide proyek, catatan rapat, atau daftar tugas.",
activity: {
            Jan: [
                { day: "Mon", status: "baru", date: "2026-01-06" },
                { day: "Wed", status: "selesai", date: "2026-01-08" }
                // ... data lain di bulan Januari
            ],
            Feb: [
                { day: "Fri", status: "selesai", date: "2026-02-14" }
                // ... data lain di bulan Februari
            ],
            // ... bulan-bulan lain
			Mar: [
                { day: "Fri", status: "selesai", date: "2026-03-14" }
                // ... data lain di bulan Februari
            ],
            // ... bulan-bulan lain
			Apr: [
                { day: "Fri", status: "revisi", date: "2026-04-14" },
				{ day: "Fri", status: "selesai", date: "2026-04-25" }
                // ... data lain di bulan Februari
            ],
            // ... bulan-bulan lain
        },
 
                link: "https://id.wikipedia.org/wiki/Pendidikan"
            },
			
			
            hiburan: {
                keywords: ["nonton", "film", "musik", "konser", "game", "buku", "komik", "liburan", "jalan-jalan", "pesta", "tertawa", "senang", "bahagia", "santai"],
                guide: "Tempat untuk mencatat ide film, buku yang ingin dibaca, atau rencana liburanmu.",
activity: {}, // Tambahkan data aktivitas jika ada
                link: "https://id.wikipedia.org/wiki/Hiburan"
            },
            kesehatan: {
                keywords: ["sehat", "sakit", "dokter", "obat", "olahraga", "bugar", "istirahat", "tidur", "vitamin", "diet", "alergi", "demam", "flu", "stres"],
                guide: "Catat informasi kesehatan penting, jadwal olahraga, atau gejala yang kamu rasakan.",
activity: {}, // Tambahkan data aktivitas jika ada
                link: "https://id.wikipedia.org/wiki/Kesehatan"
            },
            cinta: {
                keywords: ["cinta", "sayang", "pacar", "hubungan", "hati", "perasaan", "rindu", "kangen", "putus", "nikah", "kasih", "mesra", "romantis"],
                guide: "Curahkan isi hatimu dan catatan tentang hubunganmu di sini.",
activity: {}, // Tambahkan data aktivitas jika ada
                link: "https://id.wikipedia.org/wiki/Cinta"
            },
            lainlain: {
                keywords: [],
                guide: "Catatan yang tidak termasuk dalam kategori lain akan dikumpulkan di sini.",
activity: {}, // Tambahkan data aktivitas jika ada
                link: "#"
            }
        };



       

¬† ¬† ¬† ¬† function categorizeNote(text) {
¬† ¬† ¬† ¬† ¬† ¬† const lowerCaseText = text.toLowerCase();
¬† ¬† ¬† ¬† ¬† ¬† for (const topic in topicKeywords) {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if (topicKeywords[topic].keywords.some(keyword => lowerCaseText.includes(keyword))) {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† return topic;
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† }
¬† ¬† ¬† ¬† ¬† ¬† }
¬† ¬† ¬† ¬† ¬† ¬† return "lainlain";
¬† ¬† ¬† ¬† }

¬† ¬† ¬† ¬† async function addNote() {
    const text = noteInput.value.trim();
    if (!text) return;

    const topic = categorizeNote(text);

    try {
        const newNoteRef = await addDoc(notesRef, { text, topic, createdAt: serverTimestamp() });
        noteInput.value = "";
        showPopup();

        // Dapatkan timestamp catatan baru
        const noteDoc = await getDoc(newNoteRef);
        const createdAt = noteDoc.data().createdAt.toDate();
        const year = createdAt.getFullYear();
        const month = new Intl.DateTimeFormat('en', { month: 'short' }).format(createdAt);
        const day = String(createdAt.getDate()).padStart(2, '0');
        const dateString = `${year}-${String(createdAt.getMonth() + 1).padStart(2, '0')}-${day}`;

        // Perbarui data aktivitas (ini adalah contoh sederhana, perlu disesuaikan dengan struktur data Anda)
        if (topicKeywords[topic] && topicKeywords[topic].activity && topicKeywords[topic].activity[month]) {
            const existingActivity = topicKeywords[topic].activity[month].find(item => item.date === dateString);
            if (!existingActivity) {
                topicKeywords[topic].activity[month].push({ date: dateString, status: 'new' });
                // Anda mungkin perlu cara untuk menandai ini sebagai 'updated' agar tampilan di-refresh
            }
            // Refresh tampilan catatan untuk topik ini (perlu implementasi yang lebih baik)
            const q = query(notesRef, orderBy("createdAt"));
            onSnapshot(q, snapshot => {
                const allNotes = snapshot.docs;
                const filteredNotes = currentFilter === "semua" ? allNotes : allNotes.filter(doc => (doc.data().topic || "lainlain").toLowerCase() === currentFilter);
                displayNotes(filteredNotes, document.querySelector(`#activityYear-${topic}`).value); // Pertahankan tahun yang dipilih
            });

        }

    } catch (error) {
        alert("Gagal menyimpan: " + error.message);
        console.error(error);
    }
}

¬† ¬† ¬† ¬† function showPopup() {
¬† ¬† ¬† ¬† ¬† ¬† popup.classList.add("show");
¬† ¬† ¬† ¬† ¬† ¬† setTimeout(() => popup.classList.remove("show"), 2000);
¬† ¬† ¬† ¬† }

¬† ¬† ¬† ¬† 
function displayNotes(notes) {
    noteList.innerHTML = "";
    const groupedNotes = {};
    const topicCounts = {};

    notes.forEach(doc => {
        const topic = doc.data().topic || "lainlain";
        if (!groupedNotes[topic]) {
            groupedNotes[topic] = [];
        }
        groupedNotes[topic].push(doc);
        topicCounts[topic] = (topicCounts[topic] || 0) + 1;
    });

    const sortedTopics = Object.keys(groupedNotes).sort((a, b) => (topicCounts[b] || 0) - (topicCounts[a] || 0));
    const mostFrequentTopic = sortedTopics[0];

    const recentNotes = notes.slice().sort((a, b) => b.data().createdAt - a.data().createdAt).slice(0, 5);
    if (recentNotes.length > 0) {
        const recentNotesDiv = document.createElement("div");
        recentNotesDiv.className = "note-group";
        const heading = document.createElement("h2");
        heading.textContent = "Catatan Terbaru";
        recentNotesDiv.appendChild(heading);
        recentNotes.forEach((doc, index) => {
            recentNotesDiv.appendChild(renderNote(doc, index === 0));
        });
        noteList.appendChild(recentNotesDiv);
    }

    sortedTopics.forEach(topic => {
        const topicDiv = document.createElement("div");
        topicDiv.className = "note-group";
        const heading = document.createElement("h2");
        const topicName = topic.charAt(0).toUpperCase() + topic.slice(1);
        const count = topicCounts[topic] || 0;
        heading.textContent = `${topicName} (${count}) ${topic === mostFrequentTopic && Object.keys(groupedNotes).length > 1 ? '‚≠ê' : ''}`; // Tambahkan jumlah di sini
        topicDiv.appendChild(heading);

        if (topic !== "lainlain" && topicKeywords[topic] && topicKeywords[topic].activity) {
            const activityTitle = document.createElement("h3");
            activityTitle.style.fontSize = "16px";
            activityTitle.style.fontWeight = "bold";
            activityTitle.style.marginTop = "10px";
            activityTitle.textContent = "Aktivitas";
            topicDiv.appendChild(activityTitle);
            const currentYear = new Date().getFullYear();
            topicDiv.innerHTML += renderActivity(topicKeywords[topic].activity, currentYear);
        }

        const notesInTopic = groupedNotes[topic];
        notesInTopic.forEach((doc, idx) => {
            const isLatest = idx === notesInTopic.length - 1 && topic === sortedTopics[sortedTopics.length - 1];
            topicDiv.appendChild(renderNote(doc, isLatest));
        });
        noteList.appendChild(topicDiv);
        if (notesInTopic.length === 0) {
            const emptyMessage = document.createElement("p");
            emptyMessage.className = "empty-topic";
            emptyMessage.textContent = "Belum ada catatan untuk topik ini.";
            topicDiv.appendChild(emptyMessage);
        }
    });

    if (Object.keys(groupedNotes).length === 0) {
        const emptyAllMessage = document.createElement("p");
        emptyAllMessage.className = "empty-topic";
        emptyAllMessage.textContent = "Belum ada catatan.";
        noteList.appendChild(emptyAllMessage);
    }

    // Perbarui juga tombol filter topik dengan jumlah catatan
    const topicFilterButtons = document.querySelectorAll('.topic-filter .topic-button');
    topicFilterButtons.forEach(button => {
        const topic = button.dataset.topic;
        if (topic === 'semua') {
            const allCount = notes.length;
            button.textContent = `Semua (${allCount})`;
        } else {
            const count = topicCounts[topic] || 0;
            const topicName = topic.charAt(0).toUpperCase() + topic.slice(1);
            button.textContent = `${topicName} (${count})`;
        }
    });
}

// Pastikan Anda mengganti 'noteList' dengan ID yang benar untuk tempat Anda menampilkan daftar topik
const topicList = document.getElementById("noteList"); // Asumsi ID-nya adalah 'noteList'

¬† ¬† ¬† ¬† const q = query(notesRef, orderBy("createdAt"));
¬† ¬† ¬† ¬† onSnapshot(q, snapshot => {
¬† ¬† ¬† ¬† ¬† ¬† const allNotes = snapshot.docs;
¬† ¬† ¬† ¬† ¬† ¬† const uniqueTopics = ["semua"];
¬† ¬† ¬† ¬† ¬† ¬† for (const topic in topicKeywords) {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if (!uniqueTopics.includes(topic)) {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† uniqueTopics.push(topic);
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† }
¬† ¬† ¬† ¬† ¬† ¬† }

¬† ¬† ¬† ¬† ¬† ¬† // Render tombol filter topik
¬† ¬† ¬† ¬† ¬† ¬† topicFilter.innerHTML = '<button class="topic-button active" data-topic="semua">Semua</button>';
¬† ¬† ¬† ¬† ¬† ¬† uniqueTopics.slice(1).forEach(topic => {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† const button = document.createElement("button");
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† button.className = "topic-button";
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† button.dataset.topic = topic;
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† button.textContent = topic.charAt(0).toUpperCase() + topic.slice(1);
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† topicFilter.appendChild(button);
¬† ¬† ¬† ¬† ¬† ¬† });

¬† ¬† ¬† ¬† ¬† ¬† const filteredNotes = currentFilter === "semua" ? allNotes : allNotes.filter(doc => (doc.data().topic || "lainlain").toLowerCase() === currentFilter);
¬† ¬† ¬† ¬† ¬† ¬† displayNotes(filteredNotes);
¬† ¬† ¬† ¬† });

¬† ¬† ¬† ¬† saveBtn.addEventListener("click", addNote);
¬† ¬† ¬† ¬† noteInput.addEventListener("keydown", (e) => {
¬† ¬† ¬† ¬† ¬† ¬† if (e.key === "Enter") addNote();
¬† ¬† ¬† ¬† });

topicFilter.addEventListener("click", (event) => {
    if (event.target.classList.contains("topic-button")) {
        document.querySelectorAll(".topic-button").forEach(btn => btn.classList.remove("active"));
        event.target.classList.add("active");
        currentFilter = event.target.dataset.topic;
        const q = query(notesRef, orderBy("createdAt"));
        onSnapshot(q, snapshot => {
            const allNotes = snapshot.docs;
            const filteredNotes = currentFilter === "semua" ? allNotes : allNotes.filter(doc => (doc.data().topic || "lainlain").toLowerCase() === currentFilter);
            displayNotes(filteredNotes);
        });

        // Tampilkan panduan topik yang sesuai
        const selectedTopic = event.target.dataset.topic;
        if (topicKeywords[selectedTopic] && selectedTopic !== 'semua') {
            const guideContent = document.getElementById('guideContent');
            guideContent.innerHTML = `
                <p id="guideText">${topicKeywords[selectedTopic].guide}</p>
                <p><a id="learnMoreLink" href="#" data-topic="${selectedTopic}">Pelajari Lebih Lanjut</a></p>
            `;
            guidePopup.classList.add("show");
            overlay.classList.add("show");

            // Tambahkan event listener untuk tombol "Pelajari Lebih Lanjut" di panduan
            const learnMoreBtn = document.getElementById('learnMoreLink');
            if (learnMoreBtn) {
                learnMoreBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    const currentTopic = e.target.dataset.topic;
                    showTermsModal(currentTopic);
                });
            }
        } else {
            guidePopup.classList.remove("show");
            overlay.classList.remove("show");
        }
    }
});
¬† ¬† ¬† ¬† closeGuideBtn.addEventListener("click", () => {
¬† ¬† ¬† ¬† ¬† ¬† guidePopup.classList.remove("show");
¬† ¬† ¬† ¬† ¬† ¬† overlay.classList.remove("show");
¬† ¬† ¬† ¬† });

¬† ¬† ¬† ¬† overlay.addEventListener("click", () => {
¬† ¬† ¬† ¬† ¬† ¬† guidePopup.classList.remove("show");
¬† ¬† ¬† ¬† ¬† ¬† overlay.classList.remove("show");
¬† ¬† ¬† ¬† });
const termsModal = document.getElementById('termsModal');
const closeTermsModalBtn = document.getElementById('closeTermsModal');
const learnMoreLinkOutside = document.getElementById('learnMoreLink');


closeTermsModalBtn.addEventListener('click', () => {
  termsModal.style.display = 'none';
  overlay.style.display = 'none';
});

window.addEventListener('click', (e) => {
  if (e.target === termsModal) {
    termsModal.style.display = 'none';
    overlay.style.display = 'none';
  }
});

function showTermsModal(topic) {
    const termsModal = document.getElementById('termsModal');
    const termsContentDiv = termsModal.querySelector('.modal-content');
    termsContentDiv.innerHTML = `
        <button class="close-btn" id="closeTermsModal">&times;</button>
        <div style="background-color: #E0F7FA; padding: 15px; border-radius: 8px; margin-bottom: 10px; text-align: left;">
            <div style="display: flex; align-items: center; margin-bottom: 5px;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: 20px; height: 20px; margin-right: 8px;"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline></svg>
                <h2 style="font-size: 1.2em; margin: 0;">Ketentuan</h2>
            </div>
            <ol id="termsNumberedList" style="padding-left: 20px; margin-top: 10px;"></ol>
        </div>
        <div style="background-color: #FCE4EC; padding: 10px; border-radius: 6px; margin-bottom: 10px; text-align: left; font-size: 0.9em;">
            <span style="color: #E91E63;">: Halaman Ketentuan</span>
        </div>
        <div style="display: flex; align-items: center; font-size: 29px; color: #757575;">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: 39px; height: 39px; margin-right: 5px;"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
            <span>Terakhir diperbarui: 21 April 2025</span>
        </div>
    `;

    const termsNumberedList = document.getElementById('termsNumberedList');
    const closeBtn = termsModal.querySelector('#closeTermsModal');

    if (topicKeywords[topic] && topicKeywords[topic].termsContent) {
        topicKeywords[topic].termsContent.forEach(content => {
            const li = document.createElement('li');
            if (content.startsWith('[gambar]')) {
                const imagePath = content.substring('[gambar]'.length).trim();
                const img = document.createElement('img');
                img.src = imagePath;
                img.style.maxWidth = '100%';
                img.style.height = 'auto';
                img.style.marginBottom = '10px';
                li.appendChild(img);
            } else {
                li.textContent = content;
            }
            termsNumberedList.appendChild(li);
        });
        termsModal.style.display = 'flex';
        overlay.style.display = 'block';
        guidePopup.classList.remove('show');

        closeBtn.addEventListener('click', () => {
            termsModal.style.display = 'none';
            overlay.style.display = 'none';
        });
    } else {
        termsNumberedList.innerHTML = '<li>Tidak ada informasi lebih lanjut untuk topik ini.</li>';
        termsModal.style.display = 'flex';
        overlay.style.display = 'block';
        guidePopup.classList.remove('show');

        closeBtn.addEventListener('click', () => {
            termsModal.style.display = 'none';
            overlay.style.display = 'none';
        });
    }
}

overlay.addEventListener('click', (e) => {
    const termsModal = document.getElementById('termsModal');
    const guidePopup = document.getElementById('guidePopup');
    if (e.target === overlay) {
        termsModal.style.display = 'none';
        guidePopup.classList.remove('show');
        overlay.style.display = 'none';
    }
});


const infoPopup = document.getElementById('info-popup');
const infoPopupText = document.getElementById('info-popup-text');
const infoCards = document.querySelectorAll('.info-card');

const infoContents = {
    ketentuan: `
        <h2><span class="info-icon">üìú</span>Ketentuan</h2>
        <div class="info-content-block info-blue-block">
            <p><strong>1.</strong>.</p>
        </div>
        <div class="info-content-block info-yellow-block">
            <p><strong>2.</strong> Pengguna diharapkan menggunakan platform ini, untuk tujuan catatan yang positif dan efektif.</p>
        </div>
        <div class="info-content-block info-red-block">
            <p><strong>3.</strong> .</p>
            <p><strong>4.</strong> Pengembang bertanggung jawab atas kesalahan pribadi pengguna yg disengaja/ga sengaja .</p>
            <img src="images/5.jpg" alt=""/>
            <p>: <a href="" target="_blank">Halaman Ketentuan</a></p>
        </div>
        <p style="text-align:right; color: black; text-align: left; margin-top:1rem;">üìÖ Terakhir diperbarui: 28 April 2025 Jam 21.30</p>
    `,
    tentang: `
        <h2><span class="info-icon">‚ÑπÔ∏è</span>Tentang Kami</h2>
        <div class="info-content-block info-green-block">
            <p><strong>1.</strong> Noted adalah platform catatan sederhana yang dirancang untuk membantu Anda mencatat ide, tugas, dan informasi penting lainnya.</p>
            <p><strong>2.</strong> Kami berkomitmen untuk menyediakan antarmuka yang bersih dan mudah digunakan agar pengalaman mencatat Anda menjadi lebih efisien.</p>
            <p><strong>3.</strong> Noted adalah inisiatif pribadi untuk belajar dan berbagi pengetahuan di bidang pengembangan web.</p>
            <img src="images/5.jpg" alt="Tentang Kami"/>
            <p>: <a href="" target="_blank">Halaman Tentang Kami</a></p>
        </div>
        <p style="text-align:right; color: black; text-align: left; margin-top:1rem;">üìÖ Terakhir diperbarui: 28 April 2025 Jam 21.30</p>
    `,
    privasi: `
        <h2><span class="info-icon">üîí</span>Kebijakan Privasi</h2>
        <div class="info-content-block info-pink-block">
            <p><strong>1.</strong> Kami tidak mengumpulkan informasi pribadi Anda kecuali yang Anda masukkan secara sukarela ke dalam catatan.</p>
            <p><strong>2.</strong> Catatan Anda disimpan secara database online di perangkat website noted dan tidak dibagikan dengan pihak ketiga tanpa izin eksplisit Anda.</p>
            <p><strong>3.</strong> Kami menghormati privasi Anda dan berkomitmen untuk melindungi informasi yang Anda simpan di platform ini.</p>
            <p><strong>4.</strong> Untuk detail lebih lanjut mengenai bagaimana data Anda ditangani, silakan merujuk ke kebijakan privasi lengkap kami.</p>
            <img src="images/5.jpg" alt="Privasi"/>
            <p>Lihat kebijakan privasi lengkap: <a href="" target="_blank">Kebijakan Privasi</a>.</p>
        </div>
        <p style="text-align:right; color: black; text-align: left; margin-top:1rem;">üìÖ Terakhir diperbarui: 28 April 2025 Jam 21.30</p>
    `
};

function openInfoPopup(type) {
    if (infoContents[type]) {
        infoPopupText.innerHTML = `
            <button class="info-close-btn" onclick="closeInfoPopup()">√ó</button>
            ${infoContents[type]}
        `;
        infoPopup.style.display = 'flex';
    }
}

function closeInfoPopup() {
    infoPopup.style.display = 'none';
}

infoCards.forEach(card => {
    card.addEventListener('click', function() {
        const type = this.dataset.type;
        openInfoPopup(type);
    });
});

infoPopup.addEventListener('click', function(e) {
    if (e.target === this) {
        closeInfoPopup();
    }
});

  
  document.addEventListener("DOMContentLoaded", function () {
    const roleDescriptions = {
      admin: {
        label: "Admin",
        desc: "Admin memiliki akses penuh terhadap sistem, termasuk manajemen user dan kontrol konten.",
        colorClass: "admin"
      },
      kontributor: {
        label: "Kontributor",
        desc: "Kontributor dapat menambah atau mengedit konten namun tidak memiliki kontrol admin.",
        colorClass: "kontributor"
      },
      member: {
        label: "Member",
        desc: "Member adalah pengguna biasa yang bisa melihat konten dan memberikan komentar.",
        colorClass: "member"
      }
    };

    document.querySelectorAll(".badge").forEach(badge => {
      badge.addEventListener("click", function () {
        let role = null;
        if (this.classList.contains("admin")) role = "admin";
        if (this.classList.contains("kontributor")) role = "kontributor";
        if (this.classList.contains("member")) role = "member";

        if (!role) return;

        const popupOverlay = document.getElementById("role-popup-overlay");
        const popupBadge = document.getElementById("role-popup-badge");
        const popupDesc = document.getElementById("role-popup-desc");

        const data = roleDescriptions[role];
        popupBadge.textContent = data.label;
        popupBadge.className = `badge ${data.colorClass}`;
        popupDesc.textContent = data.desc;

        popupOverlay.classList.add("show");
      });
    });

    // Close popup
    document.getElementById("role-popup-overlay").addEventListener("click", function (e) {
      if (e.target === this || e.target.classList.contains("close-btn")) {
        this.classList.remove("show");
      }
    });
  });
  
  
function renderNote(docOrData, isLatest = false) {
    let noteData;
    let noteId;

    if (docOrData && typeof docOrData.data === 'function') {
        noteData = docOrData.data();
        noteId = docOrData.id;
    } else if (docOrData && typeof docOrData === 'object') {
        noteData = docOrData;
        noteId = docOrData.id;
    } else {
        console.warn("renderNote dipanggil dengan input yang tidak valid. Mengembalikan placeholder.");
        return document.createElement('div');
    }

    const role = noteData.role || "member";
    const isSaved = noteData.isSaved || false;
    const noteText = noteData.text || "Catatan kosong";
    const saveButtonText = isSaved ? "Disimpan" : "Simpan";
    const saveButtonClass = isSaved ? "save-individual-note saved" : "save-individual-note";
    const temaTopik = noteData.temaTopik || "lain-lain";

    const noteEl = document.createElement("div");
    noteEl.className = `note-card`;
    noteEl.dataset.topic = temaTopik.toLowerCase(); // Set data-topic, gunakan temaTopik

    noteEl.innerHTML = `
        <div class="timeline-dot ${isLatest ? "active" : ""}"></div>
        <div class="note-body">
            <div class="note-text">${noteText}</div>
            <div class="note-actions">
                <button class="${saveButtonClass}" data-id="${noteId}">
                ${saveButtonText}
                </button>
                <div class="arrow">
                <svg fill="none" stroke="#6b7280" stroke-width="2" viewBox="0 0 24 24">
                    <path d="M5 12h14M12 5l7 7-7 7" />
                </svg>
                </div>
            </div>
            <span class="badge ${role}" data-role="${role}">${role}</span>
        </div>
    `;

    const saveButton = noteEl.querySelector(".save-individual-note");
    if (saveButton) {
        saveButton.addEventListener("click", async (event) => {
        const clickedButton = event.target;
        const noteId = clickedButton.dataset.id;
        const isCurrentlySaved = clickedButton.classList.contains("saved");

        try {
            await toggleSaveNote(noteId, isCurrentlySaved, noteData);
            clickedButton.classList.toggle("saved", !isCurrentlySaved);
            clickedButton.textContent = !isCurrentlySaved ? "Disimpan" : "Simpan";
            if (savedNotesModal?.style?.display === "flex") {
            displaySavedNotesPopup();
            }
        } catch (error) {
            console.error("Error toggling save state:", error);
            alert("Failed to save note. Please try again.");
        }
        });
    }

    const badgeElement = noteEl.querySelector(".badge");
    if (badgeElement) {
        badgeElement.addEventListener("click", () => {
        showRolePopup(role);
        });
    }

    return noteEl;
}




function showRolePopup(role) {
¬† const rolePopupOverlay = document.getElementById('role-popup-overlay');
¬† const rolePopupBadge = document.getElementById('role-popup-badge');
¬† const rolePopupDesc = document.getElementById('role-popup-desc');

¬† // Tentukan deskripsi peran berdasarkan peran
¬† let description = "";
¬† switch (role) {
¬† ¬† case "admin":
¬† ¬† ¬† description = "Administrator memiliki akses penuh ke semua fitur dan pengelolaan catatan.";
¬† ¬† ¬† break;
¬† ¬† case "moderator":
¬† ¬† ¬† description = "Moderator dapat mengelola dan memoderasi catatan dalam topik tertentu.";
¬† ¬† ¬† break;
¬† ¬† case "member":
¬† ¬† ¬† description = "Member adalah pengguna biasa yang dapat melihat dan membuat catatan.";
¬† ¬† ¬† break;
¬† ¬† default:
¬† ¬† ¬† description = "Peran tidak diketahui.";
¬† }

¬† rolePopupBadge.className = `badge ${role}`;
¬† rolePopupBadge.textContent = role;
¬† rolePopupDesc.textContent = description;
¬† rolePopupOverlay.classList.add('show');
}

// Pastikan Anda memiliki event listener untuk menutup popup
const rolePopupOverlay = document.getElementById('role-popup-overlay');
if (rolePopupOverlay) {
¬† const closeButton = rolePopupOverlay.querySelector('.close-btn');
¬† if (closeButton) {
¬† ¬† closeButton.addEventListener('click', () => {
¬† ¬† ¬† rolePopupOverlay.classList.remove('show');
¬† ¬† });
¬† }
}

function renderActivity(activityData, year) {
    const monthsOrder = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
    const daysInWeek = ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"];
    let activityHTML = '<div style="overflow-x: auto;"><table style="border-collapse: collapse; font-family: sans-serif; font-size: 11px;">';

    // Header Bulan
    activityHTML += '<thead><tr><th></th>';
    monthsOrder.forEach(month => {
        const daysInMonth = getDaysInMonth(new Date(year, monthsOrder.indexOf(month), 1));
        activityHTML += `<th colspan="${daysInMonth}" style="padding: 8px; text-align: center;">${month}</th>`; // Padding lebih besar
    });
    activityHTML += '</tr></thead>';

    activityHTML += '<tbody>';
    daysInWeek.forEach(day => {
        activityHTML += `<tr><th style="padding-right: 8px; text-align: left;">${day}</th>`;
        monthsOrder.forEach(month => {
            const daysInMonth = getDaysInMonth(new Date(year, monthsOrder.indexOf(month), 1));
            for (let i = 1; i <= daysInMonth; i++) {
                const dateString = `${year}-${String(monthsOrder.indexOf(month) + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                const activity = activityData[month]?.find(item => item.date === dateString);
                let backgroundColor = '#000'; // Belum pernah berwarna hitam
                let tooltipText = `Belum ada aktivitas pada ${dateString}`;

                if (activity) {
                    if (activity.status === 'selesai') {
                        backgroundColor = '#40c463'; // Selesai berwarna hijau
                        tooltipText = `Selesai pada ${dateString}`;
                    } else if (activity.status === 'revisi') {
                        backgroundColor = '#ff0000'; // Revisi berwarna merah
                        tooltipText = `Direvisi pada ${dateString}`;
                    } else if (activity.status === 'baru') {
                        backgroundColor = 'yellow'; // Baru berwarna kuning (sebelumnya 'new')
                        tooltipText = `Aktivitas baru pada ${dateString}`;
                    }
                }

                activityHTML += `<td
                    style="width: 16px; height: 16px; border: 1px solid #eee; background-color: ${backgroundColor}; cursor: pointer;"
                    title="${tooltipText}"
                    data-has-activity="${activity ? 'true' : 'false'}"
                    data-status="${activity ? activity.status : ''}"
                    data-date="${dateString}"
                ></td>`;
            }
        });
        activityHTML += '</tr>';
    });

    activityHTML += '</tbody></table>';
    activityHTML += '<div style="margin-top: 5px; font-size: 10px; color: #586069;">Belum Pernah <span style="width: 10px; height: 10px; display: inline-block; background-color: #000; border: 1px solid #eee; margin: 0 5px;"></span> Baru <span style="width: 10px; height: 10px; display: inline-block; background-color: yellow; border: 1px solid #eee; margin: 0 5px;"></span> Selesai <span style="width: 10px; height: 10px; display: inline-block; background-color: #40c463; border: 1px solid #eee; margin: 0 5px;"></span> Revisi <span style="width: 10px; height: 10px; display: inline-block; background-color: #ff0000; border: 1px solid #eee; margin: 0 5px;"></span></div>';
    activityHTML += '</div>';
    return activityHTML;
}

function getDaysInMonth(date) {
    return new Date(date.getFullYear(), date.getMonth() + 1, 0).getDate();
}
document.getElementById('noteList').addEventListener('click', function(event) {
    const target = event.target;
    if (target.tagName === 'TD') {
        const hasActivity = target.dataset.hasActivity === 'true';
        const status = target.dataset.status;
        const date = target.dataset.date;

        console.log("Sel diklik - hasActivity:", hasActivity, "status:", status, "date:", date); // Tambahkan ini

        let day = '';
        let monthName = '';
        let year = '';

        if (date) {
            const [y, m, d] = date.split('-');
            year = y;
            const monthIndex = parseInt(m) - 1;
            const dateObject = new Date(year, monthIndex, parseInt(d));
            monthName = new Intl.DateTimeFormat('id-ID', { month: 'long' }).format(dateObject);
            day = d;
        }

        document.getElementById('activity-popup-title').textContent = `Ketentuan`;
        let detailsHTML = '';
        const imageUrl = 'images/5.jpg'; // Sumber gambar

        if (hasActivity) {
            let bgColor = '';
            let activityText = '';
            let linkHref = '';
            let linkText = '';

            if (status === 'selesai') {
                bgColor = '#aaff80';
                activityText = `Selamat! Catatan pada tanggal ${day} ${monthName} ${year} telah selesai.`;
                linkHref = 'https://example.com/selesai';
                linkText = 'Lihat catatan yang selesai';
            } else if (status === 'revisi') {
                bgColor = '#ffdd99';
                activityText = `Perhatian! Catatan pada tanggal ${day} ${monthName} ${year} memerlukan revisi.`;
                linkHref = 'https://example.com/revisi';
                linkText = 'Lihat catatan yang perlu direvisi';
            } else if (status === 'baru') {
                bgColor = '#ccf2ff';
                activityText = `Catatan baru ditambahkan pada tanggal ${day} ${monthName} ${year}.`;
                linkHref = 'https://example.com/baru';
                linkText = 'Lihat catatan baru';
            }

            detailsHTML = `
                <div style="background-color: ${bgColor}; padding: 15px; border-radius: 8px;">
                    <h3>${status ? status.charAt(0).toUpperCase() + status.slice(1) : 'Aktivitas'}</h3>
                    <p>${activityText}</p>
                    <img src="${imageUrl}" alt="${status || 'Aktivitas'}" style="max-width: 100%; margin-top: 10px;">
                    ${linkHref ? `<p><a href="${linkHref}" target="_blank">${linkText}</a></p>` : ''}
                </div>
            `;
        } else {
            detailsHTML = `
                <div style="background-color: #f0f0f0; padding: 15px; border-radius: 8px;">
                    <h3>Tidak Ada Aktivitas</h3>
                    <p>Belum ada aktivitas pada tanggal ${day} ${monthName} ${year}.</p>
                    <img src="${imageUrl}" alt="Tidak ada aktivitas" style="max-width: 100%; margin-top: 10px;">
                    <p><a href="https://example.com/tidak-ada" target="_blank">Pelajari lebih lanjut</a></p>
                </div>
            `;
        }

        document.getElementById('activity-popup-details').innerHTML = detailsHTML;
        document.getElementById('activity-popup-overlay').classList.add('show');
    }
});

   
   // Tanggal saat ini (auto-updates)
        const today = new Date();

        // Tanggal target: 29 Mei tahun ini
        const targetDate = new Date(today.getFullYear(), 4, 29); // Bulan 4 adalah Mei (0-indeks)

        // Jika tanggal target sudah lewat di tahun ini, atur ke tahun depan
        if (targetDate.getTime() < today.getTime()) {
            targetDate.setFullYear(today.getFullYear() + 1);
        }

        const countdownElement = document.getElementById('countdown');

        function updateCountdown() {
            const now = new Date().getTime();
            const distance = targetDate.getTime() - now;

            // Jika hitungan mundur selesai
            if (distance < 0) {
                countdownElement.innerHTML = "Happy Birthday!"; // Atau pesan lain
                clearInterval(countdownInterval);
                return;
            }

            // Perhitungan waktu
            const days = Math.floor(distance / (1000 * 60 * 60 * 24));
            const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((distance % (1000 * 60)) / 1000);

            // Tampilkan hasil
            countdownElement.innerHTML = `${days} hari ${hours} jam ${minutes} menit ${seconds} detik lagi`;
        }

        // Panggil fungsi updateCountdown segera setelah dimuat dan setiap detik
        updateCountdown();
        const countdownInterval = setInterval(updateCountdown, 1000);

      ¬† ¬† ¬† // --- FUNGSI UNTUK POPUP (Tidak berubah, ini hanya disertakan untuk kelengkapan) ---

¬† ¬† ¬† ¬† const infoBar = document.getElementById('infoBar');

¬† ¬† ¬† ¬† const modal = document.getElementById('myModal');

¬† ¬† ¬† ¬† const closeModalBtn = document.getElementById('closeModalBtn');



¬† ¬† ¬† ¬† if (infoBar && modal && closeModalBtn) { // Pastikan elemen ada sebelum menambahkan event listener

¬† ¬† ¬† ¬† ¬† ¬† infoBar.addEventListener('click', () => {

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† modal.classList.add('perjalanan-hidup-modal-show');

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† document.body.style.overflow = 'hidden';

¬† ¬† ¬† ¬† ¬† ¬† });



¬† ¬† ¬† ¬† ¬† ¬† closeModalBtn.addEventListener('click', () => {

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† modal.classList.remove('perjalanan-hidup-modal-show');

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† document.body.style.overflow = '';

¬† ¬† ¬† ¬† ¬† ¬† });



¬† ¬† ¬† ¬† ¬† ¬† window.addEventListener('click', (event) => {

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if (event.target === modal) {

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† modal.classList.remove('perjalanan-hidup-modal-show');

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† document.body.style.overflow = '';

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† }

¬† ¬† ¬† ¬† ¬† ¬† });

¬† ¬† ¬† ¬† }
     
    </script>
</body>
</html>
